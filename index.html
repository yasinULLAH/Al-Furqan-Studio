<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nur Al-Quran Studio Offline - By Yasin Ullah</title>
    <meta name="author" content="Yasin Ullah, Pakistani">
    <meta name="description" content="An offline-first, client-side Quranic study environment with personal Tafsir, thematic linking, root analysis, Hifz tracking, and advanced search.">

    <style>
        /* General Styles & Reset */
        :root {
            /* Default Theme: Serene Digital Mosque */
            --color-bg-primary: #e8f5e9; /* Light Green */
            --color-bg-secondary: #c8e6c9; /* Lighter Green */
            --color-text-primary: #1b5e20; /* Dark Green */
            --color-text-secondary: #388e3c; /* Medium Green */
            --color-accent: #4caf50; /* Green */
            --color-accent-dark: #388e3c; /* Darker Green */
            --color-border: #a5d6a7; /* Light Green Border */
            --color-shadow: rgba(0, 0, 0, 0.1);
            --color-highlight: #fff9c4; /* Light Yellow */
            --color-error: #ef5350; /* Red */
            --color-success: #66bb6a; /* Green */
            --font-arabic: 'Scheherazade New', 'Lateef', 'Amiri', 'Traditional Arabic', calibri; /* Preferred Arabic fonts */
            --font-urdu: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', 'Pak Nastaleeq', calibri; /* Preferred Urdu fonts */
            --font-Bangali: 'Noto Sans Bangali', 'Arial', calibri; /* Bangali fonts */
            --font-english: 'Roboto', 'Segoe UI', calibri; /* English font */
            --font-general: 'Roboto', 'Segoe UI', calibri; /* General UI font */
            --border-radius: 8px;
            --padding-main: 20px;
            --transition-speed: 0.3s;
        }

        /* Ancient Illuminated Manuscript Theme */
        body.theme-manuscript {
            --color-bg-primary: #f5f5dc; /* Beige/Parchment */
            --color-bg-secondary: #fff8dc; /* Cornsilk */
            --color-text-primary: #5d4037; /* Dark Brown */
            --color-text-secondary: #795548; /* Brown */
            --color-accent: #ffb300; /* Amber */
            --color-accent-dark: #fb8c00; /* Dark Amber */
            --color-border: #d7ccc8; /* Light Brown */
            --color-shadow: rgba(0, 0, 0, 0.15);
            --color-highlight: #ffe082; /* Light Amber */
            --color-error: #c62828; /* Dark Red */
            --color-success: #388e3c; /* Dark Green */
            --font-arabic: 'Scheherazade New', calibri;
            --font-urdu: 'Jameel Noori Nastaleeq', calibri;
            --font-Bangali: 'Noto Sans Bangali', calibri;
            --font-english: 'Merriweather', calibri;
            --font-general: 'Merriweather', calibri;
        }

        /* Futuristic Holo-Quran Theme */
        body.theme-holo {
            --color-bg-primary: #0d1a2b; /* Dark Blue */
            --color-bg-secondary: #1a2b3c; /* Slightly Lighter Blue */
            --color-text-primary: #e0f7fa; /* Cyan */
            --color-text-secondary: #b2ebf2; /* Lighter Cyan */
            --color-accent: #00bcd4; /* Cyan */
            --color-accent-dark: #00838f; /* Dark Cyan */
            --color-border: #26a69a; /* Teal */
            --color-shadow: rgba(0, 188, 212, 0.2); /* Cyan shadow */
            --color-highlight: #80deea; /* Light Cyan */
            --color-error: #ff5252; /* Red */
            --color-success: #00e676; /* Green */
            --font-arabic: 'Orbitron', calibri; /* Futuristic Arabic (placeholder, needs actual font) */
            --font-urdu: 'Orbitron', calibri; /* Placeholder */
            --font-Bangali: 'Orbitron', calibri;
            --font-english: 'Orbitron', calibri;
            --font-general: 'Orbitron', calibri;
            --border-radius: 4px;
        }


        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-general);
            line-height: 1.6;
            color: var(--color-text-primary);
            background-color: var(--color-bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: scroll; /* Allow scrolling on body */
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--color-text-secondary);
            margin-bottom: 15px;
        }

        button, input[type="submit"], input[type="button"] {
            font-family: var(--font-general);
            background-color: var(--color-accent);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color var(--transition-speed), opacity var(--transition-speed);
            font-size: 1rem;
        }

        button:hover, input[type="submit"]:hover, input[type="button"]:hover {
            background-color: var(--color-accent-dark);
            opacity: 0.9;
        }
         button:focus, input[type="submit"]:focus, input[type="button"]:focus {
            outline: 2px solid var(--color-accent-dark);
            outline-offset: 2px;
        }

        input[type="text"], input[type="number"], textarea, select {
            font-family: var(--font-general);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
            width: 100%;
            max-width: 400px; /* Limit width for forms */
        }
         input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: 2px solid var(--color-accent);
            border-color: var(--color-accent);
         }

        textarea {
            min-height: 150px;
            resize: vertical;
            max-width: 100%;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--color-text-secondary);
        }

        a {
            color: var(--color-accent-dark);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Layout */
        .container {
            display: flex;
            flex-grow: 1; /* Allow container to take up available space */
            padding: var(--padding-main);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .sidebar {
            width: 250px;
            margin-right: var(--padding-main);
            flex-shrink: 0;
            background-color: var(--color-bg-secondary);
            padding: var(--padding-main);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px var(--color-shadow);
        }

        .main-content {
            flex-grow: 1;
            background-color: var(--color-bg-secondary);
            padding: var(--padding-main);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px var(--color-shadow);
            overflow-y: auto; /* Allow main content area to scroll */
            /* max-height: calc(100vh - (var(--padding-main) * 2) - 60px); */ /* Adjust based on header height */
        }

        header {
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
            padding: 15px var(--padding-main);
            box-shadow: 0 2px 5px var(--color-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--color-text-primary);
        }

        nav ul {
            list-style: none;
            padding: 0;
        }

        nav ul li {
            margin-bottom: 10px;
        }

        nav a {
            display: block;
            padding: 10px;
            background-color: var(--color-bg-primary);
            border-radius: var(--border-radius);
            color: var(--color-text-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        nav a:hover, nav a.active {
            background-color: var(--color-accent);
            color: white;
            text-decoration: none;
        }

        /* Specific Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Quran Section */
        .quran-viewer h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .ayah {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-primary);
            transition: background-color var(--transition-speed);
        }

        .ayah:hover {
             background-color: var(--color-highlight);
        }

        .ayah-number {
            font-weight: bold;
            color: var(--color-accent-dark);
            margin-bottom: 10px;
            display: block;
            text-align: center;
        }

        .ayah-arabic {
            font-family: var(--font-arabic);
            font-size: 1.8rem;
            text-align: right;
            direction: rtl;
            margin-bottom: 10px;
            line-height: 2.5; /* Increased line height for clarity */
        }

        .ayah-arabic span {
            cursor: pointer;
            padding: 2px 4px;
            border-bottom: 1px dashed transparent;
            transition: background-color 0.2s, border-bottom-color 0.2s;
        }

        .ayah-arabic span:hover {
            background-color: rgba(var(--color-accent-dark-rgb, 56, 142, 60), 0.2); /* Use RGBA for hover */
            border-bottom-color: var(--color-accent-dark);
        }
        /* Add RGB variables for themes */
        :root { --color-accent-dark-rgb: 56, 142, 60; } /* Serene */
        body.theme-manuscript { --color-accent-dark-rgb: 251, 140, 0; } /* Manuscript */
        body.theme-holo { --color-accent-dark-rgb: 0, 131, 143; } /* Holo */


        .ayah-translation {
            /* These will be set dynamically by JS based on selected translation */
            font-size: 1.1rem;
            color: var(--color-text-secondary);
        }

        .word-translation-tooltip {
            position: absolute;
            background-color: var(--color-accent-dark);
            color: white;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            z-index: 100;
            pointer-events: none; /* Don't interfere with clicks */
            opacity: 0;
            transition: opacity 0.2s;
        }

        .word-translation-tooltip.visible {
            opacity: 1;
        }

        /* Tafsir Builder */
        .tafsir-editor {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--color-border);
        }

        .tafsir-editor textarea {
            width: 100%;
            max-width: 100%;
            margin-bottom: 10px;
        }

        /* Thematic Linker */
        .theme-manager, .theme-linker {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-primary);
        }

        .theme-list ul {
            list-style: none;
            padding-left: 20px;
        }
        .theme-list li {
            margin-bottom: 5px;
        }
        .theme-list li span {
             cursor: pointer;
             color: var(--color-text-secondary);
             transition: color var(--transition-speed);
        }
        .theme-list li span:hover {
             color: var(--color-accent-dark);
             text-decoration: underline;
        }
        .theme-list .theme-actions button {
            padding: 3px 8px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        /* Root Word Analyzer */
        .root-analyzer-form {
            margin-bottom: 20px;
        }
        .root-results ul {
            list-style: none;
            padding: 0;
        }
        .root-results li {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-primary);
            font-size: 1.5rem;
        }

        /* Recitation Log */
        .recitation-log-form {
             margin-bottom: 20px;
        }
        .recitation-list ul {
            list-style: none;
            padding: 0;
        }
        .recitation-list li {
             margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-primary);
        }

        /* Memorization Hub */
        .hifz-ayah-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            margin-left: 10px;
        }
        .status-not-started { background-color: #e0e0e0; color: #424242; }
        .status-in-progress { background-color: #fff59d; color: #fbc02d; }
        .status-memorized { background-color: #a5d6a7; color: #388e3c; }

        /* Advanced Search */
        .search-options label {
            display: inline-block;
            margin-right: 15px;
            font-weight: normal;
        }
        .search-results ul {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }
        .search-results li {
             margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-primary);
            font-size: x-large;
        }
        .search-results .result-context {
            font-size: large;
            color: var(--color-text-secondary);
            margin-top: 5px;
        }

        /* Data Management / Settings */
        .settings-section {
            margin-bottom: 20px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--color-bg-secondary);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px var(--color-shadow);
            max-width: 600px;
            width: 90%;
            position: relative;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--color-text-secondary);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Loading Indicator */
        #loading-overlay {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 1.5rem;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none; /* Hidden by default */
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .flex-group { display: flex; gap: 10px; align-items: center; } /* For buttons/inputs side-by-side */


        /* Accessibility (WCAG 2.1 AAA considerations) */
        [tabindex="0"]:focus, button:focus, input:focus, select:focus, textarea:focus, a:focus {
            outline: 3px solid var(--color-accent-dark); /* Stronger focus indicator */
            outline-offset: 2px;
        }

        /* Ensure sufficient contrast - relies on theme colors being chosen correctly */

        /* Screen reader only class */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* RTL adjustments */
        [dir="rtl"] .ayah-arabic, [dir="rtl"] .ayah-translation {
            text-align: right;
        }
         [dir="rtl"] .sidebar {
            margin-right: 0;
            margin-left: var(--padding-main);
         }
         [dir="rtl"] .theme-list ul {
            padding-left: 0;
            padding-right: 20px;
         }
         [dir="rtl"] .theme-list .theme-actions button {
            margin-left: 0;
            margin-right: 5px;
         }
        [dir="rtl"] .hifz-ayah-status {
            margin-left: 0;
            margin-right: 10px;
        }
         [dir="rtl"] .search-options label {
            margin-right: 0;
            margin-left: 15px;
         }


        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 10px;
            }
            .sidebar {
                width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
            }
             [dir="rtl"] .sidebar {
                margin-left: 0;
                margin-bottom: 20px;
             }
            .main-content {
                padding: 15px;
                 max-height: calc(100vh - (10px * 2) - 60px - 20px - 20px); /* Adjust for mobile padding, header, sidebar margin */
            }
            header {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }
            header h1 {
                margin-bottom: 10px;
            }
            nav ul {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }
            nav ul li {
                margin-bottom: 0;
            }
            nav a {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
             input[type="text"], input[type="number"], textarea, select {
                max-width: 100%;
            }
             .flex-group {
                flex-direction: column;
                gap: 10px;
             }
             .flex-group button, .flex-group input {
                width: 100%;
             }
        }

        /* Chronospatial/Bioluminescent Simulation (Basic) */
        body.theme-holo .ayah:hover {
             background: linear-gradient(90deg, rgba(0,188,212,0.1) 0%, rgba(0,188,212,0.05) 100%);
        }
        body.theme-holo .ayah-arabic span:hover {
             background-color: rgba(0, 188, 212, 0.3);
             border-bottom-color: var(--color-highlight);
        }
        body.theme-holo .word-translation-tooltip {
             background-color: var(--color-accent);
             box-shadow: 0 0 10px var(--color-accent);
        }
         body.theme-holo nav a.active {
            background-color: var(--color-accent);
            box-shadow: 0 0 8px var(--color-accent);
         }
#word-translation-area > p:nth-child(3){
    display: none;
}

    </style>
    <!-- Optional: Include fonts if not available locally -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@404&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Jameel+Noori+Nastaleeq+Regular&display=swap">
    <!-- Add other fonts like Noto Nastaliq Urdu, Noto Sans Bangali, Orbitron, Merriweather if needed -->
     <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap">
     <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bangali&display=swap">
     <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap">
     <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap">


</head>
<body dir="ltr"> <!-- Default direction, will be set dynamically if needed -->

    <div id="loading-overlay">Loading Quran data... Please wait.</div>

    <header>
        <h1>Nur Al-Quran Studio Offline</h1>
        <div class="header-controls">
             <label for="theme-switcher" class="sr-only">Choose Theme</label>
            <select id="theme-switcher" aria-label="Choose Theme">
                <option value="serene">Serene Digital Mosque</option>
                <option value="manuscript">Ancient Illuminated Manuscript</option>
                <option value="holo">Futuristic Holo-Quran</option>
            </select>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="#quran" class="nav-link active" data-section="quran">Quran Viewer</a></li>
                    <li><a href="#tafsir" class="nav-link" data-section="tafsir">Personal Tafsir</a></li>
                    <li><a href="#themes" class="nav-link" data-section="themes">Thematic Linker</a></li>
                    <li><a href="#roots" class="nav-link" data-section="roots">Root Word Analyzer</a></li>
                    <li><a href="#recitation" class="nav-link" data-section="recitation">Recitation Log</a></li>
                    <li><a href="#hifz" class="nav-link" data-section="hifz">Memorization Hub</a></li>
                    <li><a href="#search" class="nav-link" data-section="search">Advanced Search</a></li>
                    <li><a href="#data" class="nav-link" data-section="data">Data Management</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <section id="quran" class="section active" role="region" aria-labelledby="quran-heading">
                <h2 id="quran-heading">Quran Viewer</h2>
                <div class="quran-controls flex-group mb-20">
                    <label for="surah-select" class="sr-only">Select Surah</label>
                    <select id="surah-select" aria-label="Select Surah"></select>
                    <label for="ayah-select" class="sr-only">Select Ayah</label>
                    <select id="ayah-select" aria-label="Select Ayah"></select>
                </div>
                 <div class="quran-controls flex-group mb-20">
                     <label for="translation-select" class="sr-only">Select Translation</label>
                     <select id="translation-select" aria-label="Select Translation">
                         <option value="urdu">Urdu (Included)</option>
                         <option value="english">English (Included)</option>
                         <option value="Bangali">Bangali (Included)</option>
                     </select>
                 </div>

                <div id="quran-display" class="quran-viewer" lang="ar" dir="rtl">
                    <!-- Quran Ayahs will be loaded here -->
                    <p class="text-center">Select a Surah and Ayah to start.</p>
                </div>
                 <div id="word-translation-area" class="mt-20">
                     <!-- Word translation or full ayah translation on word click -->
                 </div>
            </section>

            <section id="tafsir" class="section" role="region" aria-labelledby="tafsir-heading">
                <h2 id="tafsir-heading">Personal Tafsir Builder</h2>
                <p>Write your notes and reflections for the current Ayah.</p>
                 <div id="current-ayah-tafsir" class="ayah mb-20">
                     <!-- Current Ayah will be displayed here -->
                     <p class="text-center">Navigate to an Ayah in the Quran Viewer to add Tafsir.</p>
                 </div>
                <div class="tafsir-editor">
                    <label for="tafsir-notes">Your Tafsir Notes:</label>
                    <textarea id="tafsir-notes" placeholder="Enter your personal notes, interpretations, and reflections here..."></textarea>
                    <button id="save-tafsir-btn">Save Tafsir</button>
                     <p id="tafsir-status" aria-live="polite"></p>
                </div>
            </section>

            <section id="themes" class="section" role="region" aria-labelledby="themes-heading">
                <h2 id="themes-heading">Thematic Linker Pro</h2>
                <p>Create and manage themes, and link Ayahs to them.</p>

                <div class="theme-manager mb-20">
                    <h3>Manage Themes</h3>
                    <div class="flex-group mb-10">
                        <label for="new-theme-name" class="sr-only">New Theme Name</label>
                        <input type="text" id="new-theme-name" placeholder="New Theme Name">
                        <label for="parent-theme-select" class="sr-only">Parent Theme (Optional)</label>
                        <select id="parent-theme-select" aria-label="Parent Theme (Optional)">
                            <option value="">-- No Parent --</option>
                            <!-- Options populated by JS -->
                        </select>
                        <button id="add-theme-btn">Add Theme</button>
                    </div>
                    <div class="theme-list">
                        <h4>Existing Themes</h4>
                        <ul id="themes-list">
                            <!-- Themes populated by JS -->
                            <li>No themes added yet.</li>
                        </ul>
                    </div>
                     <p id="theme-manager-status" aria-live="polite"></p>
                </div>

                <div class="theme-linker">
                    <h3>Link Current Ayah (<span id="current-ayah-theme-ref">N/A</span>)</h3>
                    <div id="current-ayah-theme-text" class="ayah mb-20">
                        <!-- Current Ayah text will be displayed here -->
                         <p class="text-center">Navigate to an Ayah in the Quran Viewer to link themes.</p>
                    </div>
                    <label for="link-theme-select">Select Theme to Link:</label>
                    <select id="link-theme-select" aria-label="Select Theme to Link">
                         <option value="">-- Select Theme --</option>
                        <!-- Options populated by JS -->
                    </select>
                    <label for="theme-link-notes">Notes for this link (Optional):</label>
                    <textarea id="theme-link-notes" placeholder="Notes on why this Ayah relates to this theme..."></textarea>
                    <button id="link-ayah-to-theme-btn">Link Ayah</button>
                     <p id="theme-linker-status" aria-live="polite"></p>

                    <h4 class="mt-20">Ayahs Linked to Selected Theme: <span id="linked-theme-name">N/A</span></h4>
                    <ul id="linked-ayahs-list">
                        <!-- Linked ayahs populated by JS -->
                        <li>Select a theme above to see linked ayahs.</li>
                    </ul>
                </div>
            </section>

            <section id="roots" class="section" role="region" aria-labelledby="roots-heading">
                <h2 id="roots-heading">Root Word Analyzer & Concordance</h2>
                <p>Input an Arabic root word to find occurrences in the Quran (simplified string search).</p>

                <div class="root-analyzer-form mb-20">
                    <div class="flex-group mb-10">
                        <label for="root-input" class="sr-only">Arabic Root Word</label>
                        <input type="text" id="root-input" placeholder="Enter Arabic Root (e.g., ق-و-ل) or (علم) or (ر۔ب)" lang="ar" dir="rtl">
                        <button id="analyze-root-btn">Analyze Root</button>
                    </div>
                    <label for="root-description">Description/Notes for this Root (Optional):</label>
                    <textarea id="root-description" placeholder="Your notes on this root's meaning..."></textarea>
                    <button id="save-root-notes-btn">Save Root Notes</button>
                     <p id="root-status" aria-live="polite"></p>
                </div>

                <div class="root-results">
                    <h3>Occurrences Found for: <span id="analyzed-root-term">N/A</span></h3>
                    <ul id="root-occurrences-list">
                        <!-- Occurrences populated by JS -->
                        <li>Enter a root word and click "Analyze Root".</li>
                    </ul>
                </div>
            </section>

            <section id="recitation" class="section" role="region" aria-labelledby="recitation-heading">
                <h2 id="recitation-heading">Comparative Recitation Log</h2>
                <p>Log your listening sessions to different Qaris.</p>

                <div class="recitation-log-form mb-20">
                    <h3>Add Log Entry</h3>
                    <div class="flex-group mb-10">
                        <label for="rec-surah-select" class="sr-only">Surah</label>
                        <select id="rec-surah-select" aria-label="Surah"></select>
                        <label for="rec-ayah-start" class="sr-only">Ayah Start (Optional)</label>
                        <input type="number" id="rec-ayah-start" placeholder="Ayah Start (Optional)" min="1">
                        <label for="rec-ayah-end" class="sr-only">Ayah End (Optional)</label>
                        <input type="number" id="rec-ayah-end" placeholder="Ayah End (Optional)" min="1">
                    </div>
                     <div class="flex-group mb-10">
                        <label for="rec-qari" class="sr-only">Qari/Source</label>
                        <input type="text" id="rec-qari" placeholder="Qari or Source (e.g., Mishary Alafasy, Local Masjid Imam)">
                        <label for="rec-date" class="sr-only">Date</label>
                        <input type="date" id="rec-date" aria-label="Date">
                     </div>
                    <label for="rec-notes">Notes (Tajweed, Style, Impact):</label>
                    <textarea id="rec-notes" placeholder="Notes on Tajweed, style, emotional impact..."></textarea>
                    <button id="save-recitation-btn">Save Log Entry</button>
                     <p id="recitation-status" aria-live="polite"></p>
                </div>

                <div class="recitation-list">
                    <h3>Log Entries</h3>
                    <ul id="recitations-list">
                        <!-- Log entries populated by JS -->
                        <li>No entries logged yet.</li>
                    </ul>
                </div>
            </section>

            <section id="hifz" class="section" role="region" aria-labelledby="hifz-heading">
                <h2 id="hifz-heading">Memorization Hub</h2>
                <p>Track your Hifz progress and review schedule.</p>

                <div class="hifz-controls flex-group mb-20">
                     <label for="hifz-surah-select" class="sr-only">Select Surah for Hifz</label>
                    <select id="hifz-surah-select" aria-label="Select Surah for Hifz"></select>
                </div>

                <div id="hifz-ayahs-list">
                    <!-- List of ayahs for the selected surah with status/controls -->
                     <p class="text-center">Select a Surah to track Hifz progress.</p>
                </div>
                 <p id="hifz-status" aria-live="polite"></p>
            </section>

            <section id="search" class="section" role="region" aria-labelledby="search-heading">
                <h2 id="search-heading">Advanced Search</h2>
                <p>Search across Quran text, translations, and your personal data.</p>

                <div class="search-form mb-20">
                    <label for="search-input" class="sr-only">Search Term</label>
                    <input type="text" id="search-input" placeholder="Enter search term">
                    <div class="search-options mb-10" role="group" aria-label="Search Scope">
                        <label><input type="checkbox" class="search-scope" value="quran-arabic" checked> Quran Arabic</label>
                        <label><input type="checkbox" class="search-scope" value="quran-translation" checked> Quran Translation</label>
                        <label><input type="checkbox" class="search-scope" value="tafsir"> Personal Tafsir</label>
                        <label><input type="checkbox" class="search-scope" value="themes"> Theme Notes</label>
                        <label><input type="checkbox" class="search-scope" value="roots"> Root Notes</label>
                        <label><input type="checkbox" class="search-scope" value="recitation"> Recitation Notes</label>
                        <label><input type="checkbox" class="search-scope" value="hifz"> Hifz Notes</label>
                    </div>
                    <button id="perform-search-btn">Search</button>
                     <p id="search-status" aria-live="polite"></p>
                </div>

                <div class="search-results">
                    <h3>Search Results</h3>
                    <ul id="search-results-list">
                        <!-- Search results populated by JS -->
                        <li>Enter a search term and click "Search".</li>
                    </ul>
                </div>
            </section>

            <section id="data" class="section" role="region" aria-labelledby="data-heading">
                <h2 id="data-heading">Data Management</h2>
                <p>Manage your personal data (Tafsir, Themes, Roots, Logs, Hifz).</p>

                <div class="settings-section mb-20">
                    <h3>Backup Data</h3>
                    <p>Export your personal data as a JSON file.</p>
                    <button id="export-data-btn">Export Data</button>
                     <p id="export-status" aria-live="polite"></p>
                </div>

                <div class="settings-section mb-20">
                    <h3>Restore Data</h3>
                    <p>Import your personal data from a JSON file. This will overwrite existing data.</p>
                    <label for="import-file" class="sr-only">Choose JSON file to import</label>
                    <input type="file" id="import-file" accept="application/json">
                    <button id="import-data-btn" disabled>Import Data</button>
                     <p id="import-status" aria-live="polite"></p>
                </div>

                 <div class="settings-section">
                    <h3>Clear All Personal Data</h3>
                    <p class="mb-10" style="color: var(--color-error);">Warning: This will permanently delete ALL your personal Tafsir, Themes, Roots, Logs, and Hifz data.</p>
                     <button id="clear-data-btn" style="background-color: var(--color-error);">Clear All Data</button>
                     <p id="clear-status" aria-live="polite"></p>
                 </div>
            </section>

        </main>
    </div>

    <!-- Modal for Theme Ayahs -->
    <div id="themeAyahsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="themeAyahsModalTitle">
        <div class="modal-content">
            <span class="close-button" aria-label="Close Theme Ayahs Modal">&times;</span>
            <h3 id="themeAyahsModalTitle">Ayahs Linked to Theme: <span id="modal-theme-name"></span></h3>
            <ul id="modal-linked-ayahs-list">
                <!-- Linked ayahs populated here -->
            </ul>
        </div>
    </div>

    <!-- Modal for Root Occurrences -->
     <div id="rootOccurrencesModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="rootOccurrencesModalTitle">
        <div class="modal-content">
            <span class="close-button" aria-label="Close Root Occurrences Modal">&times;</span>
            <h3 id="rootOccurrencesModalTitle">Occurrences for Root: <span id="modal-root-term"></span></h3>
            <ul id="modal-root-occurrences-list">
                <!-- Root occurrences populated here -->
            </ul>
        </div>
    </div>


    <script>
        // Author: Yasin Ullah, Pakistani

        const DB_NAME = 'NurAlQuranStudioDB';
        const DB_VERSION = 2; // Increment this version number for new translation fields
        let db;

        // Object Store Names
        const STORE_QURAN = 'quran';
        const STORE_TAFSIR = 'tafsir';
        const STORE_THEMES = 'themes';
        const STORE_THEME_AYAHS = 'theme_ayahs';
        const STORE_ROOTS = 'roots';
        const STORE_ROOT_AYAHS = 'root_ayahs';
        const STORE_RECITATIONS = 'recitations';
        const STORE_HIFZ = 'hifz';
        const STORE_SETTINGS = 'settings';

        // Global state
        let currentSurah = 1;
        let currentAyah = 1;
        let totalAyahsInSurah = 7; // Default for Surah 1
        let quranDataLoaded = false;
        const surahNames = [
            "Al-Fatihah", "Al-Baqarah", "Al 'Imran", "An-Nisa'", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus",
            "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra'", "Al-Kahf", "Maryam", "Taha",
            "Al-Anbya'", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara'", "An-Naml", "Al-Qasas", "Al-'Ankabut", "Ar-Rum",
            "Luqman", "As-Sajdah", "Al-Ahzab", "Saba'", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir",
            "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf",
            "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadilah", "Al-Hashr", "Al-Mumtahanah",
            "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij",
            "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba'", "An-Nazi'at", "'Abasa",
            "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad",
            "Ash-Shams", "Al-Layl", "Ad-Duha", "Ash-Sharh", "At-Tin", "Al-'Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-'Adiyat",
            "Al-Qari'ah", "At-Takathur", "Al-'Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr",
            "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"
        ];
        // Map Surah number (1-based) to total Ayahs
        const surahAyahCounts = [
            0, 7, 286, 200, 176, 120, 165, 206, 75, 129, 109, 123, 111, 43, 52, 99, 128, 111, 110, 98, 135, 112, 78, 118, 64, 77, 227, 93, 88, 69,
            60, 34, 30, 73, 54, 45, 83, 182, 88, 75, 85, 54, 53, 89, 59, 37, 35, 38, 29, 18, 45, 60, 49, 62, 55, 78, 96, 29, 22, 24,
            13, 14, 11, 11, 18, 12, 12, 30, 52, 52, 44, 28, 28, 20, 56, 40, 31, 50, 40, 46, 42, 29, 19, 36, 25, 22, 17, 19, 26, 30,
            20, 15, 21, 11, 8, 5, 19, 5, 8, 8, 11, 11, 8, 3, 9, 5, 4, 7, 3, 6, 3, 5, 4, 5, 6
        ]; // Index 0 is dummy, Surah 1 is index 1

        // New: Configuration for different translations
        const TRANSLATION_CONFIG = {
            urdu: { file: 'data.AM', lang: 'ur', dir: 'rtl', label: 'Urdu' },
            english: { file: 'dataENG.AM', lang: 'en', dir: 'ltr', label: 'English' },
            Bangali: { file: 'dataBNG.AM', lang: 'bn', dir: 'ltr', label: 'Bangali' }
        };


        // --- IndexedDB Functions ---

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    // Create object stores if they don't exist
                    if (!db.objectStoreNames.contains(STORE_QURAN)) {
                        const quranStore = db.createObjectStore(STORE_QURAN, { keyPath: ['surah', 'ayah'] });
                        // Add indexes for search/lookup if needed later, e.g., by text content (full text search is complex)
                        // quranStore.createIndex('arabic', 'arabic', { unique: false });
                        // quranStore.createIndex('urdu', 'urdu', { unique: false });
                    } else if (event.oldVersion < 2) { // If upgrading from version 1 to 2
                        // Clear existing quran data to repopulate with all translations
                        // This assumes a full re-import of all translations is desired on upgrade.
                        // For larger datasets, a more sophisticated migration (e.g., add new fields without clearing) would be needed.
                        console.log("Upgrading Quran store schema. Clearing existing data for re-population.");
                        db.deleteObjectStore(STORE_QURAN); // Delete and recreate
                        const quranStore = db.createObjectStore(STORE_QURAN, { keyPath: ['surah', 'ayah'] });
                    }


                    if (!db.objectStoreNames.contains(STORE_TAFSIR)) {
                        db.createObjectStore(STORE_TAFSIR, { keyPath: ['surah', 'ayah'] });
                    }
                    if (!db.objectStoreNames.contains(STORE_THEMES)) {
                        db.createObjectStore(STORE_THEMES, { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains(STORE_THEME_AYAHS)) {
                        const themeAyahsStore = db.createObjectStore(STORE_THEME_AYAHS, { keyPath: 'id', autoIncrement: true });
                        themeAyahsStore.createIndex('themeId', 'themeId', { unique: false });
                        themeAyahsStore.createIndex('surahAyah', ['surah', 'ayah'], { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORE_ROOTS)) {
                        db.createObjectStore(STORE_ROOTS, { keyPath: 'id', autoIncrement: true });
                    }
                     if (!db.objectStoreNames.contains(STORE_ROOT_AYAHS)) {
                        const rootAyahsStore = db.createObjectStore(STORE_ROOT_AYAHS, { keyPath: 'id', autoIncrement: true });
                        rootAyahsStore.createIndex('rootId', 'rootId', { unique: false });
                        rootAyahsStore.createIndex('surahAyah', ['surah', 'ayah'], { unique: false });
                        rootAyahsStore.createIndex('word', 'word', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORE_RECITATIONS)) {
                        const recitationStore = db.createObjectStore(STORE_RECITATIONS, { keyPath: 'id', autoIncrement: true });
                        recitationStore.createIndex('surah', 'surah', { unique: false });
                        recitationStore.createIndex('date', 'date', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORE_HIFZ)) {
                        const hifzStore = db.createObjectStore(STORE_HIFZ, { keyPath: ['surah', 'ayah'] });
                        hifzStore.createIndex('status', 'status', { unique: false });
                        hifzStore.createIndex('nextReviewDate', 'nextReviewDate', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORE_SETTINGS)) {
                         db.createObjectStore(STORE_SETTINGS, { keyPath: 'name' });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.errorCode);
                    reject("Failed to open IndexedDB.");
                };
            });
        }

        function getObjectStore(storeName, mode) {
            const transaction = db.transaction(storeName, mode);
            return transaction.objectStore(storeName);
        }

        function addData(storeName, data) {
            return new Promise((resolve, reject) => {
                const store = getObjectStore(storeName, 'readwrite');
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

         function putData(storeName, data) {
            return new Promise((resolve, reject) => {
                const store = getObjectStore(storeName, 'readwrite');
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function getData(storeName, key) {
            return new Promise((resolve, reject) => {
                const store = getObjectStore(storeName, 'readonly');
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function getAllData(storeName) {
            return new Promise((resolve, reject) => {
                const store = getObjectStore(storeName, 'readonly');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function deleteData(storeName, key) {
             return new Promise((resolve, reject) => {
                const store = getObjectStore(storeName, 'readwrite');
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

         function clearStore(storeName) {
             return new Promise((resolve, reject) => {
                const store = getObjectStore(storeName, 'readwrite');
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
         }

        // --- Data Loading and Parsing ---

        async function loadQuranData() {
            showLoading("Loading Quran data...");
            try {
                const settings = await getData(STORE_SETTINGS, 'quranDataLoaded');
                if (settings && settings.value === true) {
                    console.log("Quran data already loaded in IndexedDB.");
                    quranDataLoaded = true;
                    await populateSurahAyahSelects();
                    await loadAyah(currentSurah, currentAyah);
                    hideLoading();
                    return;
                }

                console.log("Fetching all translation files and combining...");
                const allQuranDataMap = new Map(); // Key: "surah-ayah", Value: { surah, ayah, arabic, urdu, english, Bangali }

                // Loop through each translation configuration
                for (const key in TRANSLATION_CONFIG) {
                    const config = TRANSLATION_CONFIG[key];
                    const response = await fetch(config.file);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} for ${config.file}`);
                    }
                    const text = await response.text();
                    console.log(`${config.label} data fetched. Parsing...`);

                    const lines = text.split('\n').filter(line => line.trim() !== '');

                    for (const line of lines) {
                        const parts = line.split(' ترجمہ: ');
                        if (parts.length < 2) {
                            console.warn(`Skipping malformed line in ${config.file}:`, line);
                            continue;
                        }
                        const arabicPart = parts[0].trim();
                        const rest = parts[1];

                        const metaMatch = rest.match(/<br\/>س (\d{3}) آ (\d{3})$/);
                        if (!metaMatch) {
                            console.warn(`Skipping line with missing metadata in ${config.file}:`, line);
                            continue;
                        }

                        const translationPart = rest.substring(0, metaMatch.index).trim();
                        const surahNum = parseInt(metaMatch[1], 10);
                        const ayahNum = parseInt(metaMatch[2], 10);

                        if (isNaN(surahNum) || isNaN(ayahNum) || surahNum < 1 || surahNum > 114 || ayahNum < 1) {
                            console.warn(`Skipping line with invalid surah/ayah number in ${config.file}:`, line);
                            continue;
                        }

                        const mapKey = `${surahNum}-${ayahNum}`;
                        let entry = allQuranDataMap.get(mapKey);

                        // If this is the first time we see this ayah, create the base entry
                        if (!entry) {
                            entry = {
                                surah: surahNum,
                                ayah: ayahNum,
                                arabic: arabicPart, // Arabic should be consistent across files
                                urdu: '',
                                english: '',
                                Bangali: ''
                            };
                            allQuranDataMap.set(mapKey, entry);
                        }

                        // Assign the translation to the correct language field
                        entry[key] = translationPart;
                    }
                }

                console.log(`Parsed ${allQuranDataMap.size} unique ayahs with all translations. Storing in IndexedDB...`);

                const store = getObjectStore(STORE_QURAN, 'readwrite');
                const transaction = store.transaction;

                transaction.oncomplete = async () => {
                    console.log("All Quran data stored successfully.");
                    quranDataLoaded = true;
                    await putData(STORE_SETTINGS, { name: 'quranDataLoaded', value: true });
                    await populateSurahAyahSelects();
                    await loadAyah(currentSurah, currentAyah);
                    hideLoading();
                };

                transaction.onerror = (event) => {
                    console.error("Transaction failed:", event.target.error);
                    hideLoading();
                    alert("Failed to store Quran data: " + event.target.error);
                };

                // Add/update all combined ayah entries
                for (const entry of allQuranDataMap.values()) {
                    store.put(entry); // Use put() to update existing or add new
                }

            } catch (error) {
                console.error("Error loading or parsing Quran data:", error);
                hideLoading();
                alert("Failed to load Quran data: " + error.message);
            }
        }

        // --- UI Rendering and Navigation ---

        function populateSurahAyahSelects() {
            const surahSelect = document.getElementById('surah-select');
            const ayahSelect = document.getElementById('ayah-select');
             const recSurahSelect = document.getElementById('rec-surah-select');
             const hifzSurahSelect = document.getElementById('hifz-surah-select');

            // Populate Surah selects
            if (surahSelect.options.length === 0) { // Prevent re-populating
                for (let i = 1; i <= 114; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}. ${surahNames[i - 1]}`;
                    surahSelect.appendChild(option);
                     recSurahSelect.appendChild(option.cloneNode(true));
                     hifzSurahSelect.appendChild(option.cloneNode(true));
                }
            }

            // Populate Ayah select for the current surah
            surahSelect.value = currentSurah;
             recSurahSelect.value = currentSurah;
             hifzSurahSelect.value = currentSurah;

            updateAyahSelect(currentSurah);
            ayahSelect.value = currentAyah;
        }

        function updateAyahSelect(surahNum) {
            const ayahSelect = document.getElementById('ayah-select');
            ayahSelect.innerHTML = ''; // Clear current options
            totalAyahsInSurah = surahAyahCounts[surahNum];
            for (let i = 1; i <= totalAyahsInSurah; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                ayahSelect.appendChild(option);
            }
             // Ensure currentAyah is valid for the new surah
            if (currentAyah > totalAyahsInSurah) {
                currentAyah = 1;
            }
            ayahSelect.value = currentAyah;
        }

        async function loadAyah(surah, ayah) {
            if (!db) {
                console.error("Database not open.");
                return;
            }
            showLoading(`Loading Ayah ${surah}:${ayah}...`);
            try {
                const quran = await getData(STORE_QURAN, [surah, ayah]);
                const tafsir = await getData(STORE_TAFSIR, [surah, ayah]);

                const displayArea = document.getElementById('quran-display');
                const tafsirAyahDisplay = document.getElementById('current-ayah-tafsir');
                const themeAyahDisplay = document.getElementById('current-ayah-theme-text');
                const tafsirNotes = document.getElementById('tafsir-notes');

                displayArea.innerHTML = '';
                tafsirAyahDisplay.innerHTML = '';
                themeAyahDisplay.innerHTML = '';
                tafsirNotes.value = '';

                if (quran) {
                    currentSurah = surah;
                    currentAyah = ayah;
                    document.getElementById('surah-select').value = surah;
                    document.getElementById('ayah-select').value = ayah;
                     document.getElementById('rec-surah-select').value = surah;
                     document.getElementById('hifz-surah-select').value = surah;
                    updateAyahSelect(surah); // Ensure Ayah select matches

                    const ayahElement = document.createElement('div');
                    ayahElement.classList.add('ayah');
                    ayahElement.setAttribute('data-surah', surah);
                    ayahElement.setAttribute('data-ayah', ayah);

                    const ayahNumber = document.createElement('div');
                    ayahNumber.classList.add('ayah-number');
                    ayahNumber.textContent = `Surah ${surah}:${ayah} (${surahNames[surah-1]})`;
                    ayahElement.appendChild(ayahNumber);

                    const arabicText = document.createElement('div');
                    arabicText.classList.add('ayah-arabic');
                    arabicText.setAttribute('lang', 'ar');
                    arabicText.setAttribute('dir', 'rtl');

                    // Basic word splitting - This is NOT linguistically accurate for Arabic
                    const words = quran.arabic.split(/\s+/);
                    words.forEach(word => {
                        const span = document.createElement('span');
                        span.textContent = word + ' '; // Add space back
                        span.setAttribute('data-word', word);
                        span.setAttribute('tabindex', '0'); // Make words focusable
                        span.setAttribute('role', 'button'); // Indicate they are interactive
                        // Add event listener later
                        arabicText.appendChild(span);
                    });

                    ayahElement.appendChild(arabicText);

                    const translationText = document.createElement('div');
                    translationText.classList.add('ayah-translation');

                    // Determine translation based on selected value
                    const selectedTranslationKey = document.getElementById('translation-select').value;
                    const translationInfo = TRANSLATION_CONFIG[selectedTranslationKey];

                    if (translationInfo) {
                        translationText.setAttribute('lang', translationInfo.lang);
                        translationText.setAttribute('dir', translationInfo.dir);
                        translationText.style.fontFamily = `var(--font-${selectedTranslationKey})`;
                        translationText.style.textAlign = translationInfo.dir === 'rtl' ? 'right' : 'left';
                        translationText.textContent = quran[selectedTranslationKey] || "Translation not available for this language.";
                    } else {
                        // Fallback if selection is invalid (shouldn't happen with proper config)
                        translationText.setAttribute('lang', 'en');
                        translationText.setAttribute('dir', 'ltr');
                        translationText.style.fontFamily = `var(--font-general)`;
                        translationText.style.textAlign = 'left';
                        translationText.textContent = "Translation not found or configuration error.";
                    }

                    ayahElement.appendChild(translationText);

                    displayArea.appendChild(ayahElement);

                    // Update Tafsir section
                    const tafsirAyahElement = ayahElement.cloneNode(true); // Clone the ayah display
                    tafsirAyahElement.querySelector('.ayah-number').textContent = `Tafsir for Surah ${surah}:${ayah}`;
                    tafsirAyahElement.querySelectorAll('.ayah-arabic span').forEach(span => span.outerHTML = span.textContent); // Remove word spans
                    tafsirAyahElement.classList.remove('ayah'); // Remove ayah styling if needed, or keep it
                    tafsirAyahDisplay.innerHTML = '';
                    tafsirAyahDisplay.appendChild(tafsirAyahElement);
                    tafsirNotes.value = tafsir ? tafsir.notes : '';


                    // Update Thematic Linker section
                     const themeAyahElement = ayahElement.cloneNode(true); // Clone the ayah display
                     themeAyahElement.querySelector('.ayah-number').textContent = `Ayah for Linking: Surah ${surah}:${ayah}`;
                     themeAyahElement.querySelectorAll('.ayah-arabic span').forEach(span => span.outerHTML = span.textContent); // Remove word spans
                     themeAyahElement.classList.remove('ayah');
                     themeAyahDisplay.innerHTML = '';
                     themeAyahDisplay.appendChild(themeAyahElement);
                     document.getElementById('current-ayah-theme-ref').textContent = `${surah}:${ayah}`;
                     await populateThemeSelects(); // Repopulate theme selects when ayah changes
                     await displayLinkedAyahsForCurrentTheme(); // Refresh linked ayahs list

                    // Add word click listeners AFTER adding to DOM
                    addWordClickListeners();


                } else {
                    displayArea.innerHTML = `<p class="text-center" style="color: var(--color-error);">Ayah ${surah}:${ayah} not found in data.</p>`;
                     tafsirAyahDisplay.innerHTML = `<p class="text-center">Navigate to a valid Ayah in the Quran Viewer to add Tafsir.</p>`;
                     themeAyahDisplay.innerHTML = `<p class="text-center">Navigate to a valid Ayah in the Quran Viewer to link themes.</p>`;
                     document.getElementById('current-ayah-theme-ref').textContent = 'N/A';
                     tafsirNotes.value = '';
                }
            } catch (error) {
                console.error("Error loading ayah:", error);
                document.getElementById('quran-display').innerHTML = `<p class="text-center" style="color: var(--color-error);">Error loading Ayah: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        function addWordClickListeners() {
            document.querySelectorAll('.ayah-arabic span').forEach(wordSpan => {
                wordSpan.removeEventListener('click', handleWordClick); // Prevent duplicate listeners
                wordSpan.addEventListener('click', handleWordClick);
                 wordSpan.removeEventListener('focus', handleWordFocus); // For accessibility
                 wordSpan.addEventListener('focus', handleWordFocus);
                 wordSpan.removeEventListener('blur', handleWordBlur); // For accessibility
                 wordSpan.addEventListener('blur', handleWordBlur);
            });
        }

        function handleWordClick(event) {
            const word = event.target.getAttribute('data-word');
            const ayahElement = event.target.closest('.ayah');
            const surah = ayahElement.getAttribute('data-surah');
            const ayah = ayahElement.getAttribute('data-ayah');

            // Get the currently displayed translation text
            const translationDiv = ayahElement.querySelector('.ayah-translation');
            const fullTranslation = translationDiv ? translationDiv.textContent : 'Translation not found.';

            // Get the selected translation language details from the UI
            const selectedTranslationKey = document.getElementById('translation-select').value;
            const translationInfo = TRANSLATION_CONFIG[selectedTranslationKey];
            const translationLabel = translationInfo ? translationInfo.label : 'Selected Translation';
            const translationLang = translationInfo ? translationInfo.lang : 'en';
            const translationDir = translationInfo ? translationInfo.dir : 'ltr';
            const translationFont = translationInfo ? `var(--font-${selectedTranslationKey})` : `var(--font-general)`;
            const translationTextAlign = translationInfo.dir === 'rtl' ? 'right' : 'left';


            const translationArea = document.getElementById('word-translation-area');
            translationArea.innerHTML = `
                <p><strong>Selected Word:</strong> <span lang="ar" dir="rtl" style="font-family: var(--font-arabic); font-size: 1.2rem;">${word}</span></p>
                <p><strong>Full Ayah Translation (${surah}:${ayah}) - ${translationLabel}:</strong> <span lang="${translationLang}" dir="${translationDir}" style="font-family: ${translationFont}; text-align: ${translationTextAlign};">${fullTranslation}</span></p>
                <p style="font-size:0.9em; color: var(--color-text-secondary);"><em>Note: Word-by-word translation is not available with the current data format. Displaying full Ayah translation.</em></p>
            `;

             // Basic simulation of bio-luminescent highlight
             document.querySelectorAll('.ayah-arabic span').forEach(span => {
                 span.style.backgroundColor = 'transparent'; // Reset others
             });
             event.target.style.backgroundColor = 'var(--color-highlight)'; // Highlight clicked word
        }

         // Accessibility: Show translation on focus for keyboard users
        function handleWordFocus(event) {
             handleWordClick(event); // Reuse click handler logic
        }

         // Accessibility: Clear translation on blur
         function handleWordBlur(event) {
            const translationArea = document.getElementById('word-translation-area');
            // Optional: Clear the area or just reset highlight
            // translationArea.innerHTML = '';
             event.target.style.backgroundColor = 'transparent'; // Reset highlight
         }


        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                section.setAttribute('aria-hidden', 'true');
            });
            document.getElementById(sectionId).classList.add('active');
             document.getElementById(sectionId).setAttribute('aria-hidden', 'false');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                 link.setAttribute('aria-current', 'false');
            });
            document.querySelector(`.nav-link[data-section="${sectionId}"]`).classList.add('active');
             document.querySelector(`.nav-link[data-section="${sectionId}"]`).setAttribute('aria-current', 'page');

             // Load data specific to the section if needed
             if (sectionId === 'themes') {
                 populateThemeSelects();
                 displayLinkedAyahsForCurrentTheme(); // Refresh linked ayahs list on section switch
             } else if (sectionId === 'roots') {
                 // Maybe load recent root searches or popular ones? For now, just show the section.
             } else if (sectionId === 'recitation') {
                 loadRecitationLogs();
             } else if (sectionId === 'hifz') {
                 // Load Hifz data for the currently selected surah in that section
                 const hifzSurahSelect = document.getElementById('hifz-surah-select');
                 loadHifzForSurah(parseInt(hifzSurahSelect.value, 10));
             }
        }

        function showLoading(message = 'Loading...') {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.textContent = message;
            loadingOverlay.style.display = 'flex';
             document.body.setAttribute('aria-busy', 'true');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
             document.body.setAttribute('aria-busy', 'false');
        }

        function setStatusMessage(elementId, message, isError = false) {
            const statusElement = document.getElementById(elementId);
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.color = isError ? 'var(--color-error)' : 'var(--color-success)';
                 statusElement.style.fontWeight = 'bold';
                // Clear message after a few seconds
                setTimeout(() => {
                    statusElement.textContent = '';
                     statusElement.style.color = '';
                     statusElement.style.fontWeight = '';
                }, 9000);
            }
        }

        // --- Tafsir Functions ---

        async function saveTafsir() {
            if (!db) return;
            const notes = document.getElementById('tafsir-notes').value.trim();
            if (!notes) {
                setStatusMessage('tafsir-status', 'Tafsir notes cannot be empty.', true);
                return;
            }
            if (currentSurah === 0 || currentAyah === 0) {
                 setStatusMessage('tafsir-status', 'Navigate to an Ayah first.', true);
                 return;
            }

            showLoading(`Saving Tafsir for ${currentSurah}:${currentAyah}...`);
            try {
                await putData(STORE_TAFSIR, { surah: currentSurah, ayah: currentAyah, notes: notes });
                setStatusMessage('tafsir-status', `Tafsir saved for ${currentSurah}:${currentAyah}.`, false);
            } catch (error) {
                console.error("Error saving tafsir:", error);
                setStatusMessage('tafsir-status', 'Failed to save Tafsir.', true);
            } finally {
                hideLoading();
            }
        }

        // --- Thematic Linker Functions ---

    async function populateThemeSelects() {
            if (!db) return;
            const themeSelectElements = [
                document.getElementById('parent-theme-select'),
                document.getElementById('link-theme-select')
            ];

            try {
                const themes = await getAllData(STORE_THEMES);

                themeSelectElements.forEach(select => {
                    const preservedValue = select.value; // Preserve selected value before clearing
                    select.innerHTML = ''; // Clear current options

                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    if (select.id === 'parent-theme-select') {
                        defaultOption.textContent = "-- No Parent --";
                    } else { // link-theme-select
                        defaultOption.textContent = "-- Select Theme --";
                    }
                    select.appendChild(defaultOption);

                    // Populate with themes
                    themes.forEach(theme => {
                        const option = document.createElement('option');
                        option.value = theme.id;
                        option.textContent = theme.name;
                        select.appendChild(option);
                    });

                    // Restore previous selection if it's a valid option
                    if (select.querySelector(`option[value="${preservedValue}"]`)) {
                        select.value = preservedValue;
                    } else {
                        select.value = ""; // Fallback to default if preservedValue is no longer valid
                    }
                });

            } catch (error) {
                console.error("Error populating theme selects:", error);
                setStatusMessage('theme-manager-status', 'Failed to load themes.', true);
            }
        }

        async function displayThemesList() {
             if (!db) return;
             const themesListElement = document.getElementById('themes-list');
             themesListElement.innerHTML = '';

             try {
                 const themes = await getAllData(STORE_THEMES);
                 if (themes.length === 0) {
                     themesListElement.innerHTML = '<li>No themes added yet.</li>';
                     return;
                 }

                 // Simple flat list for now. Tree structure is more complex.
                 themes.forEach(theme => {
                     const li = document.createElement('li');
                     li.innerHTML = `
                         <span data-theme-id="${theme.id}" class="view-theme-ayahs">${theme.name}</span>
                         <div class="theme-actions" style="display: inline-block;">
                             <button data-theme-id="${theme.id}" class="delete-theme-btn">Delete</button>
                         </div>
                     `;
                      themesListElement.appendChild(li);
                 });

                 // Add listeners for view/delete buttons
                 themesListElement.querySelectorAll('.view-theme-ayahs').forEach(span => {
                     span.addEventListener('click', handleViewThemeAyahs);
                 });
                 themesListElement.querySelectorAll('.delete-theme-btn').forEach(button => {
                     button.addEventListener('click', handleDeleteTheme);
                 });

             } catch (error) {
                 console.error("Error displaying themes list:", error);
                 themesListElement.innerHTML = `<li>Error loading themes: ${error.message}</li>`;
             }
        }

        async function addTheme() {
            if (!db) return;
            const nameInput = document.getElementById('new-theme-name');
            const parentSelect = document.getElementById('parent-theme-select');
            const name = nameInput.value.trim();
            const parentId = parentSelect.value ? parseInt(parentSelect.value, 10) : null;

            if (!name) {
                setStatusMessage('theme-manager-status', 'Theme name cannot be empty.', true);
                return;
            }

            showLoading("Adding theme...");
            try {
                await addData(STORE_THEMES, { name: name, parentId: parentId, description: '' });
                setStatusMessage('theme-manager-status', `Theme "${name}" added.`, false);
                nameInput.value = '';
                parentSelect.value = '';
                await populateThemeSelects(); // Refresh selects
                await displayThemesList(); // Refresh list
            } catch (error) {
                console.error("Error adding theme:", error);
                 setStatusMessage('theme-manager-status', 'Failed to add theme.', true);
            } finally {
                hideLoading();
            }
        }

         async function handleDeleteTheme(event) {
             if (!db) return;
             const themeId = parseInt(event.target.getAttribute('data-theme-id'), 10);
             if (isNaN(themeId)) return;

             if (!confirm("Are you sure you want to delete this theme and all its linked ayahs?")) {
                 return;
             }

             showLoading("Deleting theme...");
             try {
                 // Delete theme
                 await deleteData(STORE_THEMES, themeId);

                 // Delete linked ayahs for this theme
                 const store = getObjectStore(STORE_THEME_AYAHS, 'readwrite');
                 const index = store.index('themeId');
                 const range = IDBKeyRange.only(themeId);
                 const request = index.openCursor(range);

                 request.onsuccess = (event) => {
                     const cursor = event.target.result;
                     if (cursor) {
                         cursor.delete();
                         cursor.continue();
                     } else {
                         // Cursor finished
                         setStatusMessage('theme-manager-status', 'Theme and linked ayahs deleted.', false);
                         populateThemeSelects(); // Refresh selects
                         displayThemesList(); // Refresh list
                         hideLoading();
                     }
                 };

                 request.onerror = (event) => {
                     console.error("Error deleting linked ayahs:", event.target.error);
                     setStatusMessage('theme-manager-status', 'Theme deleted, but failed to delete all linked ayahs.', true);
                     hideLoading();
                 };

             } catch (error) {
                 console.error("Error deleting theme:", error);
                 setStatusMessage('theme-manager-status', 'Failed to delete theme.', true);
                 hideLoading();
             }
         }

        async function linkAyahToTheme() {
            if (!db) return;
            const themeSelect = document.getElementById('link-theme-select');
            const notesInput = document.getElementById('theme-link-notes');
            const themeId = themeSelect.value ? parseInt(themeSelect.value, 10) : null;
            const notes = notesInput.value.trim();

            if (!themeId) {
                setStatusMessage('theme-linker-status', 'Please select a theme.', true);
                return;
            }
             if (currentSurah === 0 || currentAyah === 0) {
                 setStatusMessage('theme-linker-status', 'Navigate to an Ayah first.', true);
                 return;
            }

            showLoading(`Linking Ayah ${currentSurah}:${currentAyah} to theme...`);
            try {
                 // Check if link already exists (optional, but good practice)
                 const existingLinks = await new Promise((resolve, reject) => {
                     const store = getObjectStore(STORE_THEME_AYAHS, 'readonly');
                     const index = store.index('surahAyah');
                     const range = IDBKeyRange.only([currentSurah, currentAyah]);
                     const request = index.getAll(range);
                     request.onsuccess = () => resolve(request.result);
                     request.onerror = (event) => reject(event.target.error);
                 });

                 const linkExists = existingLinks.some(link => link.themeId === themeId);

                 if (linkExists) {
                     setStatusMessage('theme-linker-status', 'Ayah is already linked to this theme.', true);
                 } else {
                    await addData(STORE_THEME_AYAHS, { themeId: themeId, surah: currentSurah, ayah: currentAyah, notes: notes });
                    setStatusMessage('theme-linker-status', `Ayah ${currentSurah}:${currentAyah} linked successfully.`, false);
                    notesInput.value = ''; // Clear notes after linking
                    await displayLinkedAyahsForCurrentTheme(); // Refresh the list
                 }

            } catch (error) {
                console.error("Error linking ayah to theme:", error);
                 setStatusMessage('theme-linker-status', 'Failed to link Ayah.', true);
            } finally {
                hideLoading();
            }
        }

        async function handleViewThemeAyahs(event) {
             if (!db) return;
             const themeId = parseInt(event.target.getAttribute('data-theme-id'), 10);
             if (isNaN(themeId)) return;

             showLoading("Loading linked ayahs...");
             try {
                 const theme = await getData(STORE_THEMES, themeId);
                 if (!theme) {
                     setStatusMessage('theme-manager-status', 'Theme not found.', true);
                     hideLoading();
                     return;
                 }

                 document.getElementById('modal-theme-name').textContent = theme.name;
                 const linkedAyahsListElement = document.getElementById('modal-linked-ayahs-list');
                 linkedAyahsListElement.innerHTML = '';

                 const store = getObjectStore(STORE_THEME_AYAHS, 'readonly');
                 const index = store.index('themeId');
                 const range = IDBKeyRange.only(themeId);
                 const request = index.openCursor(range);

                 const linkedAyahs = [];
                 request.onsuccess = (event) => {
                     const cursor = event.target.result;
                     if (cursor) {
                         linkedAyahs.push(cursor.value);
                         cursor.continue();
                     } else {
                         // Cursor finished
                         if (linkedAyahs.length === 0) {
                             linkedAyahsListElement.innerHTML = '<li>No ayahs linked to this theme yet.</li>';
                         } else {
                             // Sort by surah, then ayah
                             linkedAyahs.sort((a, b) => {
                                 if (a.surah !== b.surah) return a.surah - b.surah;
                                 return a.ayah - b.ayah;
                             });

                             linkedAyahs.forEach(link => {
                                 const li = document.createElement('li');
                                 li.innerHTML = `
                                     <strong>Surah ${link.surah}:${link.ayah}</strong>
                                     ${link.notes ? ` - <em>${link.notes}</em>` : ''}
                                     <button data-link-id="${link.id}" class="delete-theme-link-btn" style="margin-left: 10px;">Unlink</button>
                                 `;
                                 linkedAyahsListElement.appendChild(li);
                             });

                             // Add listeners for unlink buttons
                             linkedAyahsListElement.querySelectorAll('.delete-theme-link-btn').forEach(button => {
                                 button.addEventListener('click', handleDeleteThemeLink);
                             });
                         }
                         hideLoading();
                         document.getElementById('themeAyahsModal').style.display = 'flex';
                          // Store current theme ID on modal for refresh after unlink
                         document.getElementById('themeAyahsModal').querySelector('.modal-content').setAttribute('data-current-theme-id', themeId);
                     }
                 };

                 request.onerror = (event) => {
                     console.error("Error fetching linked ayahs:", event.target.error);
                     linkedAyahsListElement.innerHTML = `<li>Error loading linked ayahs: ${event.target.error}</li>`;
                     hideLoading();
                 };


             } catch (error) {
                 console.error("Error loading theme details:", error);
                 setStatusMessage('theme-manager-status', 'Failed to load theme details.', true);
                 hideLoading();
             }
        }

         async function handleDeleteThemeLink(event) {
             if (!db) return;
             const linkId = parseInt(event.target.getAttribute('data-link-id'), 10);
             if (isNaN(linkId)) return;

             if (!confirm("Are you sure you want to unlink this Ayah from this theme?")) {
                 return;
             }

             showLoading("Unlinking Ayah...");
             try {
                 await deleteData(STORE_THEME_AYAHS, linkId);
                 setStatusMessage('theme-linker-status', 'Ayah unlinked successfully.', false); // Use linker status area
                 // Refresh the modal list
                 const modalContent = event.target.closest('.modal-content');
                 const currentModalThemeId = parseInt(modalContent.getAttribute('data-current-theme-id'), 10);

                 if (!isNaN(currentModalThemeId)) {
                     // Re-fetch and display the list for the current modal theme
                     await displayLinkedAyahsForThemeInModal(currentModalThemeId);
                 } else {
                      // If theme ID lookup fails, just close the modal and refresh the main theme list
                      document.getElementById('themeAyahsModal').style.display = 'none';
                      displayThemesList();
                 }

             } catch (error) {
                 console.error("Error unlinking ayah:", error);
                 setStatusMessage('theme-linker-status', 'Failed to unlink Ayah.', true);
             } finally {
                 hideLoading();
             }
         }

         // Helper to display linked ayahs within the modal after an unlink
         async function displayLinkedAyahsForThemeInModal(themeId) {
             if (!db) return;
             const linkedAyahsListElement = document.getElementById('modal-linked-ayahs-list');
             linkedAyahsListElement.innerHTML = ''; // Clear current list

             try {
                 const store = getObjectStore(STORE_THEME_AYAHS, 'readonly');
                 const index = store.index('themeId');
                 const range = IDBKeyRange.only(themeId);
                 const request = index.openCursor(range);

                 const linkedAyahs = [];
                 request.onsuccess = (event) => {
                     const cursor = event.target.result;
                     if (cursor) {
                         linkedAyahs.push(cursor.value);
                         cursor.continue();
                     } else {
                         // Cursor finished
                         if (linkedAyahs.length === 0) {
                             linkedAyahsListElement.innerHTML = '<li>No ayahs linked to this theme yet.</li>';
                         } else {
                             linkedAyahs.sort((a, b) => {
                                 if (a.surah !== b.surah) return a.surah - b.surah;
                                 return a.ayah - b.ayah;
                             });
                             linkedAyahs.forEach(link => {
                                 const li = document.createElement('li');
                                 li.innerHTML = `
                                     <strong>Surah ${link.surah}:${link.ayah}</strong>
                                     ${link.notes ? ` - <em>${link.notes}</em>` : ''}
                                     <button data-link-id="${link.id}" class="delete-theme-link-btn" style="margin-left: 10px;">Unlink</button>
                                 `;
                                 linkedAyahsListElement.appendChild(li);
                             });
                             linkedAyahsListElement.querySelectorAll('.delete-theme-link-btn').forEach(button => {
                                 button.addEventListener('click', handleDeleteThemeLink);
                             });
                         }
                     }
                 };

                 request.onerror = (event) => {
                     console.error("Error fetching linked ayahs for modal refresh:", event.target.error);
                     linkedAyahsListElement.innerHTML = `<li>Error loading linked ayahs: ${event.target.error}</li>`;
                 };

             } catch (error) {
                 console.error("Error refreshing modal list:", error);
                 linkedAyahsListElement.innerHTML = `<li>Error refreshing list: ${error.message}</li>`;
             }
         }


         async function displayLinkedAyahsForCurrentTheme() {
             if (!db) return;
             const themeSelect = document.getElementById('link-theme-select');
             const themeId = themeSelect.value ? parseInt(themeSelect.value, 10) : null;
             const linkedAyahsListElement = document.getElementById('linked-ayahs-list');
             const linkedThemeNameElement = document.getElementById('linked-theme-name');

             linkedAyahsListElement.innerHTML = ''; // Clear current list

             if (!themeId) {
                 linkedThemeNameElement.textContent = 'N/A';
                 linkedAyahsListElement.innerHTML = '<li>Select a theme above to see linked ayahs.</li>';
                 return;
             }

             showLoading("Loading linked ayahs for selected theme...");
             try {
                 const theme = await getData(STORE_THEMES, themeId);
                 linkedThemeNameElement.textContent = theme ? theme.name : 'Unknown Theme';

                 const store = getObjectStore(STORE_THEME_AYAHS, 'readonly');
                 const index = store.index('themeId');
                 const range = IDBKeyRange.only(themeId);
                 const request = index.openCursor(range);

                 const linkedAyahs = [];
                 request.onsuccess = (event) => {
                     const cursor = event.target.result;
                     if (cursor) {
                         linkedAyahs.push(cursor.value);
                         cursor.continue();
                     } else {
                         // Cursor finished
                         if (linkedAyahs.length === 0) {
                             linkedAyahsListElement.innerHTML = '<li>No ayahs linked to this theme yet.</li>';
                         } else {
                             linkedAyahs.sort((a, b) => {
                                 if (a.surah !== b.surah) return a.surah - b.surah;
                                 return a.ayah - b.ayah;
                             });
                             linkedAyahs.forEach(link => {
                                 const li = document.createElement('li');
                                 li.innerHTML = `
                                     <strong>Surah ${link.surah}:${link.ayah}</strong>
                                     ${link.notes ? ` - <em>${link.notes}</em>` : ''}
                                 `;
                                 linkedAyahsListElement.appendChild(li);
                             });
                         }
                         hideLoading();
                     }
                 };

                 request.onerror = (event) => {
                     console.error("Error fetching linked ayahs:", event.target.error);
                     linkedAyahsListElement.innerHTML = `<li>Error loading linked ayahs: ${event.target.error}</li>`;
                     hideLoading();
                 };

             } catch (error) {
                 console.error("Error loading theme details for display:", error);
                 linkedThemeNameElement.textContent = 'Error';
                 linkedAyahsListElement.innerHTML = `<li>Error loading theme details: ${error.message}</li>`;
                 hideLoading();
             }
         }


        // --- Root Word Analyzer Functions ---

        
        async function analyzeRoot() {
             if (!db) return;
             const rootInput = document.getElementById('root-input');
             const rootTerm = rootInput.value.trim();
             const analyzedRootTermElement = document.getElementById('analyzed-root-term');
             const occurrencesListElement = document.getElementById('root-occurrences-list');

             analyzedRootTermElement.textContent = rootTerm || 'N/A';
             occurrencesListElement.innerHTML = ''; // Clear previous results

             if (!rootTerm) {
                 setStatusMessage('root-status', 'Please enter an Arabic root word.', true);
                 return;
             }
             if (rootTerm.length < 2) {
                 setStatusMessage('root-status', 'Root term should be at least 2 characters.', true);
                 return;
             }

             showLoading(`Analyzing root "${rootTerm}"...`);
             try {
                 const allAyahs = await getAllData(STORE_QURAN);
                 const foundOccurrences = [];

                 // Perform a simple string search in Arabic text
                 // This is a simplified approach, not a true morphological analysis
                 const searchRegex = new RegExp(rootTerm, 'g'); // 'g' for global search

                 allAyahs.forEach(ayahData => {
                     // Split words and check each word individually
                     const words = ayahData.arabic.split(/\s+/);
                     words.forEach(word => {
                         wordan = word.replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"").replace(/ؤ|و/g, "(و|ؤ)").replace(/ك|ک/g, "(ك|ک)").replace(/آ|ا|أ|إ/g, "(آ|ا|أ|إ)").replace(/ى|ی|ي/g, "(ى|ی|ي)").replace(/ہ|ھ|ة|ۃ|ه/g, "(ہ|ھ|ة|ۃ|ه)").replace(/ے/g, "(ے|ی)").replace(/م/g, "(مٰ|م)");
                        wordan2 = word.replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"")

                         

                         rootTerma1 = rootTerm.replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"").replace(/ؤ|و/g, "(و|ؤ)").replace(/ك|ک/g, "(ك|ک)").replace(/آ|ا|أ|إ/g, "(آ|ا|أ|إ)").replace(/ى|ی|ي/g, "(ى|ی|ي)").replace(/ہ|ھ|ة|ۃ|ه/g, "(ہ|ھ|ة|ۃ|ه)").replace(/ے/g, "(ے|ی)").replace(/م/g, "(مٰ|م)").replaceAll(" ",".{0,1}").replaceAll("-",".{0,1}").replaceAll("-",".{0,1}");
                         
                         rootTerma = rootTerm.replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"").replace(/ؤ|و/g, "(و|ؤ)").replace(/ك|ک/g, "(ك|ک)").replace(/آ|ا|أ|إ/g, "(آ|ا|أ|إ)").replace(/ى|ی|ي/g, "(ى|ی|ي)").replace(/ہ|ھ|ة|ۃ|ه/g, "(ہ|ھ|ة|ۃ|ه)").replace(/ے/g, "(ے|ی)").replace(/م/g, "(مٰ|م)").replaceAll(" ","").replaceAll("-","").replaceAll("-","");
                        
                         //console.log(wordan.match(/rootTerma/)!=undefined);
                         rootTerma1 = new RegExp(rootTerma1)
                         //console.log(rootTerma1 +"\n"+ wordan2)
                         if (wordan2.match(rootTerma1)!=undefined || wordan.includes(rootTerma)) {
                             foundOccurrences.push({
                                 surah: ayahData.surah,
                                 ayah: ayahData.ayah,
                                 word: word, // The specific word found
                                 context: ayahData.arabic // Full ayah context
                             });
                         }
                     });
                 });

                 if (foundOccurrences.length === 0) {
                     occurrencesListElement.innerHTML = '<li>No occurrences found.</li>';
                     setStatusMessage('root-status', `No occurrences found for "${rootTerm}".`, false);
                 } else {
                     setStatusMessage('root-status', `Found ${foundOccurrences.length} occurrences for "${rootTerm}".`, false);
                     foundOccurrences.forEach(occ => {
                         const li = document.createElement('li');
                         li.innerHTML = `
                             <strong>Surah ${occ.surah}:${occ.ayah}</strong> - Word: <span lang="ar" dir="rtl" style="font-family: var(--font-arabic);">${occ.word}</span>
                             <div class="result-context" lang="ar" dir="rtl" style="font-family: var(--font-arabic);">${occ.context}</div>
                         `;
                         occurrencesListElement.appendChild(li);
                     });
                 }

             } catch (error) {
                 console.error("Error analyzing root:", error);
                 setStatusMessage('root-status', 'Failed to analyze root.', true);
                 occurrencesListElement.innerHTML = `<li>Error analyzing root: ${error.message}</li>`;
             } finally {
                 hideLoading();
             }
        }

        async function saveRootNotes() {
             if (!db) return;
             const rootInput = document.getElementById('root-input');
             const descriptionInput = document.getElementById('root-description');
             const rootTerm = rootInput.value.trim();
             const description = descriptionInput.value.trim();

             if (!rootTerm) {
                 setStatusMessage('root-status', 'Please enter the root word you want to save notes for.', true);
                 return;
             }

             showLoading("Saving root notes...");
             try {
                 // Check if root already exists, if so, update. Otherwise, add.
                 let existingRoot = null;
                 const allRoots = await getAllData(STORE_ROOTS);
                 existingRoot = allRoots.find(r => r.root === rootTerm);

                 if (existingRoot) {
                     existingRoot.description = description;
                     await putData(STORE_ROOTS, existingRoot);
                     setStatusMessage('root-status', `Notes updated for root "${rootTerm}".`, false);
                 } else {
                     await addData(STORE_ROOTS, { root: rootTerm, description: description, notes: '' }); // 'notes' field might be redundant with description? Adjust schema if needed.
                     setStatusMessage('root-status', `Root "${rootTerm}" and notes saved.`, false);
                 }
             } catch (error) {
                 console.error("Error saving root notes:", error);
                 setStatusMessage('root-status', 'Failed to save root notes.', true);
             } finally {
                 hideLoading();
             }
        }


        // --- Recitation Log Functions ---

        async function loadRecitationLogs() {
             if (!db) return;
             const recitationListElement = document.getElementById('recitations-list');
             recitationListElement.innerHTML = '';

             showLoading("Loading recitation logs...");
             try {
                 const logs = await getAllData(STORE_RECITATIONS);
                 if (logs.length === 0) {
                     recitationListElement.innerHTML = '<li>No entries logged yet.</li>';
                     hideLoading();
                     return;
                 }

                 // Sort logs by date (newest first)
                 logs.sort((a, b) => new Date(b.date) - new Date(a.date));

                 logs.forEach(log => {
                     const li = document.createElement('li');
                     const range = log.ayahStart && log.ayahEnd ? `Ayahs ${log.ayahStart}-${log.ayahEnd}` :
                                   log.ayahStart ? `Ayah ${log.ayahStart}` :
                                   log.ayahEnd ? `Up to Ayah ${log.ayahEnd}` : 'Full Surah';
                     li.innerHTML = `
                         <strong>Surah ${log.surah} (${surahNames[log.surah-1]})</strong> - ${range}
                         <br>
                         Qari: ${log.qari || 'N/A'} | Date: ${log.date || 'N/A'}
                         ${log.notes ? `<br>Notes: <em>${log.notes}</em>` : ''}
                         <div style="margin-top: 5px;">
                             <button data-log-id="${log.id}" class="delete-recitation-btn" style="padding: 3px 8px; font-size: 0.8rem;">Delete</button>
                         </div>
                     `;
                     recitationListElement.appendChild(li);
                 });

                 // Add listeners for delete buttons
                 recitationListElement.querySelectorAll('.delete-recitation-btn').forEach(button => {
                     button.addEventListener('click', handleDeleteRecitationLog);
                 });

             } catch (error) {
                 console.error("Error loading recitation logs:", error);
                 recitationListElement.innerHTML = `<li>Error loading logs: ${error.message}</li>`;
             } finally {
                 hideLoading();
             }
        }

        async function saveRecitationLog() {
            if (!db) return;
            const surahSelect = document.getElementById('rec-surah-select');
            const ayahStartInput = document.getElementById('rec-ayah-start');
            const ayahEndInput = document.getElementById('rec-ayah-end');
            const qariInput = document.getElementById('rec-qari');
            const dateInput = document.getElementById('rec-date');
            const notesInput = document.getElementById('rec-notes');

            const surah = parseInt(surahSelect.value, 10);
            const ayahStart = ayahStartInput.value ? parseInt(ayahStartInput.value, 10) : null;
            const ayahEnd = ayahEndInput.value ? parseInt(ayahEndInput.value, 10) : null;
            const qari = qariInput.value.trim();
            const date = dateInput.value; // YYYY-MM-DD format
            const notes = notesInput.value.trim();

            if (isNaN(surah)) {
                 setStatusMessage('recitation-status', 'Please select a Surah.', true);
                 return;
            }
            if (!date) {
                 setStatusMessage('recitation-status', 'Please select a date.', true);
                 return;
            }
             if (ayahStart !== null && (isNaN(ayahStart) || ayahStart < 1 || ayahStart > surahAyahCounts[surah])) {
                  setStatusMessage('recitation-status', `Invalid Ayah Start for Surah ${surah}.`, true);
                  return;
             }
             if (ayahEnd !== null && (isNaN(ayahEnd) || ayahEnd < 1 || ayahEnd > surahAyahCounts[surah])) {
                  setStatusMessage('recitation-status', `Invalid Ayah End for Surah ${surah}.`, true);
                  return;
             }
             if (ayahStart !== null && ayahEnd !== null && ayahStart > ayahEnd) {
                 setStatusMessage('recitation-status', 'Ayah Start cannot be after Ayah End.', true);
                 return;
             }


            showLoading("Saving recitation log...");
            try {
                await addData(STORE_RECITATIONS, {
                    surah: surah,
                    ayahStart: ayahStart,
                    ayahEnd: ayahEnd,
                    qari: qari,
                    date: date,
                    notes: notes
                });
                setStatusMessage('recitation-status', 'Log entry saved.', false);
                // Clear form
                ayahStartInput.value = '';
                ayahEndInput.value = '';
                qariInput.value = '';
                dateInput.value = '';
                notesInput.value = '';
                loadRecitationLogs(); // Refresh list
            } catch (error) {
                console.error("Error saving recitation log:", error);
                setStatusMessage('recitation-status', 'Failed to save log entry.', true);
            } finally {
                hideLoading();
            }
        }

         async function handleDeleteRecitationLog(event) {
             if (!db) return;
             const logId = parseInt(event.target.getAttribute('data-log-id'), 10);
             if (isNaN(logId)) return;

             if (!confirm("Are you sure you want to delete this log entry?")) {
                 return;
             }

             showLoading("Deleting log entry...");
             try {
                 await deleteData(STORE_RECITATIONS, logId);
                 setStatusMessage('recitation-status', 'Log entry deleted.', false);
                 loadRecitationLogs(); // Refresh list
             } catch (error) {
                 console.error("Error deleting log entry:", error);
                 setStatusMessage('recitation-status', 'Failed to delete log entry.', true);
             } finally {
                 hideLoading();
             }
         }

        // --- Memorization Hub Functions (Simplified SRS) ---

        async function loadHifzForSurah(surah) {
             if (!db) return;
             const hifzAyahsListElement = document.getElementById('hifz-ayahs-list');
             hifzAyahsListElement.innerHTML = '';

             if (isNaN(surah) || surah < 1 || surah > 114) {
                 hifzAyahsListElement.innerHTML = '<p class="text-center">Select a valid Surah.</p>';
                 return;
             }

             showLoading(`Loading Hifz data for Surah ${surah}...`);
             try {
                 const totalAyahs = surahAyahCounts[surah];
                 const ayahs = [];

                 // Fetch all Hifz entries for this surah
                 const hifzEntries = await new Promise((resolve, reject) => {
                     const store = getObjectStore(STORE_HIFZ, 'readonly');
                     const range = IDBKeyRange.bound([surah, 1], [surah, totalAyahs]);
                     const request = store.getAll(range);
                      request.onsuccess = () => resolve(request.result);
                     request.onerror = (event) => reject(event.target.error);
                 });

                 // Map Hifz entries for quick lookup
                 const hifzMap = new Map(hifzEntries.map(entry => [entry.ayah, entry]));

                 // Display each ayah with its status and controls
                 for (let i = 1; i <= totalAyahs; i++) {
                     const ayahData = hifzMap.get(i) || { surah: surah, ayah: i, status: 'not-started', lastReviewDate: null, nextReviewDate: null, reviewCount: 0, notes: '' };

                     const li = document.createElement('div'); // Use div for better layout
                     li.classList.add('ayah'); // Reuse ayah styling
                     li.innerHTML = `
                         <div class="ayah-number">Surah ${surah}:${i}</div>
                         <div class="hifz-ayah-controls">
                             Status: <span class="hifz-ayah-status status-${ayahData.status}" data-surah="${surah}" data-ayah="${i}">${ayahData.status.replace('-', ' ')}</span>
                             ${ayahData.nextReviewDate ? ` | Next Review: ${ayahData.nextReviewDate}` : ''}
                             <br>
                             <button data-surah="${surah}" data-ayah="${i}" data-status="in-progress" class="set-hifz-status-btn">Set In Progress</button>
                             <button data-surah="${surah}" data-ayah="${i}" data-status="memorized" class="set-hifz-status-btn">Set Memorized</button>
                             ${ayahData.status === 'memorized' ? `<button data-surah="${surah}" data-ayah="${i}" class="record-review-btn">Record Review</button>` : ''}
                             <button data-surah="${surah}" data-ayah="${i}" class="view-hifz-notes-btn">Notes</button>
                         </div>
                     `;
                     hifzAyahsListElement.appendChild(li);
                 }

                 // Add listeners for status buttons
                 hifzAyahsListElement.querySelectorAll('.set-hifz-status-btn').forEach(button => {
                     button.addEventListener('click', handleSetHifzStatus);
                 });
                 hifzAyahsListElement.querySelectorAll('.record-review-btn').forEach(button => {
                     button.addEventListener('click', handleRecordReview);
                 });
                  hifzAyahsListElement.querySelectorAll('.view-hifz-notes-btn').forEach(button => {
                     button.addEventListener('click', handleViewHifzNotes);
                 });


             } catch (error) {
                 console.error("Error loading Hifz data:", error);
                 hifzAyahsListElement.innerHTML = `<li>Error loading Hifz data: ${error.message}</li>`;
             } finally {
                 hideLoading();
             }
        }

        async function handleSetHifzStatus(event) {
             if (!db) return;
             const surah = parseInt(event.target.getAttribute('data-surah'), 10);
             const ayah = parseInt(event.target.getAttribute('data-ayah'), 10);
             const status = event.target.getAttribute('data-status');

             showLoading(`Setting status for ${surah}:${ayah}...`);
             try {
                 const existing = await getData(STORE_HIFZ, [surah, ayah]) || { surah: surah, ayah: ayah, status: 'not-started', lastReviewDate: null, nextReviewDate: null, reviewCount: 0, notes: '' };

                 existing.status = status;
                 // Reset review data if status is changed from memorized
                 if (status !== 'memorized') {
                     existing.lastReviewDate = null;
                     existing.nextReviewDate = null;
                     existing.reviewCount = 0;
                 } else {
                     // If setting to memorized, set initial review date/count if not already set
                      if (!existing.lastReviewDate) {
                          existing.lastReviewDate = new Date().toISOString().split('T')[0]; // Today
                          existing.reviewCount = 0; // Reset count for new memorization
                          existing.nextReviewDate = calculateNextReview(existing.lastReviewDate, existing.reviewCount);
                      }
                 }

                 await putData(STORE_HIFZ, existing);
                 setStatusMessage('hifz-status', `Status updated for ${surah}:${ayah}.`, false);
                 loadHifzForSurah(surah); // Refresh list
             } catch (error) {
                 console.error("Error setting Hifz status:", error);
                 setStatusMessage('hifz-status', 'Failed to update status.', true);
             } finally {
                 hideLoading();
             }
        }

        async function handleRecordReview(event) {
             if (!db) return;
             const surah = parseInt(event.target.getAttribute('data-surah'), 10);
             const ayah = parseInt(event.target.getAttribute('data-ayah'), 10);

             showLoading(`Recording review for ${surah}:${ayah}...`);
             try {
                 const existing = await getData(STORE_HIFZ, [surah, ayah]);

                 if (!existing || existing.status !== 'memorized') {
                     setStatusMessage('hifz-status', 'Ayah must be marked as memorized to record a review.', true);
                     hideLoading();
                     return;
                 }

                 existing.lastReviewDate = new Date().toISOString().split('T')[0]; // Today
                 existing.reviewCount = (existing.reviewCount || 0) + 1;
                 existing.nextReviewDate = calculateNextReview(existing.lastReviewDate, existing.reviewCount);

                 await putData(STORE_HIFZ, existing);
                 setStatusMessage('hifz-status', `Review recorded for ${surah}:${ayah}. Next review: ${existing.nextReviewDate}`, false);
                 loadHifzForSurah(surah); // Refresh list
             } catch (error) {
                 console.error("Error recording Hifz review:", error);
                 setStatusMessage('hifz-status', 'Failed to record review.', true);
             } finally {
                 hideLoading();
             }
        }

        // Simplified SRS interval calculation (example)
        function calculateNextReview(lastReviewDate, reviewCount) {
            const date = new Date(lastReviewDate);
            let daysToAdd = 0;
            if (reviewCount === 0) daysToAdd = 1; // Review tomorrow
            else if (reviewCount === 1) daysToAdd = 3; // 3 days later
            else if (reviewCount === 2) daysToAdd = 7; // 7 days later
            else if (reviewCount === 3) daysToAdd = 15; // 15 days later
            else daysToAdd = 30; // 30 days later (can be more complex)

            date.setDate(date.getDate() + daysToAdd);
            return date.toISOString().split('T')[0]; // YYYY-MM-DD format
        }

         async function handleViewHifzNotes(event) {
             if (!db) return;
             const surah = parseInt(event.target.getAttribute('data-surah'), 10);
             const ayah = parseInt(event.target.getAttribute('data-ayah'), 10);

             showLoading(`Loading notes for ${surah}:${ayah}...`);
             try {
                 const existing = await getData(STORE_HIFZ, [surah, ayah]) || { surah: surah, ayah: ayah, status: 'not-started', lastReviewDate: null, nextReviewDate: null, reviewCount: 0, notes: '' };

                 const notes = prompt(`Notes for Surah ${surah}:${ayah}:\n\n${existing.notes}\n\nEdit notes below:`, existing.notes || '');

                 if (notes !== null && notes !== existing.notes) {
                     existing.notes = notes;
                     await putData(STORE_HIFZ, existing);
                     setStatusMessage('hifz-status', `Notes updated for ${surah}:${ayah}.`, false);
                     loadHifzForSurah(surah); // Refresh list
                 } else {
                      setStatusMessage('hifz-status', 'Notes not changed.', false);
                 }

             } catch (error) {
                 console.error("Error viewing/saving Hifz notes:", error);
                 setStatusMessage('hifz-status', 'Failed to load/save notes.', true);
             } finally {
                 hideLoading();
             }
         }


        // --- Advanced Search Functions ---

        async function performSearch() {
             if (!db) return;
             const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();
             const searchScopes = Array.from(document.querySelectorAll('.search-scope:checked')).map(cb => cb.value);
             const searchResultsList = document.getElementById('search-results-list');
             searchResultsList.innerHTML = '';

             if (!searchTerm) {
                 setStatusMessage('search-status', 'Please enter a search term.', true);
                 return;
             }
             if (searchScopes.length === 0) {
                 setStatusMessage('search-status', 'Please select at least one search scope.', true);
                 return;
             }

             showLoading(`Searching for "${searchTerm}"...`);
             try {
                 const results = [];

                 // Search Quran text and translation
                 if (searchScopes.includes('quran-arabic') || searchScopes.includes('quran-translation')) {
                     const allAyahs = await getAllData(STORE_QURAN);
                     allAyahs.forEach(ayah => {
                         const normalizedSearchTerm = searchTerm.replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"").replace(/ؤ|و/g, "(و|ؤ)").replace(/ك|ک/g, "(ك|ک)").replace(/آ|ا|أ|إ/g, "(آ|ا|أ|إ)").replace(/ى|ی|ي/g, "(ى|ی|ي)").replace(/ہ|ھ|ة|ۃ|ه/g, "(ہ|ھ|ة|ۃ|ه)").replace(/ے/g, "(ے|ی)").replace(/م/g, "(مٰ|م)");

                         const matchArabic = searchScopes.includes('quran-arabic') &&
                                             ayah.arabic.toLowerCase().replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"").replace(/ؤ|و/g, "(و|ؤ)").replace(/ك|ک/g, "(ك|ک)").replace(/آ|ا|أ|إ/g, "(آ|ا|أ|إ)").replace(/ى|ی|ي/g, "(ى|ی|ي)").replace(/ہ|ھ|ة|ۃ|ه/g, "(ہ|ھ|ة|ۃ|ه)").replace(/ے/g, "(ے|ی)").replace(/م/g, "(مٰ|م)").includes(normalizedSearchTerm);

                         let matchTranslation = false;
                         let translationSource = '';
                         let allTranslationsContext = [];

                         if (searchScopes.includes('quran-translation')) {
                             for (const langKey in TRANSLATION_CONFIG) {
                                 // Check if the ayah object has this translation field and if it matches
                                 if (ayah[langKey] && ayah[langKey].toLowerCase().replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"").includes(normalizedSearchTerm)) {
                                     matchTranslation = true;
                                     translationSource = TRANSLATION_CONFIG[langKey].label; // Get human-readable label
                                 }
                                 // Add all available translations to context string regardless of match
                                 if (ayah[langKey]) {
                                     allTranslationsContext.push(`${TRANSLATION_CONFIG[langKey].label}: ${ayah[langKey]}`);
                                 }
                             }
                         }

                         if (matchArabic || matchTranslation) {
                             results.push({
                                 type: 'Quran',
                                 ref: `Surah ${ayah.surah}:${ayah.ayah}`,
                                 surah: ayah.surah,
                                 ayah: ayah.ayah,
                                 context: `${ayah.arabic}${allTranslationsContext.length > 0 ? ' - ' + allTranslationsContext.join(' - ') : ''}`,
                                 source: matchArabic && matchTranslation ? `Arabic & Translation (${translationSource})` : matchArabic ? 'Arabic' : `Translation (${translationSource})`
                             });
                         }
                     });
                 }

                 // Search Personal Tafsir
                 if (searchScopes.includes('tafsir')) {
                     const allTafsir = await getAllData(STORE_TAFSIR);
                     allTafsir.forEach(tafsir => {
                         if (tafsir.notes && tafsir.notes.toLowerCase().includes(searchTerm)) {
                             results.push({
                                 type: 'Tafsir',
                                 ref: `Surah ${tafsir.surah}:${tafsir.ayah}`,
                                 surah: tafsir.surah,
                                 ayah: tafsir.ayah,
                                 context: tafsir.notes,
                                 source: 'Personal Tafsir'
                             });
                         }
                     });
                 }

                 // Search Theme Notes (assuming theme description/notes field exists)
                 if (searchScopes.includes('themes')) {
                     const allThemes = await getAllData(STORE_THEMES);
                     allThemes.forEach(theme => {
                         if (theme.description && theme.description.toLowerCase().replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"").includes(searchTerm)) {
                              results.push({
                                 type: 'Theme',
                                 ref: `Theme: ${theme.name}`,
                                 context: theme.description,
                                 source: 'Theme Description'
                             });
                         }
                     });
                     // Also search notes on theme-ayah links
                     const allThemeAyahLinks = await getAllData(STORE_THEME_AYAHS);
                      const themesMap = new Map((await getAllData(STORE_THEMES)).map(t => [t.id, t.name]));
                     allThemeAyahLinks.forEach(link => {
                         if (link.notes && link.notes.toLowerCase().replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"").includes(searchTerm)) {
                              results.push({
                                 type: 'Theme Link',
                                 ref: `Surah ${link.surah}:${link.ayah} (Theme: ${themesMap.get(link.themeId) || 'Unknown'})`,
                                 surah: link.surah,
                                 ayah: link.ayah,
                                 context: link.notes,
                                 source: 'Theme Link Notes'
                             });
                         }
                     });
                 }

                 // Search Root Notes (assuming root description/notes field exists)
                 if (searchScopes.includes('roots')) {
                     const allRoots = await getAllData(STORE_ROOTS);
                     allRoots.forEach(root => {
                         if (root.description && root.description.toLowerCase().replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"").includes(searchTerm)) { // Assuming 'description' is the notes field
                             results.push({
                                 type: 'Root',
                                 ref: `Root: ${root.root}`,
                                 context: root.description,
                                 source: 'Root Notes'
                             });
                         }
                     });
                      // Could also list specific ayah occurrences if needed, but the main root analysis section does this.
                 }

                 // Search Recitation Notes
                 if (searchScopes.includes('recitation')) {
                     const allRecitations = await getAllData(STORE_RECITATIONS);
                     allRecitations.forEach(log => {
                         if (log.notes && log.notes.toLowerCase().replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"").includes(searchTerm)) {
                              const range = log.ayahStart && log.ayahEnd ? `${log.ayahStart}-${log.ayahEnd}` :
                                   log.ayahStart ? `${log.ayahStart}` :
                                   log.ayahEnd ? `Up to ${log.ayahEnd}` : 'Full Surah';
                             results.push({
                                 type: 'Recitation Log',
                                 ref: `Surah ${log.surah} (${range})`,
                                 context: log.notes,
                                 source: 'Recitation Notes'
                             });
                         }
                     });
                 }

                 // Search Hifz Notes
                 if (searchScopes.includes('hifz')) {
                     const allHifz = await getAllData(STORE_HIFZ);
                     allHifz.forEach(hifz => {
                         if (hifz.notes && hifz.notes.toLowerCase().replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"").includes(searchTerm)) {
                             results.push({
                                 type: 'Hifz',
                                 ref: `Surah ${hifz.surah}:${hifz.ayah}`,
                                  surah: hifz.surah,
                                  ayah: hifz.ayah,
                                 context: hifz.notes,
                                 source: 'Hifz Notes'
                             });
                         }
                     });
                 }


                 if (results.length === 0) {
                     searchResultsList.innerHTML = '<li>No results found.</li>';
                     setStatusMessage('search-status', `No results found for "${searchTerm}".`, false);
                 } else {
                     setStatusMessage('search-status', `Found ${results.length} results for "${searchTerm}".`, false);
                      // Sort Quran/Hifz results by Surah/Ayah
                     results.sort((a, b) => {
                         if (a.surah && b.surah && a.surah !== b.surah) return a.surah - b.surah;
                         if (a.ayah && b.ayah) return a.ayah - b.ayah;
                         return 0; // Don't sort other types
                     });

                     results.forEach(result => {
                         const li = document.createElement('li');
                         li.innerHTML = `
                             <strong>${result.type}: ${result.ref}</strong> (${result.source})
                             <div class="result-context">${highlightMatch(result.context, searchTerm)}</div>
                             ${(result.type === 'Quran' || result.type === 'Tafsir' || result.type === 'Hifz') ?
                                `<button data-surah="${result.surah}" data-ayah="${result.ayah}" class="go-to-ayah-btn" style="margin-top: 5px; padding: 3px 8px; font-size: 0.8rem;">Go to Ayah</button>` : ''}
                         `;
                         searchResultsList.appendChild(li);
                     });

                     // Add listeners for "Go to Ayah" buttons
                     searchResultsList.querySelectorAll('.go-to-ayah-btn').forEach(button => {
                         button.addEventListener('click', handleGoToAyahFromSearch);
                     });
                 }

             } catch (error) {
                 console.error("Error during search:", error);
                 setStatusMessage('search-status', 'Failed to perform search.', true);
                 searchResultsList.innerHTML = `<li>Error during search: ${error.message}</li>`;
             } finally {
                 hideLoading();
             }
        }

        function highlightMatch(text, searchTerm) {
            if (!text || !searchTerm) return text;
            // Use a regex with global and case-insensitive flags
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<mark style="background-color: var(--color-highlight);">$1</mark>');
        }

        async function handleGoToAyahFromSearch(event) {
             const surah = parseInt(event.target.getAttribute('data-surah'), 10);
             const ayah = parseInt(event.target.getAttribute('data-ayah'), 10);
             if (!isNaN(surah) && !isNaN(ayah)) {
                 await loadAyah(surah, ayah);
                 showSection('quran'); // Switch to Quran viewer
                 // Scroll to the ayah if needed (requires more complex DOM manipulation)
             }
        }


        // --- Data Export/Import (Backup/Restore) ---

        async function exportData() {
             if (!db) return;
             showLoading("Exporting data...");
             try {
                 const data = {};
                 // Get data from all user-generated stores
                 data[STORE_TAFSIR] = await getAllData(STORE_TAFSIR);
                 data[STORE_THEMES] = await getAllData(STORE_THEMES);
                 data[STORE_THEME_AYAHS] = await getAllData(STORE_THEME_AYAHS);
                 data[STORE_ROOTS] = await getAllData(STORE_ROOTS);
                 data[STORE_ROOT_AYAHS] = await getAllData(STORE_ROOT_AYAHS);
                 data[STORE_RECITATIONS] = await getAllData(STORE_RECITATIONS);
                 data[STORE_HIFZ] = await getAllData(STORE_HIFZ);
                 // Don't export quran data or settings

                 const jsonString = JSON.stringify(data, null, 2);
                 const blob = new Blob([jsonString], { type: 'application/json' });
                 const url = URL.createObjectURL(blob);

                 const a = document.createElement('a');
                 a.href = url;
                 a.download = `nur-al-quran-studio-backup-${new Date().toISOString().split('T')[0]}.json`;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);

                 setStatusMessage('export-status', 'Data exported successfully.', false);

             } catch (error) {
                 console.error("Error exporting data:", error);
                 setStatusMessage('export-status', 'Failed to export data.', true);
             } finally {
                 hideLoading();
             }
        }

        async function importData(file) {
             if (!db) return;

             if (!confirm("Importing data will overwrite your existing personal data. Are you sure you want to continue?")) {
                 return;
             }

             showLoading("Importing data...");
             try {
                 const reader = new FileReader();
                 reader.onload = async (event) => {
                     try {
                         const data = JSON.parse(event.target.result);

                         // Validate data structure (basic check)
                         const userStores = [STORE_TAFSIR, STORE_THEMES, STORE_THEME_AYAHS, STORE_ROOTS, STORE_ROOT_AYAHS, STORE_RECITATIONS, STORE_HIFZ];
                         for (const storeName of userStores) {
                             if (!Array.isArray(data[storeName])) {
                                 throw new Error(`Invalid data format for store: ${storeName}`);
                             }
                         }

                         const transaction = db.transaction(userStores, 'readwrite');

                         transaction.oncomplete = async () => {
                             console.log("Import transaction complete.");
                             setStatusMessage('import-status', 'Data imported successfully.', false);
                             // Refresh relevant UI sections
                             await loadAyah(currentSurah, currentAyah); // Reload current ayah data (tafsir, themes)
                             displayThemesList();
                             loadRecitationLogs();
                             loadHifzForSurah(document.getElementById('hifz-surah-select').value);
                             hideLoading();
                         };

                         transaction.onerror = (event) => {
                             console.error("Import transaction failed:", event.target.error);
                              setStatusMessage('import-status', 'Import failed during transaction.', true);
                             hideLoading();
                         };

                         // Clear existing user data and add new data
                         for (const storeName of userStores) {
                             const store = transaction.objectStore(storeName);
                             store.clear(); // Clear existing data
                             if (data[storeName]) {
                                  // Need to handle auto-increment keys carefully for themes/roots/recitations/theme_ayahs/root_ayahs
                                  // For simplicity, we'll just add them and IndexedDB will assign new keys.
                                  // This means relationships (parent themes, theme links, root links) based on old IDs will be broken.
                                  // A proper import would require mapping old IDs to new IDs.
                                  // For this single-file app, we accept this limitation or require the export/import to preserve IDs (more complex).
                                  // Let's assume for simplicity that auto-increment handles it, but warn the user if relationships break.
                                  if (storeName === STORE_TAFSIR || storeName === STORE_HIFZ) {
                                       // These use composite keys [surah, ayah], safe to just add/put
                                       data[storeName].forEach(item => store.put(item)); // Use put to overwrite if key exists
                                  } else {
                                       // These use auto-increment IDs. Adding will assign *new* IDs.
                                       // Relationships based on old IDs (parentId, themeId, rootId) will be incorrect.
                                       // A robust solution needs ID mapping during import.
                                       // For now, we'll add and warn.
                                        console.warn(`Importing store "${storeName}" with auto-increment keys. Relationships based on old IDs may be broken.`);
                                       data[storeName].forEach(item => {
                                           // Remove old ID so IndexedDB assigns a new one
                                           const newItem = { ...item };
                                           delete newItem.id;
                                           store.add(newItem); // Use add to prevent key conflicts if old IDs were somehow preserved
                                       });
                                  }
                             }
                         }

                     } catch (parseError) {
                         console.error("Error parsing imported data:", parseError);
                         setStatusMessage('import-status', 'Failed to parse imported data. Invalid file format.', true);
                         hideLoading();
                     }
                 };
                 reader.onerror = (event) => {
                      console.error("Error reading file:", event.target.error);
                      setStatusMessage('import-status', 'Failed to read file.', true);
                      hideLoading();
                 };
                 reader.readAsText(file);

             } catch (error) {
                 console.error("Error initiating import:", error);
                 setStatusMessage('import-status', 'Failed to initiate import.', true);
                 hideLoading();
             }
        }

         async function clearAllPersonalData() {
             if (!db) return;

             if (!confirm("Are you absolutely sure you want to delete ALL your personal data (Tafsir, Themes, Roots, Logs, Hifz)? This action cannot be undone.")) {
                 return;
             }

             showLoading("Clearing all personal data...");
             try {
                 const userStores = [STORE_TAFSIR, STORE_THEMES, STORE_THEME_AYAHS, STORE_ROOTS, STORE_ROOT_AYAHS, STORE_RECITATIONS, STORE_HIFZ];
                 const transaction = db.transaction(userStores, 'readwrite');

                 transaction.oncomplete = () => {
                     console.log("All user data cleared.");
                     setStatusMessage('clear-status', 'All personal data cleared.', false);
                     // Reset UI
                     document.getElementById('tafsir-notes').value = '';
                     document.getElementById('themes-list').innerHTML = '<li>No themes added yet.</li>';
                     document.getElementById('root-occurrences-list').innerHTML = '<li>Enter a root word and click "Analyze Root".</li>';
                     document.getElementById('recitations-list').innerHTML = '<li>No entries logged yet.</li>';
                      document.getElementById('hifz-ayahs-list').innerHTML = '<p class="text-center">Select a Surah to track Hifz progress.</p>';
                     populateThemeSelects(); // Clear theme selects
                     hideLoading();
                 };

                 transaction.onerror = (event) => {
                     console.error("Error clearing data transaction:", event.target.error);
                     setStatusMessage('clear-status', 'Failed to clear data during transaction.', true);
                     hideLoading();
                 };

                 userStores.forEach(storeName => {
                     transaction.objectStore(storeName).clear();
                 });

             } catch (error) {
                 console.error("Error initiating data clear:", error);
                 setStatusMessage('clear-status', 'Failed to initiate data clear.', true);
                 hideLoading();
             }
         }

        // --- Settings Functions ---

        function applyTheme(themeName) {
            document.body.className = ''; // Remove existing theme classes
            if (themeName !== 'serene') { // 'serene' is the default, no class needed
                document.body.classList.add(`theme-${themeName}`);
            }
             // Save preference (optional, but good UX)
             if (db) {
                 putData(STORE_SETTINGS, { name: 'theme', value: themeName }).catch(console.error);
             }
        }

        async function loadThemePreference() {
             if (!db) return;
             try {
                 const settings = await getData(STORE_SETTINGS, 'theme');
                 const theme = settings ? settings.value : 'serene'; // Default to serene
                 document.getElementById('theme-switcher').value = theme;
                 applyTheme(theme);
             } catch (error) {
                 console.error("Error loading theme preference:", error);
                 // Fallback to default
                 document.getElementById('theme-switcher').value = 'serene';
                 applyTheme('serene');
             }
        }


        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', async () => {
            // Open DB first
            try {
                await openDB();
                await loadThemePreference(); // Load theme early
                await loadQuranData(); // This also populates selects and loads initial ayah
                displayThemesList(); // Load themes for the manager list
                loadRecitationLogs(); // Load initial recitation logs

                // Add event listeners after DB is open and initial data is loaded
                document.getElementById('surah-select').addEventListener('change', (event) => {
                    currentSurah = parseInt(event.target.value, 10);
                    updateAyahSelect(currentSurah);
                    loadAyah(currentSurah, currentAyah);
                });

                document.getElementById('ayah-select').addEventListener('change', (event) => {
                    currentAyah = parseInt(event.target.value, 10);
                    loadAyah(currentSurah, currentAyah);
                });

                 document.getElementById('translation-select').addEventListener('change', (event) => {
                     // Reload the current ayah to apply the new translation display
                     loadAyah(currentSurah, currentAyah);
                 });


                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (event) => {
                        event.preventDefault();
                        const sectionId = event.target.getAttribute('data-section');
                        showSection(sectionId);
                    });
                });

                document.getElementById('save-tafsir-btn').addEventListener('click', saveTafsir);

                document.getElementById('add-theme-btn').addEventListener('click', addTheme);
                 document.getElementById('link-ayah-to-theme-btn').addEventListener('click', linkAyahToTheme);
                 document.getElementById('link-theme-select').addEventListener('change', displayLinkedAyahsForCurrentTheme); // Update linked ayahs list when theme selected

                document.getElementById('analyze-root-btn').addEventListener('click', analyzeRoot);
                 document.getElementById('save-root-notes-btn').addEventListener(
                    'click', async () => { // Use async directly here
                        // Load existing notes first if root input has a value
                        const rootTerm = document.getElementById('root-input').value.trim();
                        if (rootTerm) {
                             showLoading(`Loading notes for "${rootTerm}"...`);
                             try {
                                 const allRoots = await getAllData(STORE_ROOTS);
                                 const existingRoot = allRoots.find(r => r.root === rootTerm);
                                 if (existingRoot) {
                                     document.getElementById('root-description').value = existingRoot.description || '';
                                     setStatusMessage('root-status', `Loaded notes for "${rootTerm}".`, false);
                                 } else {
                                      document.getElementById('root-description').value = ''; // Clear if root not found
                                      setStatusMessage('root-status', `No existing notes for "${rootTerm}".`, false);
                                 }
                             } catch (error) {
                                 console.error("Error loading root notes:", error);
                                 setStatusMessage('root-status', 'Failed to load root notes.', true);
                             } finally {
                                 hideLoading();
                             }
                        } else {
                            setStatusMessage('root-status', 'Enter a root term to load/save notes.', true);
                        }
                    }
                 );
                 // Listener for saving notes after potentially loading them
                 document.getElementById('save-root-notes-btn').addEventListener('click', saveRootNotes);


                document.getElementById('save-recitation-btn').addEventListener('click', saveRecitationLog);
                 document.getElementById('rec-surah-select').addEventListener('change', (event) => {
                     // Optional: Update min/max for ayah inputs based on surah
                     const surah = parseInt(event.target.value, 10);
                     const totalAyahs = surahAyahCounts[surah];
                     document.getElementById('rec-ayah-start').setAttribute('max', totalAyahs);
                     document.getElementById('rec-ayah-end').setAttribute('max', totalAyahs);
                 });


                 document.getElementById('hifz-surah-select').addEventListener('change', (event) => {
                     loadHifzForSurah(parseInt(event.target.value, 10));
                 });

                document.getElementById('perform-search-btn').addEventListener('click', performSearch);

                document.getElementById('export-data-btn').addEventListener('click', exportData);
                 document.getElementById('import-file').addEventListener('change', (event) => {
                     // Enable import button only when a file is selected
                     const file = event.target.files[0];
                     document.getElementById('import-data-btn').disabled = !file;
                 });
                 document.getElementById('import-data-btn').addEventListener('click', (event) => {
                     const fileInput = document.getElementById('import-file');
                     if (fileInput.files.length > 0) {
                         importData(fileInput.files[0]);
                     } else {
                         setStatusMessage('import-status', 'Please select a file to import.', true);
                     }
                 });
                 document.getElementById('clear-data-btn').addEventListener('click', clearAllPersonalData);

                 document.getElementById('theme-switcher').addEventListener('change', (event) => {
                     applyTheme(event.target.value);
                 });

                 // Modal Close Buttons
                 document.querySelectorAll('.modal .close-button').forEach(button => {
                     button.addEventListener('click', (event) => {
                         event.target.closest('.modal').style.display = 'none';
                     });
                 });
                 // Close modal on outside click
                 window.addEventListener('click', (event) => {
                     document.querySelectorAll('.modal').forEach(modal => {
                         if (event.target === modal) {
                             modal.style.display = 'none';
                         }
                     });
                 });


            } catch (error) {
                console.error("App initialization failed:", error);
                hideLoading();
                alert("Failed to initialize the application: " + error.message + "\nPlease check your browser console for details.");
            }
        });
    </script>
</body>
</html>