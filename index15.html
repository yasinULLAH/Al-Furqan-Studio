<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nur Al-Quran Studio Offline Pro - By Yasin Ullah</title>
    <meta name="author" content="Yasin Ullah, Pakistani">
    <meta name="description" content="An advanced offline-first, client-side Quranic study environment with personal Tafsir, thematic linking, root analysis, Hifz tracking, comparative recitation logs, Ayah bookmarking, custom vocabulary, cross-referencing, Dhikr/Dua builder, Hadith linking, and comprehensive search capabilities.">
    <meta name="keywords" content="Quran, Tafsir, Hifz, Memorization, Islamic Study, Offline Quran, Arabic, Urdu, English, Bangali, Quranic roots, Thematic Quran, Dhikr, Dua, Hadith, Yasin Ullah, Pakistani Developer">

    <style>
        /* General Styles & Reset */
        :root {
            /* Default Theme: Serene Digital Mosque */
            --color-bg-primary: #e8f5e9; /* Light Green */
            --color-bg-secondary: #c8e6c9; /* Lighter Green */
            --color-text-primary: #1b5e20; /* Dark Green */
            --color-text-secondary: #388e3c; /* Medium Green */
            --color-accent: #4caf50; /* Green */
            --color-accent-dark: #388e3c; /* Darker Green */
            --color-border: #a5d6a7; /* Light Green Border */
            --color-shadow: rgba(0, 0, 0, 0.1);
            --color-highlight: #fff9c4; /* Light Yellow */
            --color-error: #ef5350; /* Red */
            --color-success: #66bb6a; /* Green */
            --font-arabic: 'Scheherazade New', 'Lateef', 'Amiri', 'Traditional Arabic', calibri; /* Preferred Arabic fonts */
            --font-urdu: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', 'Pak Nastaleeq', calibri; /* Preferred Urdu fonts */
            --font-Bangali: 'Noto Sans Bangali', 'Arial', calibri; /* Bangali fonts */
            --font-english: 'Roboto', 'Segoe UI', calibri; /* English font */
            --font-general: 'Roboto', 'Segoe UI', calibri; /* General UI font */
            --border-radius: 8px;
            --padding-main: 20px;
            --transition-speed: 0.3s;
            --font-size-arabic: 1.8rem;
            --font-size-translation: 1.1rem;
            --font-size-general: 1rem;
            --color-accent-dark-rgb: 56, 142, 60; /* Used for RGBA */
        }

        /* Ancient Illuminated Manuscript Theme */
        body.theme-manuscript {
            --color-bg-primary: #f5f5dc; /* Beige/Parchment */
            --color-bg-secondary: #fff8dc; /* Cornsilk */
            --color-text-primary: #5d4037; /* Dark Brown */
            --color-text-secondary: #795548; /* Brown */
            --color-accent: #ffb300; /* Amber */
            --color-accent-dark: #fb8c00; /* Dark Amber */
            --color-border: #d7ccc8; /* Light Brown */
            --color-shadow: rgba(0, 0, 0, 0.15);
            --color-highlight: #ffe082; /* Light Amber */
            --color-error: #c62828; /* Dark Red */
            --color-success: #388e3c; /* Dark Green */
            --font-arabic: 'Scheherazade New', calibri;
            --font-urdu: 'Jameel Noori Nastaleeq', calibri;
            --font-Bangali: 'Noto Sans Bangali', calibri;
            --font-english: 'Merriweather', calibri;
            --font-general: 'Merriweather', calibri;
            --color-accent-dark-rgb: 251, 140, 0;
        }

        /* Futuristic Holo-Quran Theme */
        body.theme-holo {
            --color-bg-primary: #0d1a2b; /* Dark Blue */
            --color-bg-secondary: #1a2b3c; /* Slightly Lighter Blue */
            --color-text-primary: #e0f7fa; /* Cyan */
            --color-text-secondary: #b2ebf2; /* Lighter Cyan */
            --color-accent: #00bcd4; /* Cyan */
            --color-accent-dark: #00838f; /* Dark Cyan */
            --color-border: #26a69a; /* Teal */
            --color-shadow: rgba(0, 188, 212, 0.2); /* Cyan shadow */
            --color-highlight: #80deea; /* Light Cyan */
            --color-error: #ff5252; /* Red */
            --color-success: #00e676; /* Green */
            --font-arabic: 'Orbitron', calibri; /* Futuristic Arabic (placeholder, needs actual font) */
            --font-urdu: 'Orbitron', calibri; /* Placeholder */
            --font-Bangali: 'Orbitron', calibri;
            --font-english: 'Orbitron', calibri;
            --font-general: 'Orbitron', calibri;
            --border-radius: 4px;
            --color-accent-dark-rgb: 0, 131, 143;
        }


        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-general);
            line-height: 1.6;
            color: var(--color-text-primary);
            background-color: var(--color-bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: scroll; /* Allow scrolling on body */
            font-size: var(--font-size-general);
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--color-text-secondary);
            margin-bottom: 15px;
        }

        button, input[type="submit"], input[type="button"] {
            font-family: var(--font-general);
            background-color: var(--color-accent);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color var(--transition-speed), opacity var(--transition-speed);
            font-size: 1rem;
        }

        button:hover, input[type="submit"]:hover, input[type="button"]:hover {
            background-color: var(--color-accent-dark);
            opacity: 0.9;
        }
         button:focus, input[type="submit"]:focus, input[type="button"]:focus {
            outline: 2px solid var(--color-accent-dark);
            outline-offset: 2px;
        }

        input[type="text"], input[type="number"], textarea, select, input[type="file"], input[type="date"] {
            font-family: var(--font-general);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
            width: 100%;
            max-width: 400px; /* Limit width for forms */
        }
         input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus, input[type="date"]:focus {
            outline: 2px solid var(--color-accent);
            border-color: var(--color-accent);
         }

        textarea {
            min-height: 150px;
            resize: vertical;
            max-width: 100%;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--color-text-secondary);
        }

        a {
            color: var(--color-accent-dark);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Layout */
        .container {
            display: flex;
            flex-grow: 1; /* Allow container to take up available space */
            padding: var(--padding-main);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .sidebar {
            width: 250px;
            margin-right: var(--padding-main);
            flex-shrink: 0;
            background-color: var(--color-bg-secondary);
            padding: var(--padding-main);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px var(--color-shadow);
        }

        .main-content {
            flex-grow: 1;
            background-color: var(--color-bg-secondary);
            padding: var(--padding-main);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px var(--color-shadow);
            overflow-y: auto; /* Allow main content area to scroll */
        }

        header {
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
            padding: 15px var(--padding-main);
            box-shadow: 0 2px 5px var(--color-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--color-text-primary);
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        nav ul {
            list-style: none;
            padding: 0;
        }

        nav ul li {
            margin-bottom: 10px;
        }

        nav a {
            display: block;
            padding: 10px;
            background-color: var(--color-bg-primary);
            border-radius: var(--border-radius);
            color: var(--color-text-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        nav a:hover, nav a.active {
            background-color: var(--color-accent);
            color: white;
            text-decoration: none;
        }

        /* Specific Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Quran Section */
        .quran-viewer h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .ayah {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-primary);
            transition: background-color var(--transition-speed);
        }

        .ayah:hover {
             background-color: var(--color-highlight);
        }

        .ayah-number {
            font-weight: bold;
            color: var(--color-accent-dark);
            margin-bottom: 10px;
            display: block;
            text-align: center;
        }

        .ayah-arabic {
            font-family: var(--font-arabic);
            font-size: var(--font-size-arabic);
            text-align: right;
            direction: rtl;
            margin-bottom: 10px;
            line-height: 2.5; /* Increased line height for clarity */
        }

        .ayah-arabic span {
            cursor: pointer;
            padding: 2px 4px;
            border-bottom: 1px dashed transparent;
            transition: background-color 0.2s, border-bottom-color 0.2s;
        }

        .ayah-arabic span:hover {
            background-color: rgba(var(--color-accent-dark-rgb), 0.2);
            border-bottom-color: var(--color-accent-dark);
        }

        .ayah-translation {
            font-size: var(--font-size-translation);
            color: var(--color-text-secondary);
        }

        /* Tafsir Builder */
        .tafsir-editor {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--color-border);
        }

        /* Thematic Linker */
        .theme-manager, .theme-linker {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-primary);
        }

        .theme-list ul {
            list-style: none;
            padding-left: 20px;
        }
        .theme-list li {
            margin-bottom: 5px;
        }
        .theme-list li span {
             cursor: pointer;
             color: var(--color-text-secondary);
             transition: color var(--transition-speed);
        }
        .theme-list li span:hover {
             color: var(--color-accent-dark);
             text-decoration: underline;
        }
        .theme-list .theme-actions button {
            padding: 3px 8px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        /* Root Word Analyzer */
        .root-analyzer-form {
            margin-bottom: 20px;
        }
        .root-results ul {
            list-style: none;
            padding: 0;
        }
        .root-results li {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-primary);
            font-size: 1.5rem; /* This was kept for consistency, adjust if needed */
        }

        /* Recitation Log */
        .recitation-log-form {
             margin-bottom: 20px;
        }
        .recitation-list ul {
            list-style: none;
            padding: 0;
        }
        .recitation-list li {
             margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-primary);
        }

        /* Memorization Hub */
        .hifz-ayah-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            margin-left: 10px;
        }
        .status-not-started { background-color: #e0e0e0; color: #424242; }
        .status-in-progress { background-color: #fff59d; color: #fbc02d; }
        .status-memorized { background-color: #a5d6a7; color: #388e3c; }

        /* Advanced Search */
        .search-options label {
            display: inline-block;
            margin-right: 15px;
            font-weight: normal;
        }
        .search-results ul {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }
        .search-results li {
             margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-primary);
        }
        .search-results .result-context {
            font-size: large;
            color: var(--color-text-secondary);
            margin-top: 5px;
        }
        .search-results .result-context mark {
            background-color: var(--color-highlight);
            padding: 0 3px;
            border-radius: 3px;
        }

        /* New Features Styling */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .dashboard-card {
            background-color: var(--color-bg-primary);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px var(--color-shadow);
            text-align: center;
        }
        .dashboard-card h3 {
            margin-top: 0;
            color: var(--color-accent-dark);
            font-size: 1.2rem;
        }
        .dashboard-card p {
            font-size: 2rem;
            font-weight: bold;
            color: var(--color-text-primary);
            margin: 10px 0 0;
        }
        .dashboard-card.hifz-summary {
            text-align: left;
        }
        .dashboard-card.hifz-summary p {
            font-size: 1rem;
            font-weight: normal;
            margin: 5px 0;
        }

        .bookmark-icon {
            cursor: pointer;
            font-size: 1.5em;
            color: #ccc;
            float: right;
            margin-top: -10px;
            margin-right: 5px;
            transition: color 0.2s;
        }
        .bookmark-icon.bookmarked {
            color: gold;
        }
        .bookmark-icon:hover {
            color: orange;
        }
        .bookmark-list ul {
            list-style: none;
            padding: 0;
        }
        .bookmark-list li {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bookmark-list li .bookmark-actions button {
            padding: 5px 10px;
            font-size: 0.9rem;
            margin-left: 5px;
        }

        .vocabulary-list ul, .cross-ref-list ul, .dhikr-dua-list ul, .hadith-list ul {
            list-style: none;
            padding: 0;
        }
        .vocabulary-list li, .cross-ref-list li, .dhikr-dua-list li, .hadith-list li {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg-primary);
        }
        .vocabulary-list li .arabic-word {
            font-family: var(--font-arabic);
            font-size: 1.5rem;
            direction: rtl;
            text-align: right;
        }
        .dhikr-dua-list li .arabic-text {
            font-family: var(--font-arabic);
            font-size: 1.3rem;
            direction: rtl;
            text-align: right;
        }
        .cross-ref-list li .cross-ref-details {
            font-size: 1.1rem;
            color: var(--color-text-secondary);
        }
        .dhikr-dua-counter {
            margin-top: 10px;
        }
        .dhikr-dua-counter button {
            padding: 5px 10px;
            font-size: 0.9rem;
            margin-right: 5px;
        }
        .hadith-list li strong {
            display: block;
            margin-bottom: 5px;
        }

        /* Data Management / Settings */
        .settings-section {
            margin-bottom: 20px;
        }
        #font-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        #font-size-control label {
            width: 100px;
            margin-bottom: 0;
        }
        #font-size-control input[type="range"] {
            flex-grow: 1;
            max-width: 300px;
            margin-bottom: 0;
        }
        #font-size-control span {
            min-width: 30px;
            text-align: center;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--color-bg-secondary);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px var(--color-shadow);
            max-width: 600px;
            width: 90%;
            position: relative;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--color-text-secondary);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Loading Indicator */
        #loading-overlay {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 1.5rem;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none; /* Hidden by default */
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .flex-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap;} /* For buttons/inputs side-by-side */


        /* Accessibility (WCAG 2.1 AAA considerations) */
        [tabindex="0"]:focus, button:focus, input:focus, select:focus, textarea:focus, a:focus {
            outline: 3px solid var(--color-accent-dark); /* Stronger focus indicator */
            outline-offset: 2px;
        }

        /* Screen reader only class */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* RTL adjustments */
        [dir="rtl"] .ayah-arabic, [dir="rtl"] .ayah-translation, [dir="rtl"] .arabic-word, [dir="rtl"] .dhikr-dua-list li .arabic-text {
            text-align: right;
        }
         [dir="rtl"] .sidebar {
            margin-right: 0;
            margin-left: var(--padding-main);
         }
         [dir="rtl"] .theme-list ul {
            padding-left: 0;
            padding-right: 20px;
         }
         [dir="rtl"] .theme-list .theme-actions button {
            margin-left: 0;
            margin-right: 5px;
         }
        [dir="rtl"] .hifz-ayah-status {
            margin-left: 0;
            margin-right: 10px;
        }
         [dir="rtl"] .search-options label {
            margin-right: 0;
            margin-left: 15px;
         }
        [dir="rtl"] .bookmark-icon {
            float: left;
            margin-left: 5px;
            margin-right: 0;
        }


        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 10px;
            }
            .sidebar {
                width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
            }
             [dir="rtl"] .sidebar {
                margin-left: 0;
                margin-bottom: 20px;
             }
            .main-content {
                padding: 15px;
            }
            header {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }
            header h1 {
                margin-bottom: 10px;
            }
            .header-controls {
                width: 100%;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            nav ul {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }
            nav ul li {
                margin-bottom: 0;
            }
            nav a {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
             input[type="text"], input[type="number"], textarea, select, input[type="file"], input[type="date"] {
                max-width: 100%;
            }
             .flex-group {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
             }
             .flex-group button, .flex-group input, .flex-group select {
                width: 100%;
             }
             #font-size-control {
                flex-direction: column;
                align-items: stretch;
             }
             #font-size-control label {
                width: auto;
             }
        }

        /* Chronospatial/Bioluminescent Simulation (Basic) */
        body.theme-holo .ayah:hover {
             background: linear-gradient(90deg, rgba(0,188,212,0.1) 0%, rgba(0,188,212,0.05) 100%);
        }
        body.theme-holo .ayah-arabic span:hover {
             background-color: rgba(0, 188, 212, 0.3);
             border-bottom-color: var(--color-highlight);
        }
         body.theme-holo nav a.active {
            background-color: var(--color-accent);
            box-shadow: 0 0 8px var(--color-accent);
         }
         body.theme-holo .bookmark-icon.bookmarked {
            color: #00bcd4;
            text-shadow: 0 0 5px #00bcd4;
         }
    </style>
    <!-- Optional: Include fonts if not available locally -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Jameel+Noori+Nastaleeq&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bangali&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap">
</head>
<body dir="ltr"> <!-- Default direction, will be set dynamically if needed -->

    <div id="loading-overlay">Loading data... Please wait.</div>

    <header>
        <h1>Nur Al-Quran Studio Offline Pro</h1>
        <div class="header-controls">
             <label for="theme-switcher" class="sr-only">Choose Theme</label>
            <select id="theme-switcher" aria-label="Choose Theme">
                <option value="serene">Serene Digital Mosque</option>
                <option value="manuscript">Ancient Illuminated Manuscript</option>
                <option value="holo">Futuristic Holo-Quran</option>
            </select>
            <button id="random-ayah-btn" aria-label="Go to a random Ayah">Random Ayah</button>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="#dashboard" class="nav-link" data-section="dashboard">Dashboard</a></li>
                    <li><a href="#quran" class="nav-link active" data-section="quran">Quran Viewer</a></li>
                    <li><a href="#tafsir" class="nav-link" data-section="tafsir">Personal Tafsir</a></li>
                    <li><a href="#themes" class="nav-link" data-section="themes">Thematic Linker</a></li>
                    <li><a href="#roots" class="nav-link" data-section="roots">Root Word Analyzer</a></li>
                    <li><a href="#vocabulary" class="nav-link" data-section="vocabulary">Vocabulary Builder</a></li>
                    <li><a href="#cross-refs" class="nav-link" data-section="cross-refs">Cross-Referencing</a></li>
                    <li><a href="#recitation" class="nav-link" data-section="recitation">Recitation Log</a></li>
                    <li><a href="#hifz" class="nav-link" data-section="hifz">Memorization Hub</a></li>
                    <li><a href="#dhikr-dua" class="nav-link" data-section="dhikr-dua">Dhikr & Dua Builder</a></li>
                    <li><a href="#hadith-linker" class="nav-link" data-section="hadith-linker">Hadith Linker</a></li>
                    <li><a href="#bookmarks" class="nav-link" data-section="bookmarks">Bookmarks</a></li>
                    <li><a href="#search" class="nav-link" data-section="search">Advanced Search</a></li>
                    <li><a href="#data" class="nav-link" data-section="data">Data Management</a></li>
                    <li><a href="#settings" class="nav-link" data-section="settings">Settings</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <section id="dashboard" class="section" role="region" aria-labelledby="dashboard-heading">
                <h2 id="dashboard-heading">Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>Total Tafsir Entries</h3>
                        <p id="dashboard-tafsir-count">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Memorized Ayahs</h3>
                        <p id="dashboard-hifz-count">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Total Themes</h3>
                        <p id="dashboard-themes-count">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3>My Vocabulary Words</h3>
                        <p id="dashboard-vocabulary-count">0</p>
                    </div>
                    <div class="dashboard-card hifz-summary">
                        <h3>Next Hifz Review</h3>
                        <p id="dashboard-next-hifz">No upcoming reviews.</p>
                    </div>
                </div>
            </section>

            <section id="quran" class="section active" role="region" aria-labelledby="quran-heading">
                <h2 id="quran-heading">Quran Viewer</h2>
                <div class="quran-controls flex-group mb-20">
                    <label for="surah-select" class="sr-only">Select Surah</label>
                    <select id="surah-select" aria-label="Select Surah"></select>
                    <label for="ayah-select" class="sr-only">Select Ayah</label>
                    <select id="ayah-select" aria-label="Select Ayah"></select>
                    <input type="text" id="quick-navigate-input" placeholder="Jump to S:A (e.g., 2:255)" aria-label="Quick Navigate to Surah and Ayah">
                    <button id="quick-navigate-btn">Go</button>
                </div>
                 <div class="quran-controls flex-group mb-20">
                     <label for="translation-select" class="sr-only">Select Translation</label>
                     <select id="translation-select" aria-label="Select Translation">
                         <option value="urdu">Urdu (Included)</option>
                         <option value="english">English (Included)</option>
                         <option value="Bangali">Bangali (Included)</option>
                     </select>
                 </div>

                <div id="quran-display" class="quran-viewer" lang="ar" dir="rtl">
                    <!-- Quran Ayahs will be loaded here -->
                    <p class="text-center">Select a Surah and Ayah to start.</p>
                </div>
                 <div id="word-translation-area" class="mt-20">
                     <!-- Word translation or full ayah translation on word click -->
                     <p class="text-center">Click on an Arabic word to see its translation.</p>
                 </div>
                 <div id="cross-ref-display" class="mt-20">
                     <h3>Related Ayahs (Cross-References)</h3>
                     <ul id="ayah-cross-refs-list">
                         <li>No cross-references for this Ayah.</li>
                     </ul>
                 </div>
            </section>

            <section id="tafsir" class="section" role="region" aria-labelledby="tafsir-heading">
                <h2 id="tafsir-heading">Personal Tafsir Builder</h2>
                <p>Write your notes and reflections for the current Ayah.</p>
                 <div id="current-ayah-tafsir" class="ayah mb-20">
                     <!-- Current Ayah will be displayed here -->
                     <p class="text-center">Navigate to an Ayah in the Quran Viewer to add Tafsir.</p>
                 </div>
                <div class="tafsir-editor">
                    <label for="tafsir-notes">Your Tafsir Notes:</label>
                    <textarea id="tafsir-notes" placeholder="Enter your personal notes, interpretations, and reflections here..."></textarea>
                    <button id="save-tafsir-btn">Save Tafsir</button>
                     <p id="tafsir-status" aria-live="polite"></p>
                </div>
            </section>

            <section id="themes" class="section" role="region" aria-labelledby="themes-heading">
                <h2 id="themes-heading">Thematic Linker Pro</h2>
                <p>Create and manage themes, and link Ayahs to them.</p>

                <div class="theme-manager mb-20">
                    <h3>Manage Themes</h3>
                    <div class="flex-group mb-10">
                        <label for="new-theme-name" class="sr-only">New Theme Name</label>
                        <input type="text" id="new-theme-name" placeholder="New Theme Name">
                        <label for="parent-theme-select" class="sr-only">Parent Theme (Optional)</label>
                        <select id="parent-theme-select" aria-label="Parent Theme (Optional)">
                            <option value="">-- No Parent --</option>
                            <!-- Options populated by JS -->
                        </select>
                        <button id="add-theme-btn">Add Theme</button>
                    </div>
                    <div class="theme-list">
                        <h4>Existing Themes</h4>
                        <ul id="themes-list">
                            <!-- Themes populated by JS -->
                            <li>No themes added yet.</li>
                        </ul>
                    </div>
                     <p id="theme-manager-status" aria-live="polite"></p>
                </div>

                <div class="theme-linker">
                    <h3>Link Current Ayah (<span id="current-ayah-theme-ref">N/A</span>)</h3>
                    <div id="current-ayah-theme-text" class="ayah mb-20">
                        <!-- Current Ayah text will be displayed here -->
                         <p class="text-center">Navigate to an Ayah in the Quran Viewer to link themes.</p>
                    </div>
                    <label for="link-theme-select">Select Theme to Link:</label>
                    <select id="link-theme-select" aria-label="Select Theme to Link">
                         <option value="">-- Select Theme --</option>
                        <!-- Options populated by JS -->
                    </select>
                    <label for="theme-link-notes">Notes for this link (Optional):</label>
                    <textarea id="theme-link-notes" placeholder="Notes on why this Ayah relates to this theme..."></textarea>
                    <button id="link-ayah-to-theme-btn">Link Ayah</button>
                     <p id="theme-linker-status" aria-live="polite"></p>

                    <h4 class="mt-20">Ayahs Linked to Selected Theme: <span id="linked-theme-name">N/A</span></h4>
                    <ul id="linked-ayahs-list">
                        <!-- Linked ayahs populated by JS -->
                        <li>Select a theme above to see linked ayahs.</li>
                    </ul>
                </div>
            </section>

            <section id="roots" class="section" role="region" aria-labelledby="roots-heading">
                <h2 id="roots-heading">Root Word Analyzer & Concordance</h2>
                <p>Input an Arabic root word to find occurrences in the Quran (simplified string search).</p>

                <div class="root-analyzer-form mb-20">
                    <div class="flex-group mb-10">
                        <label for="root-input" class="sr-only">Arabic Root Word</label>
                        <input type="text" id="root-input" placeholder="Enter Arabic Root (e.g., ق-و-ل) or (ع ل م) or (ر۔ب)" lang="ar" dir="rtl">
                        <button id="analyze-root-btn">Analyze Root</button>
                    </div>
                    <label for="root-description">Description/Notes for this Root (Optional):</label>
                    <textarea id="root-description" placeholder="Your notes on this root's meaning..."></textarea>
                    <button id="save-root-notes-btn">Save Root Notes</button>
                     <p id="root-status" aria-live="polite"></p>
                </div>

                <div class="root-results">
                    <h3>Occurrences Found for: <span id="analyzed-root-term">N/A</span></h3>
                    <ul id="root-occurrences-list">
                        <!-- Occurrences populated by JS -->
                        <li>Enter a root word and click "Analyze Root".</li>
                    </ul>
                </div>
            </section>

            <section id="vocabulary" class="section" role="region" aria-labelledby="vocabulary-heading">
                <h2 id="vocabulary-heading">Vocabulary Builder & Custom Dictionary</h2>
                <p>Add and manage your own custom Arabic words and their meanings.</p>
                <div class="flex-group mb-10">
                    <label for="vocab-arabic-word" class="sr-only">Arabic Word</label>
                    <input type="text" id="vocab-arabic-word" placeholder="Arabic Word" lang="ar" dir="rtl">
                    <label for="vocab-meaning" class="sr-only">Meaning</label>
                    <input type="text" id="vocab-meaning" placeholder="Your Meaning">
                    <label for="vocab-notes" class="sr-only">Notes</label>
                    <textarea id="vocab-notes" placeholder="Additional notes (e.g., usage, context from an Ayah)"></textarea>
                    <label for="vocab-linked-ayah" class="sr-only">Linked Ayah (Optional)</label>
                    <input type="text" id="vocab-linked-ayah" placeholder="Linked Ayah (e.g., 2:255)" aria-label="Linked Ayah (Optional)">
                    <button id="add-vocabulary-btn">Add Word</button>
                </div>
                <p id="vocabulary-status" aria-live="polite"></p>

                <h3 class="mt-20">My Words</h3>
                <input type="text" id="filter-vocabulary-input" placeholder="Filter words..." aria-label="Filter Vocabulary">
                <ul id="vocabulary-list" class="vocabulary-list">
                    <li>No words added yet.</li>
                </ul>
            </section>

            <section id="cross-refs" class="section" role="region" aria-labelledby="cross-refs-heading">
                <h2 id="cross-refs-heading">Cross-Referencing & Related Ayahs</h2>
                <p>Link Ayahs together with your notes on their relationship.</p>
                <div class="flex-group mb-10">
                    <label for="from-ayah-ref" class="sr-only">From Ayah (e.g., 2:3)</label>
                    <input type="text" id="from-ayah-ref" placeholder="From Ayah (e.g., 2:3)" value="" aria-label="From Ayah (e.g., 2:3)">
                    <label for="to-ayah-ref" class="sr-only">To Ayah (e.g., 5:7)</label>
                    <input type="text" id="to-ayah-ref" placeholder="To Ayah (e.g., 5:7)" aria-label="To Ayah (e.g., 5:7)">
                    <label for="cross-ref-notes" class="sr-only">Relationship Notes</label>
                    <textarea id="cross-ref-notes" placeholder="Notes on the relationship between these Ayahs"></textarea>
                    <button id="add-cross-ref-btn">Add Cross-Reference</button>
                </div>
                <p id="cross-ref-status" aria-live="polite"></p>

                <h3 class="mt-20">My Cross-References</h3>
                <ul id="cross-ref-list" class="cross-ref-list">
                    <li>No cross-references added yet.</li>
                </ul>
            </section>

            <section id="recitation" class="section" role="region" aria-labelledby="recitation-heading">
                <h2 id="recitation-heading">Comparative Recitation Log</h2>
                <p>Log your listening sessions to different Qaris.</p>

                <div class="recitation-log-form mb-20">
                    <h3>Add Log Entry</h3>
                    <div class="flex-group mb-10">
                        <label for="rec-surah-select" class="sr-only">Surah</label>
                        <select id="rec-surah-select" aria-label="Surah"></select>
                        <label for="rec-ayah-start" class="sr-only">Ayah Start (Optional)</label>
                        <input type="number" id="rec-ayah-start" placeholder="Ayah Start (Optional)" min="1">
                        <label for="rec-ayah-end" class="sr-only">Ayah End (Optional)</label>
                        <input type="number" id="rec-ayah-end" placeholder="Ayah End (Optional)" min="1">
                    </div>
                     <div class="flex-group mb-10">
                        <label for="rec-qari" class="sr-only">Qari/Source</label>
                        <input type="text" id="rec-qari" placeholder="Qari or Source (e.g., Mishary Alafasy, Local Masjid Imam)">
                        <label for="rec-date" class="sr-only">Date</label>
                        <input type="date" id="rec-date" aria-label="Date">
                     </div>
                    <label for="rec-notes">Notes (Tajweed, Style, Impact):</label>
                    <textarea id="rec-notes" placeholder="Notes on Tajweed, style, emotional impact..."></textarea>
                    <button id="save-recitation-btn">Save Log Entry</button>
                     <p id="recitation-status" aria-live="polite"></p>
                </div>

                <div class="recitation-list">
                    <h3>Log Entries</h3>
                    <ul id="recitations-list">
                        <!-- Log entries populated by JS -->
                        <li>No entries logged yet.</li>
                    </ul>
                </div>
            </section>

            <section id="hifz" class="section" role="region" aria-labelledby="hifz-heading">
                <h2 id="hifz-heading">Memorization Hub</h2>
                <p>Track your Hifz progress and review schedule.</p>

                <div class="hifz-controls flex-group mb-20">
                     <label for="hifz-surah-select" class="sr-only">Select Surah for Hifz</label>
                    <select id="hifz-surah-select" aria-label="Select Surah for Hifz"></select>
                </div>

                <div id="hifz-ayahs-list">
                    <!-- List of ayahs for the selected surah with status/controls -->
                     <p class="text-center">Select a Surah to track Hifz progress.</p>
                </div>
                 <p id="hifz-status" aria-live="polite"></p>
            </section>

            <section id="dhikr-dua" class="section" role="region" aria-labelledby="dhikr-dua-heading">
                <h2 id="dhikr-dua-heading">Dhikr & Dua Builder</h2>
                <p>Add and manage your personal Dhikr and Duas.</p>
                <div class="flex-group mb-10">
                    <label for="dhikr-dua-arabic" class="sr-only">Arabic Text</label>
                    <textarea id="dhikr-dua-arabic" placeholder="Arabic Text" lang="ar" dir="rtl"></textarea>
                    <label for="dhikr-dua-translation" class="sr-only">Translation</label>
                    <textarea id="dhikr-dua-translation" placeholder="Translation"></textarea>
                    <label for="dhikr-dua-notes" class="sr-only">Notes</label>
                    <textarea id="dhikr-dua-notes" placeholder="Notes (e.g., source, meaning, context)"></textarea>
                    <label for="dhikr-dua-category" class="sr-only">Category</label>
                    <input type="text" id="dhikr-dua-category" placeholder="Category (e.g., Morning, Evening, After Prayer)">
                    <button id="add-dhikr-dua-btn">Add Dhikr/Dua</button>
                </div>
                <p id="dhikr-dua-status" aria-live="polite"></p>

                <h3 class="mt-20">My Dhikr & Duas</h3>
                <input type="text" id="filter-dhikr-dua-input" placeholder="Filter Dhikr/Dua..." aria-label="Filter Dhikr and Dua">
                <ul id="dhikr-dua-list" class="dhikr-dua-list">
                    <li>No Dhikr/Duas added yet.</li>
                </ul>
            </section>

            <section id="hadith-linker" class="section" role="region" aria-labelledby="hadith-linker-heading">
                <h2 id="hadith-linker-heading">Hadith Linker (Simplified)</h2>
                <p>Add Hadith entries and link them to Ayahs for contextual study.</p>
                <div class="flex-group mb-10">
                    <label for="hadith-text" class="sr-only">Hadith Text</label>
                    <textarea id="hadith-text" placeholder="Hadith Text" lang="ar" dir="rtl"></textarea>
                    <label for="hadith-source" class="sr-only">Source</label>
                    <input type="text" id="hadith-source" placeholder="Source (e.g., Sahih Bukhari 1:1)">
                    <label for="hadith-notes" class="sr-only">Notes</label>
                    <textarea id="hadith-notes" placeholder="Your notes on the Hadith"></textarea>
                    <label for="hadith-linked-ayah" class="sr-only">Linked Ayah (Optional)</label>
                    <input type="text" id="hadith-linked-ayah" placeholder="Linked Ayah (e.g., 2:255)" aria-label="Linked Ayah (Optional)">
                    <button id="add-hadith-btn">Add Hadith</button>
                </div>
                <p id="hadith-linker-status" aria-live="polite"></p>

                <h3 class="mt-20">My Hadith Entries</h3>
                <input type="text" id="filter-hadith-input" placeholder="Filter Hadith..." aria-label="Filter Hadith">
                <ul id="hadith-list" class="hadith-list">
                    <li>No Hadith entries added yet.</li>
                </ul>
            </section>

            <section id="bookmarks" class="section" role="region" aria-labelledby="bookmarks-heading">
                <h2 id="bookmarks-heading">Bookmarked Ayahs</h2>
                <p>Your saved Ayahs for quick reference.</p>
                <input type="text" id="filter-bookmarks-input" placeholder="Filter bookmarks..." aria-label="Filter Bookmarks">
                <ul id="bookmarks-list" class="bookmark-list">
                    <li>No bookmarks added yet.</li>
                </ul>
            </section>

            <section id="search" class="section" role="region" aria-labelledby="search-heading">
                <h2 id="search-heading">Advanced Search</h2>
                <p>Search across Quran text, translations, and your personal data.</p>

                <div class="search-form mb-20">
                    <label for="search-input" class="sr-only">Search Term</label>
                    <input type="text" id="search-input" placeholder="Enter search term">
                    <div class="search-options mb-10" role="group" aria-label="Search Scope">
                        <label><input type="checkbox" class="search-scope" value="quran-arabic" checked> Quran Arabic</label>
                        <label><input type="checkbox" class="search-scope" value="quran-translation" checked> Quran Translation</label>
                        <label><input type="checkbox" class="search-scope" value="tafsir"> Personal Tafsir</label>
                        <label><input type="checkbox" class="search-scope" value="themes"> Theme Notes</label>
                        <label><input type="checkbox" class="search-scope" value="roots"> Root Notes</label>
                        <label><input type="checkbox" class="search-scope" value="recitation"> Recitation Notes</label>
                        <label><input type="checkbox" class="search-scope" value="hifz"> Hifz Notes</label>
                        <label><input type="checkbox" class="search-scope" value="vocabulary"> Vocabulary Notes</label>
                        <label><input type="checkbox" class="search-scope" value="cross-refs"> Cross-Reference Notes</label>
                        <label><input type="checkbox" class="search-scope" value="dhikr-dua"> Dhikr/Dua Notes</label>
                        <label><input type="checkbox" class="search-scope" value="hadith"> Hadith Notes</label>
                    </div>
                    <button id="perform-search-btn">Search</button>
                     <p id="search-status" aria-live="polite"></p>
                </div>

                <div class="search-results">
                    <h3>Search Results</h3>
                    <ul id="search-results-list">
                        <!-- Search results populated by JS -->
                        <li>Enter a search term and click "Search".</li>
                    </ul>
                </div>
            </section>

            <section id="data" class="section" role="region" aria-labelledby="data-heading">
                <h2 id="data-heading">Data Management</h2>
                <p>Manage your personal data (Tafsir, Themes, Roots, Logs, Hifz, Bookmarks, Vocabulary, Cross-Refs, Dhikr/Dua, Hadith).</p>

                <div class="settings-section mb-20">
                    <h3>Backup Data</h3>
                    <p>Export your personal data as a JSON file.</p>
                    <button id="export-data-btn">Export Data</button>
                     <p id="export-status" aria-live="polite"></p>
                </div>

                <div class="settings-section mb-20">
                    <h3>Restore Data</h3>
                    <p>Import your personal data from a JSON file. This will overwrite existing data.</p>
                    <label for="import-file" class="sr-only">Choose JSON file to import</label>
                    <input type="file" id="import-file" accept="application/json">
                    <button id="import-data-btn" disabled>Import Data</button>
                     <p id="import-status" aria-live="polite"></p>
                </div>

                 <div class="settings-section">
                    <h3>Clear All Personal Data</h3>
                    <p class="mb-10" style="color: var(--color-error);">Warning: This will permanently delete ALL your personal Tafsir, Themes, Roots, Logs, Hifz, Bookmarks, Vocabulary, Cross-Refs, Dhikr/Dua, and Hadith data.</p>
                     <button id="clear-data-btn" style="background-color: var(--color-error);">Clear All Data</button>
                     <p id="clear-status" aria-live="polite"></p>
                 </div>
                 <div class="settings-section mb-20">
                <h3>Export Personal Tafsir to Word (.docx)</h3>
                <p>Generates a .docx file of all your Tafsir notes (basic styling).</p>
                <button id="export-tafsir-to-docx-btn">Export Tafsir to .docx</button>
                <p id="export-tafsir-docx-status" aria-live="polite"></p>
            </div>
            </section>

            <section id="settings" class="section" role="region" aria-labelledby="settings-heading">
                <h2 id="settings-heading">Application Settings</h2>
                <div class="settings-section mb-20">
                    <h3>Theme Selection</h3>
                    <label for="theme-switcher-settings">Choose Theme:</label>
                    <select id="theme-switcher-settings" aria-label="Choose Theme">
                        <option value="serene">Serene Digital Mosque</option>
                        <option value="manuscript">Ancient Illuminated Manuscript</option>
                        <option value="holo">Futuristic Holo-Quran</option>
                    </select>
                </div>
                <div class="settings-section mb-20">
                    <h3>Font Size Control</h3>
                    <div id="font-size-control">
                        <label for="arabic-font-size">Arabic:</label>
                        <input type="range" id="arabic-font-size" min="1.0" max="3.0" step="0.1" value="1.8" aria-label="Adjust Arabic Font Size">
                        <span id="arabic-font-size-value">1.8rem</span>
                    </div>
                    <div id="font-size-control">
                        <label for="translation-font-size">Translation:</label>
                        <input type="range" id="translation-font-size" min="0.8" max="2.0" step="0.1" value="1.1" aria-label="Adjust Translation Font Size">
                        <span id="translation-font-size-value">1.1rem</span>
                    </div>
                    <div id="font-size-control">
                        <label for="general-font-size">General UI:</label>
                        <input type="range" id="general-font-size" min="0.8" max="1.5" step="0.05" value="1.0" aria-label="Adjust General UI Font Size">
                        <span id="general-font-size-value">1.0rem</span>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modals (kept separate for clarity, but part of the single file) -->
    <!-- Modal for Theme Ayahs -->
    <div id="themeAyahsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="themeAyahsModalTitle">
        <div class="modal-content">
            <span class="close-button" aria-label="Close Theme Ayahs Modal">&times;</span>
            <h3 id="themeAyahsModalTitle">Ayahs Linked to Theme: <span id="modal-theme-name"></span></h3>
            <ul id="modal-linked-ayahs-list">
                <!-- Linked ayahs populated here -->
            </ul>
        </div>
    </div>

    <!-- Modal for Root Occurrences -->
     <div id="rootOccurrencesModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="rootOccurrencesModalTitle">
        <div class="modal-content">
            <span class="close-button" aria-label="Close Root Occurrences Modal">&times;</span>
            <h3 id="rootOccurrencesModalTitle">Occurrences for Root: <span id="modal-root-term"></span></h3>
            <ul id="modal-root-occurrences-list">
                <!-- Root occurrences populated here -->
            </ul>
        </div>
    </div>

    <!-- Modal for Hifz Notes -->
    <div id="hifzNotesModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="hifzNotesModalTitle">
        <div class="modal-content">
            <span class="close-button" aria-label="Close Hifz Notes Modal">&times;</span>
            <h3 id="hifzNotesModalTitle">Hifz Notes for <span id="modal-hifz-ayah-ref"></span></h3>
            <textarea id="modal-hifz-notes-textarea" placeholder="Enter Hifz notes here..."></textarea>
            <button id="save-modal-hifz-notes-btn">Save Notes</button>
            <p id="hifz-modal-status" aria-live="polite"></p>
        </div>
    </div>

    <script>
        // Author: Yasin Ullah, Pakistani

        const DB_NAME = 'NurAlQuranStudioProDB';
        const DB_VERSION = 9; // Incremented for new features and word_metadata index

        // Object Store Names
        const STORE_QURAN = 'quran';
        const STORE_TAFSIR = 'tafsir';
        const STORE_THEMES = 'themes';
        const STORE_THEME_AYAHS = 'theme_ayahs';
        const STORE_ROOTS = 'roots';
        const STORE_ROOT_AYAHS = 'root_ayahs'; // Not actively used for linking in this app but defined
        const STORE_RECITATIONS = 'recitations';
        const STORE_HIFZ = 'hifz';
        const STORE_SETTINGS = 'settings';
        const STORE_WORD_TRANSLATIONS = 'word_translations';
        const STORE_WORD_METADATA = 'word_metadata';

        // New Stores
        const STORE_BOOKMARKS = 'bookmarks';
        const STORE_VOCABULARY = 'vocabulary';
        const STORE_CROSS_REFERENCES = 'cross_references';
        const STORE_DHIKR_DUA = 'dhikr_dua';
        const STORE_HADITH_LINKS = 'hadith_links';

        // Data file names (relative paths, assumed to be in the same directory or accessible)
        const WORD_TRANSLATION_FILE = 'data5 new.AM'; // Contains word_id, ur_meaning, en_meaning
        const WORD_METADATA_FILE = 'word2.AM';       // Contains word_id, surah, ayah, word_postion
        const QURAN_URDU_FILE = 'data new.AM';
        const QURAN_ENGLISH_FILE = 'dataENG.AM';
        const QURAN_BANGALI_FILE = 'dataBNG.AM';


        // Global state
        let db;
        let currentSurah = 1;
        let currentAyah = 1;
        let totalAyahsInSurah = 7; // Default for Surah 1 (Al-Fatihah)
        let quranDataLoaded = false;
        let selectedHifzSurah = 1;

        const surahNames = [
            "Al-Fatihah", "Al-Baqarah", "Al 'Imran", "An-Nisa'", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus",
            "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra'", "Al-Kahf", "Maryam", "Taha",
            "Al-Anbya'", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara'", "An-Naml", "Al-Qasas", "Al-'Ankabut", "Ar-Rum",
            "Luqman", "As-Sajdah", "Al-Ahzab", "Saba'", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir",
            "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf",
            "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadilah", "Al-Hashr", "Al-Mumtahanah",
            "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij",
            "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba'", "An-Nazi'at", "'Abasa",
            "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad",
            "Ash-Shams", "Al-Layl", "Ad-Duha", "Ash-Sharh", "At-Tin", "Al-'Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-'Adiyat",
            "Al-Qari'ah", "At-Takathur", "Al-'Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr",
            "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"
        ];
        const surahAyahCounts = [
            0, 7, 286, 200, 176, 120, 165, 206, 75, 129, 109, 123, 111, 43, 52, 99, 128, 111, 110, 98, 135, 112, 78, 118, 64, 77, 227, 93, 88, 69,
            60, 34, 30, 73, 54, 45, 83, 182, 88, 75, 85, 54, 53, 89, 59, 37, 35, 38, 29, 18, 45, 60, 49, 62, 55, 78, 96, 29, 22, 24,
            13, 14, 11, 11, 18, 12, 12, 30, 52, 52, 44, 28, 28, 20, 56, 40, 31, 50, 40, 46, 42, 29, 19, 36, 25, 22, 17, 19, 26, 30,
            20, 15, 21, 11, 8, 5, 19, 5, 8, 8, 11, 11, 8, 3, 9, 5, 4, 7, 3, 6, 3, 5, 4, 5, 6
        ];

        const TRANSLATION_CONFIG = {
            urdu: { file: QURAN_URDU_FILE, lang: 'ur', dir: 'rtl', label: 'Urdu' },
            english: { file: QURAN_ENGLISH_FILE, lang: 'en', dir: 'ltr', label: 'English' },
            Bangali: { file: QURAN_BANGALI_FILE, lang: 'bn', dir: 'ltr', label: 'Bangali' }
        };

        // --- IndexedDB Functions ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                        request.onupgradeneeded = (event) => {
            db = event.target.result;
            const transaction = event.target.transaction; // Get the transaction for modifications
            const oldVersion = event.oldVersion;
            console.log(`IndexedDB upgrade needed from version ${oldVersion} to ${DB_VERSION}.`);

            // 1. Handle Core Quran Data Store
            // This store needs to be recreated if its structure changes, e.g., for multiple translations
            if (db.objectStoreNames.contains(STORE_QURAN)) {
                if (oldVersion < 2) { // Assuming multi-translation support came in version 2
                    db.deleteObjectStore(STORE_QURAN);
                    console.log(`Recreated '${STORE_QURAN}' store for version ${DB_VERSION}.`);
                }
            }
            if (!db.objectStoreNames.contains(STORE_QURAN)) {
                db.createObjectStore(STORE_QURAN, { keyPath: ['surah', 'ayah'] });
                console.log(`Created '${STORE_QURAN}' store.`);
            }

            // 2. Define all personal data stores and their configurations (including indexes)
            const personalStoreConfigs = [
                { name: STORE_TAFSIR, keyPath: ['surah', 'ayah'] },
                { name: STORE_THEMES, keyPath: 'id', autoIncrement: true },
                // Note: theme_ayahs has specific index creation, handled separately below for clarity.
                { name: STORE_ROOTS, keyPath: 'id', autoIncrement: true },
                // Note: root_ayahs has specific index creation, handled separately below for clarity.
                { name: STORE_RECITATIONS, keyPath: 'id', autoIncrement: true },
                { name: STORE_HIFZ, keyPath: ['surah', 'ayah'] },
                { name: STORE_SETTINGS, keyPath: 'name' },
                // New in v9
                { name: STORE_BOOKMARKS, keyPath: ['surah', 'ayah'] },
                { name: STORE_VOCABULARY, keyPath: 'id', autoIncrement: true, indexes: [{ name: 'arabicWord_idx', keyPath: 'arabicWord', unique: false }] },
                { name: STORE_CROSS_REFERENCES, keyPath: 'id', autoIncrement: true, indexes: [{ name: 'fromAyah_idx', keyPath: ['fromSurah', 'fromAyah'], unique: false }] },
                { name: STORE_DHIKR_DUA, keyPath: 'id', autoIncrement: true },
                { name: STORE_HADITH_LINKS, keyPath: 'id', autoIncrement: true, indexes: [{ name: 'linkedAyah_idx', keyPath: ['linkedSurah', 'linkedAyah'], unique: false }] }
            ];

            // Create or modify personal data stores and their indexes
            personalStoreConfigs.forEach(config => {
                let store;
                if (!db.objectStoreNames.contains(config.name)) {
                    // Store does not exist, create it
                    store = db.createObjectStore(config.name, { keyPath: config.keyPath, autoIncrement: config.autoIncrement || false });
                    console.log(`Created '${config.name}' store.`);
                } else if (oldVersion < DB_VERSION) {
                    // Store exists, but this is an upgrade, so get it from the transaction
                    // to potentially add new indexes.
                    // This is the crucial part: use 'transaction.objectStore()'
                    store = transaction.objectStore(config.name);
                } else {
                    // Store exists and no schema changes needed for this version
                    return; // Skip if no upgrade path or store is already in latest version
                }

                // Add or ensure indexes for the store
                if (store && config.indexes) {
                    config.indexes.forEach(indexConfig => {
                        if (!store.indexNames.contains(indexConfig.name)) {
                            store.createIndex(indexConfig.name, indexConfig.keyPath, { unique: indexConfig.unique });
                            console.log(`Created index '${indexConfig.name}' on '${config.name}'.`);
                        }
                    });
                }
            });

            // Specific handling for theme_ayahs and root_ayahs stores which had unique index creation logic
            // (Keeping these separate as they were in the original code, but could be integrated if preferred)
            if (!db.objectStoreNames.contains(STORE_THEME_AYAHS)) {
                const themeAyahsStore = db.createObjectStore(STORE_THEME_AYAHS, { keyPath: 'id', autoIncrement: true });
                themeAyahsStore.createIndex('themeId', 'themeId', { unique: false });
                themeAyahsStore.createIndex('surahAyah', ['surah', 'ayah'], { unique: false });
                console.log(`Created '${STORE_THEME_AYAHS}' store.`);
            } else if (oldVersion < DB_VERSION) { // For existing store in an upgrade, ensure indexes
                const themeAyahsStore = transaction.objectStore(STORE_THEME_AYAHS);
                if (!themeAyahsStore.indexNames.contains('themeId')) {
                    themeAyahsStore.createIndex('themeId', 'themeId', { unique: false });
                }
                if (!themeAyahsStore.indexNames.contains('surahAyah')) {
                    themeAyahsStore.createIndex('surahAyah', ['surah', 'ayah'], { unique: false });
                }
            }

            if (!db.objectStoreNames.contains(STORE_ROOT_AYAHS)) {
                const rootAyahsStore = db.createObjectStore(STORE_ROOT_AYAHS, { keyPath: 'id', autoIncrement: true });
                rootAyahsStore.createIndex('rootId', 'rootId', { unique: false });
                rootAyahsStore.createIndex('surahAyah', ['surah', 'ayah'], { unique: false });
                rootAyahsStore.createIndex('word', 'word', { unique: false });
                console.log(`Created '${STORE_ROOT_AYAHS}' store.`);
            } else if (oldVersion < DB_VERSION) { // For existing store in an upgrade, ensure indexes
                const rootAyahsStore = transaction.objectStore(STORE_ROOT_AYAHS);
                if (!rootAyahsStore.indexNames.contains('rootId')) {
                    rootAyahsStore.createIndex('rootId', 'rootId', { unique: false });
                }
                if (!rootAyahsStore.indexNames.contains('surahAyah')) {
                    rootAyahsStore.createIndex('surahAyah', ['surah', 'ayah'], { unique: false });
                }
                if (!rootAyahsStore.indexNames.contains('word')) {
                    rootAyahsStore.createIndex('word', 'word', { unique: false });
                }
            }


            // 3. Handle Word Data Stores (These often need full recreation if keyPath changes)
            // Word Translations Store (STORE_WORD_TRANSLATIONS)
            if (db.objectStoreNames.contains(STORE_WORD_TRANSLATIONS)) {
                if (oldVersion < 7) { // Version 7 introduced word_id keying, requires recreation
                    db.deleteObjectStore(STORE_WORD_TRANSLATIONS);
                    console.log(`Re-creating '${STORE_WORD_TRANSLATIONS}' for DB_VERSION ${DB_VERSION} to be keyed by 'word_id'.`);
                    db.createObjectStore(STORE_WORD_TRANSLATIONS, { keyPath: 'word_id' });
                }
            } else {
                db.createObjectStore(STORE_WORD_TRANSLATIONS, { keyPath: 'word_id' });
                console.log(`Created new '${STORE_WORD_TRANSLATIONS}' store, keyed by 'word_id'.`);
            }

            // Word Metadata Store (STORE_WORD_METADATA)
            if (db.objectStoreNames.contains(STORE_WORD_METADATA)) {
                if (oldVersion < 7) { // Version 7 introduced this store's purpose/key structure, requires recreation
                    db.deleteObjectStore(STORE_WORD_METADATA);
                    console.log(`Re-creating '${STORE_WORD_METADATA}' for DB_VERSION ${DB_VERSION}.`);
                    const wordMetadataStore = db.createObjectStore(STORE_WORD_METADATA, { keyPath: 'word_id' });
                    wordMetadataStore.createIndex('location_idx', ['surah', 'ayah', 'word_position'], { unique: true });
                } else if (oldVersion < DB_VERSION && !transaction.objectStore(STORE_WORD_METADATA).indexNames.contains('location_idx')) {
                    // If the index was missing for some reason in an existing store or needs to be ensured for this version
                    transaction.objectStore(STORE_WORD_METADATA).createIndex('location_idx', ['surah', 'ayah', 'word_position'], { unique: true });
                    console.log(`Created index 'location_idx' on '${STORE_WORD_METADATA}'.`);
                }
            } else {
                const wordMetadataStore = db.createObjectStore(STORE_WORD_METADATA, { keyPath: 'word_id' });
                wordMetadataStore.createIndex('location_idx', ['surah', 'ayah', 'word_position'], { unique: true });
                console.log(`Created new '${STORE_WORD_METADATA}' store and its index.`);
            }
        };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("IndexedDB opened successfully.");
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.errorCode, event.target.error);
                    reject("Failed to open IndexedDB: " + event.target.error.message);
                };
            });
        }

        function getObjectStore(storeName, mode) {
            if (!db) {
                console.error("getObjectStore called but DB is not initialized.");
                throw new Error("Database not initialized.");
            }
            const transaction = db.transaction(storeName, mode);
            return transaction.objectStore(storeName);
        }

        function addData(storeName, data) {
            return new Promise((resolve, reject) => {
                const store = getObjectStore(storeName, 'readwrite');
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => {
                    console.error(`Error adding data to ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

         function putData(storeName, data) {
            return new Promise((resolve, reject) => {
                const store = getObjectStore(storeName, 'readwrite');
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => {
                    console.error(`Error putting data to ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

        function getData(storeName, key) {
            return new Promise((resolve, reject) => {
                const store = getObjectStore(storeName, 'readonly');
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => {
                     console.error(`Error getting data from ${storeName} with key ${key}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

        function getAllData(storeName) {
            return new Promise((resolve, reject) => {
                const store = getObjectStore(storeName, 'readonly');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => {
                    console.error(`Error getting all data from ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

        function deleteData(storeName, key) {
             return new Promise((resolve, reject) => {
                const store = getObjectStore(storeName, 'readwrite');
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error(`Error deleting data from ${storeName} with key ${key}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

         function clearStore(storeName) {
             return new Promise((resolve, reject) => {
                const store = getObjectStore(storeName, 'readwrite');
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error(`Error clearing store ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
         }


        // --- Data Loading and Parsing (Initial Setup) ---
        async function loadInitialQuranData() {
            showLoading("Loading Quran & Word Data...");
            try {
                const settings = await getAllData(STORE_SETTINGS);
                const settingsMap = new Map(settings.map(s => [s.name, s.value]));

                const currentDBVersionForCheck = 9; // Latest version where all these data are loaded/reloaded
                const shouldLoadQuran = !(settingsMap.get('quranDataLoaded') && settingsMap.get('quranDataLoadedVersion') === currentDBVersionForCheck);
                const shouldLoadWordTranslations = !(settingsMap.get('wordTranslationsLoaded') && settingsMap.get('wordTranslationsLoadedVersion') === currentDBVersionForCheck);
                const shouldLoadWordMetadata = !(settingsMap.get('wordMetadataLoaded') && settingsMap.get('wordMetadataLoadedVersion') === currentDBVersionForCheck);

                if (!shouldLoadQuran && !shouldLoadWordTranslations && !shouldLoadWordMetadata) {
                    console.log("All necessary Quran, word translation, and word metadata already loaded for current DB version.");
                    quranDataLoaded = true;
                    await populateSurahAyahSelects();
                    await loadAyah(currentSurah, currentAyah);
                    hideLoading();
                    return;
                }

                const allQuranDataMap = new Map();
                let wordTranslationEntries = [];
                let wordMetadataEntries = [];

                const transactionStores = new Set([STORE_SETTINGS]);
                if (shouldLoadQuran) transactionStores.add(STORE_QURAN);
                if (shouldLoadWordTranslations) transactionStores.add(STORE_WORD_TRANSLATIONS);
                if (shouldLoadWordMetadata) transactionStores.add(STORE_WORD_METADATA);

                // --- 1. Load Full Quran Ayah Texts & Translations ---
                if (shouldLoadQuran) {
                    console.log("Fetching full Quran ayah texts and translations...");
                    for (const key in TRANSLATION_CONFIG) {
                        const config = TRANSLATION_CONFIG[key];
                        try {
                            const response = await fetch(config.file);
                            if (!response.ok) {
                                console.warn(`HTTP error! status: ${response.status} for ${config.file}. Skipping.`);
                                continue;
                            }
                            const text = await response.text();
                            console.log(`${config.label} data fetched (${config.file}). Parsing...`);

                            const lines = text.split('\n').filter(line => line.trim() !== '');
                            for (const line of lines) {
                                const parts = line.split(' ترجمہ: ');
                                if (parts.length < 2) continue;
                                const arabicPart = parts[0].trim();
                                const rest = parts[1];
                                const metaMatch = rest.match(/<br\/>\s*(?:s|س)\s*\.?\s*(\d{1,3})\s*(?:a|آ)\s*\.?\s*(\d{1,3})\s*$/i);
                                if (!metaMatch) continue;

                                const translationPart = rest.substring(0, metaMatch.index).trim();
                                const surahNum = parseInt(metaMatch[1], 10);
                                const ayahNum = parseInt(metaMatch[2], 10);

                                if (isNaN(surahNum) || isNaN(ayahNum) || surahNum < 1 || surahNum > 114 || ayahNum < 1) continue;

                                const mapKey = `${surahNum}-${ayahNum}`;
                                let entry = allQuranDataMap.get(mapKey);
                                if (!entry) {
                                    entry = { surah: surahNum, ayah: ayahNum, arabic: arabicPart, urdu: '', english: '', Bangali: '' };
                                    allQuranDataMap.set(mapKey, entry);
                                }
                                entry[key] = translationPart;
                            }
                        } catch (fetchError) {
                             console.error(`Error fetching/parsing ${config.file}:`, fetchError);
                        }
                    }
                    console.log(`Parsed ${allQuranDataMap.size} unique full ayahs.`);
                }

                // --- 2. Load Word Translations (from data5 new.AM) ---
                if (shouldLoadWordTranslations) {
                    console.log(`Fetching word translations from ${WORD_TRANSLATION_FILE}...`);
                    try {
                        const response = await fetch(WORD_TRANSLATION_FILE);
                        if (!response.ok) {
                            console.warn(`Failed to fetch ${WORD_TRANSLATION_FILE}: ${response.status}`);
                        } else {
                            const csvText = await response.text();
                            const lines = csvText.split('\n').filter(line => line.trim() !== '');
                            if (lines.length > 0) {
                                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                                const wordIdIndex = headers.indexOf('word_id');
                                const urMeaningIndex = headers.indexOf('ur_meaning');
                                const enMeaningIndex = headers.indexOf('en_meaning');

                                if (wordIdIndex === -1) {
                                    console.error(`'word_id' header not found in ${WORD_TRANSLATION_FILE}. Cannot process word translations.`);
                                } else {
                                    for (let i = 1; i < lines.length; i++) {
                                        const values = lines[i].split(',');
                                        const word_id_val = values[wordIdIndex] ? values[wordIdIndex].trim() : null;
                                        if (!word_id_val) continue;

                                        const entry = {
                                            word_id: parseInt(word_id_val, 10),
                                            ur_meaning: urMeaningIndex > -1 && values[urMeaningIndex] ? values[urMeaningIndex].trim() : '',
                                            en_meaning: enMeaningIndex > -1 && values[enMeaningIndex] ? values[enMeaningIndex].trim() : '',
                                        };
                                        if (!isNaN(entry.word_id)) {
                                            wordTranslationEntries.push(entry);
                                        }
                                    }
                                    console.log(`Parsed ${wordTranslationEntries.length} word translation entries from ${WORD_TRANSLATION_FILE}.`);
                                }
                            }
                        }
                    } catch (fetchError) {
                        console.error(`Error fetching/parsing ${WORD_TRANSLATION_FILE}:`, fetchError);
                    }
                }

                // --- 3. Load Word Metadata (from data2.AM) ---
                if (shouldLoadWordMetadata) {
                    console.log(`Fetching word metadata from ${WORD_METADATA_FILE}...`);
                    try {
                        const response = await fetch(WORD_METADATA_FILE);
                        if (!response.ok) {
                            console.warn(`Failed to fetch ${WORD_METADATA_FILE}: ${response.status}`);
                        } else {
                            const csvText = await response.text();
                            const lines = csvText.split('\n').filter(line => line.trim() !== '');
                            if (lines.length > 0) {
                                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                                const wordIdIndex = headers.indexOf('word_id');
                                const surahIndex = headers.indexOf('surah');
                                const ayahIndex = headers.indexOf('ayah');
                                const positionIndex = headers.indexOf('word_postion'); // Your CSV uses 'word_postion'

                                if (wordIdIndex === -1 || surahIndex === -1 || ayahIndex === -1 || positionIndex === -1) {
                                    console.error(`One or more required headers (word_id, surah, ayah, word_postion) not found in ${WORD_METADATA_FILE}.`);
                                } else {
                                    for (let i = 1; i < lines.length; i++) {
                                        const values = lines[i].split(',');
                                        const entry = {
                                            word_id: parseInt(values[wordIdIndex] ? values[wordIdIndex].trim() : '', 10),
                                            surah: parseInt(values[surahIndex] ? values[surahIndex].trim() : '', 10),
                                            ayah: parseInt(values[ayahIndex] ? values[ayahIndex].trim() : '', 10),
                                            word_position: parseInt(values[positionIndex] ? values[positionIndex].trim() : '', 10)
                                        };
                                        if (!isNaN(entry.word_id) && !isNaN(entry.surah) && !isNaN(entry.ayah) && !isNaN(entry.word_position)) {
                                            wordMetadataEntries.push(entry);
                                        }
                                    }
                                    console.log(`Parsed ${wordMetadataEntries.length} word metadata entries from ${WORD_METADATA_FILE}.`);
                                }
                            }
                        }
                    } catch (fetchError) {
                         console.error(`Error fetching/parsing ${WORD_METADATA_FILE}:`, fetchError);
                    }
                }

                // --- Transaction to Store Data ---
                if (shouldLoadQuran || shouldLoadWordTranslations || shouldLoadWordMetadata) {
                    const transaction = db.transaction(Array.from(transactionStores), 'readwrite');
                    transaction.oncomplete = async () => {
                        console.log("Data loading/storing transaction complete.");
                        if (shouldLoadQuran) await putData(STORE_SETTINGS, { name: 'quranDataLoaded', value: true, quranDataLoadedVersion: currentDBVersionForCheck }).catch(console.error);
                        if (shouldLoadWordTranslations) await putData(STORE_SETTINGS, { name: 'wordTranslationsLoaded', value: true, wordTranslationsLoadedVersion: currentDBVersionForCheck }).catch(console.error);
                        if (shouldLoadWordMetadata) await putData(STORE_SETTINGS, { name: 'wordMetadataLoaded', value: true, wordMetadataLoadedVersion: currentDBVersionForCheck }).catch(console.error);

                        quranDataLoaded = true;
                        await populateSurahAyahSelects();
                        await loadAyah(currentSurah, currentAyah);
                        hideLoading();
                    };
                    transaction.onerror = (event) => {
                        console.error("Transaction failed during initial data load:", event.target.error);
                        hideLoading();
                        alert("Failed to store initial data: " + event.target.error.message);
                    };

                    if (shouldLoadQuran && allQuranDataMap.size > 0) {
                        const quranStore = transaction.objectStore(STORE_QURAN);
                        quranStore.clear(); // Clear existing data to ensure full reload/update
                        for (const entry of allQuranDataMap.values()) quranStore.put(entry);
                    }
                    if (shouldLoadWordTranslations && wordTranslationEntries.length > 0) {
                        const store = transaction.objectStore(STORE_WORD_TRANSLATIONS);
                        store.clear();
                        for (const entry of wordTranslationEntries) store.put(entry);
                    }
                    if (shouldLoadWordMetadata && wordMetadataEntries.length > 0) {
                        const store = transaction.objectStore(STORE_WORD_METADATA);
                        store.clear();
                        for (const entry of wordMetadataEntries) store.put(entry);
                    }
                } else {
                     console.log("No new data needed to be fetched and stored. Initializing UI.");
                     quranDataLoaded = true;
                     await populateSurahAyahSelects();
                     await loadAyah(currentSurah, currentAyah);
                     hideLoading();
                }

            } catch (error) {
                console.error("Error in loadInitialQuranData:", error);
                hideLoading();
                alert("Failed to load application data: " + error.message);
            }
        }

        // --- UI Rendering and Navigation ---

        function populateSurahAyahSelects() {
            const surahSelects = [
                document.getElementById('surah-select'),
                document.getElementById('rec-surah-select'),
                document.getElementById('hifz-surah-select')
            ];
            const ayahSelect = document.getElementById('ayah-select');

            if (surahSelects[0].options.length === 0) {
                for (let i = 1; i <= 114; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}. ${surahNames[i - 1]}`;
                    surahSelects.forEach(select => select.appendChild(option.cloneNode(true)));
                }
            }
            surahSelects.forEach(select => select.value = currentSurah);
            updateAyahSelect(currentSurah);
            ayahSelect.value = currentAyah;
        }

        function updateAyahSelect(surahNum) {
            const ayahSelect = document.getElementById('ayah-select');
            ayahSelect.innerHTML = '';
            totalAyahsInSurah = surahAyahCounts[surahNum];
            for (let i = 1; i <= totalAyahsInSurah; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                ayahSelect.appendChild(option);
            }
            if (currentAyah > totalAyahsInSurah) {
                currentAyah = 1;
            }
            ayahSelect.value = currentAyah;
        }

        async function loadAyah(surah, ayah) {
            if (!db) {
                console.error("Database not open for loadAyah.");
                document.getElementById('quran-display').innerHTML = `<p class="text-center" style="color: var(--color-error);">Database not ready. Please try again later.</p>`;
                return;
            }
            showLoading(`Loading Ayah ${surah}:${ayah}...`);
            try {
                const quran = await getData(STORE_QURAN, [surah, ayah]);
                const tafsir = await getData(STORE_TAFSIR, [surah, ayah]);
                const bookmark = await getData(STORE_BOOKMARKS, [surah, ayah]);

                const displayArea = document.getElementById('quran-display');
                const tafsirAyahDisplay = document.getElementById('current-ayah-tafsir');
                const themeAyahDisplay = document.getElementById('current-ayah-theme-text');
                const tafsirNotes = document.getElementById('tafsir-notes');
                const quickNavigateInput = document.getElementById('quick-navigate-input');
                const fromAyahRefInput = document.getElementById('from-ayah-ref');


                displayArea.innerHTML = '';
                tafsirAyahDisplay.innerHTML = '';
                themeAyahDisplay.innerHTML = '';
                tafsirNotes.value = '';
                quickNavigateInput.value = `${surah}:${ayah}`;
                fromAyahRefInput.value = `${surah}:${ayah}`;


                if (quran) {
                    currentSurah = surah;
                    currentAyah = ayah;
                    document.getElementById('surah-select').value = surah;
                    document.getElementById('ayah-select').value = ayah;
                    document.getElementById('rec-surah-select').value = surah;
                    document.getElementById('hifz-surah-select').value = surah;
                    selectedHifzSurah = surah; // Keep track of current Hifz surah
                    updateAyahSelect(surah);

                    const ayahElement = document.createElement('div');
                    ayahElement.classList.add('ayah');
                    ayahElement.setAttribute('data-surah', surah);
                    ayahElement.setAttribute('data-ayah', ayah);

                    const bookmarkIcon = document.createElement('span');
                    bookmarkIcon.classList.add('bookmark-icon');
                    bookmarkIcon.classList.add('material-icons'); // For Material Icons font
                    bookmarkIcon.setAttribute('role', 'button');
                    bookmarkIcon.setAttribute('aria-label', bookmark ? 'Remove Bookmark' : 'Add Bookmark');
                    bookmarkIcon.textContent = bookmark ? 'bookmark' : 'bookmark_border';
                    if (bookmark) bookmarkIcon.classList.add('bookmarked');
                    bookmarkIcon.addEventListener('click', () => toggleBookmark(surah, ayah));
                    ayahElement.appendChild(bookmarkIcon);


                    const ayahNumber = document.createElement('div');
                    ayahNumber.classList.add('ayah-number');
                    ayahNumber.textContent = `Surah ${surah}:${ayah} (${surahNames[surah-1]})`;
                    ayahElement.appendChild(ayahNumber);

                    const arabicTextElement = document.createElement('div');
                    arabicTextElement.classList.add('ayah-arabic');
                    arabicTextElement.setAttribute('lang', 'ar');
                    arabicTextElement.setAttribute('dir', 'rtl');

                    // Split Arabic text into words and add spans for word-by-word translation
                    const words = quran.arabic.split(/\s+/).filter(w => w.trim() !== '');
                    words.forEach((wordText, index) => {
                        const span = document.createElement('span');
                        span.textContent = wordText + ' ';
                        span.setAttribute('data-word-text', wordText.trim());
                        span.setAttribute('data-word-position', index);
                        span.setAttribute('data-surah', surah);
                        span.setAttribute('data-ayah', ayah);
                        span.setAttribute('tabindex', '0');
                        span.setAttribute('role', 'button');
                        arabicTextElement.appendChild(span);
                    });
                    ayahElement.appendChild(arabicTextElement);

                    const translationText = document.createElement('div');
                    translationText.classList.add('ayah-translation');
                    const selectedTranslationKey = document.getElementById('translation-select').value;
                    const translationInfo = TRANSLATION_CONFIG[selectedTranslationKey];
                    if (translationInfo) {
                        translationText.setAttribute('lang', translationInfo.lang);
                        translationText.setAttribute('dir', translationInfo.dir);
                        translationText.style.fontFamily = `var(--font-${selectedTranslationKey})`;
                        translationText.style.textAlign = translationInfo.dir === 'rtl' ? 'right' : 'left';
                        translationText.textContent = quran[selectedTranslationKey] || "Translation not available.";
                    } else {
                        translationText.textContent = "Translation configuration error.";
                    }
                    ayahElement.appendChild(translationText);
                    displayArea.appendChild(ayahElement);

                    // Update other sections that display the current Ayah
                    const tafsirAyahElement = ayahElement.cloneNode(true);
                    tafsirAyahElement.querySelector('.ayah-number').textContent = `Tafsir for Surah ${surah}:${ayah}`;
                    if (tafsirAyahElement.querySelector('.bookmark-icon')) tafsirAyahElement.querySelector('.bookmark-icon').remove();
                    tafsirAyahElement.querySelectorAll('.ayah-arabic span').forEach(span => span.outerHTML = span.textContent);
                    tafsirAyahDisplay.innerHTML = '';
                    tafsirAyahDisplay.appendChild(tafsirAyahElement);
                    tafsirNotes.value = tafsir ? tafsir.notes : '';

                    const themeAyahElement = ayahElement.cloneNode(true);
                    themeAyahElement.querySelector('.ayah-number').textContent = `Ayah for Linking: Surah ${surah}:${ayah}`;
                    if (themeAyahElement.querySelector('.bookmark-icon')) themeAyahElement.querySelector('.bookmark-icon').remove();
                    themeAyahElement.querySelectorAll('.ayah-arabic span').forEach(span => span.outerHTML = span.textContent);
                    themeAyahDisplay.innerHTML = '';
                    themeAyahDisplay.appendChild(themeAyahElement);
                    document.getElementById('current-ayah-theme-ref').textContent = `${surah}:${ayah}`;
                    await populateThemeSelects();
                    await displayLinkedAyahsForCurrentTheme();
                    await displayAyahCrossReferences(surah, ayah); // Load cross-references
                    await displayLinkedHadithForAyah(surah, ayah); // Load Hadith links

                    addWordClickListeners();
                } else {
                    displayArea.innerHTML = `<p class="text-center" style="color: var(--color-error);">Ayah ${surah}:${ayah} not found in data.</p>`;
                    tafsirAyahDisplay.innerHTML = `<p class="text-center">Navigate to a valid Ayah to add Tafsir.</p>`;
                    themeAyahDisplay.innerHTML = `<p class="text-center">Navigate to a valid Ayah to link themes.</p>`;
                    document.getElementById('current-ayah-theme-ref').textContent = 'N/A';
                    tafsirNotes.value = '';
                }
                document.getElementById('word-translation-area').innerHTML = '<p class="text-center">Click on an Arabic word to see its translation.</p>';
            } catch (error) {
                console.error("Error loading ayah:", error);
                document.getElementById('quran-display').innerHTML = `<p class="text-center" style="color: var(--color-error);">Error loading Ayah: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        async function goToAyah(surah, ayah) {
            if (isNaN(surah) || isNaN(ayah) || surah < 1 || surah > 114 || ayah < 1 || ayah > surahAyahCounts[surah]) {
                setStatusMessage('search-status', 'Invalid Surah or Ayah.', true);
                return;
            }
            await loadAyah(surah, ayah);
            showSection('quran');
        }

        async function handleQuickNavigate() {
            const input = document.getElementById('quick-navigate-input').value.trim();
            const parts = input.split(':');
            if (parts.length === 2) {
                const surah = parseInt(parts[0], 10);
                const ayah = parseInt(parts[1], 10);
                if (!isNaN(surah) && !isNaN(ayah)) {
                    await goToAyah(surah, ayah);
                    return;
                }
            }
            alert("Invalid format. Please use 'Surah:Ayah' (e.g., 2:255).");
        }

        async function handleRandomAyah() {
            if (!quranDataLoaded) {
                alert("Quran data not yet loaded. Please wait.");
                return;
            }
            const randomSurah = Math.floor(Math.random() * 114) + 1;
            const randomAyah = Math.floor(Math.random() * surahAyahCounts[randomSurah]) + 1;
            await goToAyah(randomSurah, randomAyah);
        }


        function addWordClickListeners() {
            document.querySelectorAll('.ayah-arabic span').forEach(wordSpan => {
                wordSpan.removeEventListener('click', handleWordClick);
                wordSpan.addEventListener('click', handleWordClick);
                wordSpan.removeEventListener('focus', handleWordFocus);
                wordSpan.addEventListener('focus', handleWordFocus);
                wordSpan.removeEventListener('blur', handleWordBlur);
                wordSpan.addEventListener('blur', handleWordBlur);
            });
        }

        async function handleWordClick(event) {
            const wordSpan = event.target;
            const clickedWordActualText = wordSpan.getAttribute('data-word-text');
            const surahNum = parseInt(wordSpan.getAttribute('data-surah'), 10);
            const ayahNum = parseInt(wordSpan.getAttribute('data-ayah'), 10);
            const wordPosition = parseInt(wordSpan.getAttribute('data-word-position'), 10);

            if (!clickedWordActualText || isNaN(surahNum) || isNaN(ayahNum) || isNaN(wordPosition)) {
                console.warn("[handleWordClick] Clicked word span is missing required data attributes.", wordSpan.dataset);
                document.getElementById('word-translation-area').innerHTML = `<p style="color: var(--color-error);">Error: Could not identify clicked word's metadata.</p>`;
                return;
            }
            console.log(`[handleWordClick] Clicked: "${clickedWordActualText}" (S:${surahNum}, A:${ayahNum}, Pos:${wordPosition})`);

            const ayahElement = wordSpan.closest('.ayah');
            const fullAyahTranslationDiv = ayahElement.querySelector('.ayah-translation');
            const fullAyahTranslationText = fullAyahTranslationDiv ? fullAyahTranslationDiv.textContent : 'Full ayah translation not found.';

            const selectedFullTranslationKey = document.getElementById('translation-select').value;
            const fullTranslationInfo = TRANSLATION_CONFIG[selectedFullTranslationKey];
            const fullTranslationLabel = fullTranslationInfo ? fullTranslationInfo.label : 'Selected Translation';
            const fullTranslationLang = fullTranslationInfo ? fullTranslationInfo.lang : 'en';
            const fullTranslationDir = fullTranslationInfo ? fullTranslationInfo.dir : 'ltr';
            const fullTranslationFont = fullTranslationInfo ? `var(--font-${selectedFullTranslationKey})` : `var(--font-general)`;
            const fullTranslationTextAlign = fullTranslationInfo && fullTranslationInfo.dir === 'rtl' ? 'right' : 'left';

            let wordUrduMeaning = "N/A";
            let wordEnglishMeaning = "N/A";

            try {
                const metadataStore = getObjectStore(STORE_WORD_METADATA, 'readonly');
                const locationIndex = metadataStore.index('location_idx');
                const metadataRequest = locationIndex.get([surahNum, ayahNum, wordPosition]);

                const wordMetadataEntry = await new Promise((resolve, reject) => {
                    metadataRequest.onsuccess = () => resolve(metadataRequest.result);
                    metadataRequest.onerror = (e) => {
                        console.error("Error fetching from word_metadata:", e.target.error);
                        reject(e.target.error);
                    };
                });

                if (wordMetadataEntry && typeof wordMetadataEntry.word_id !== 'undefined') {
                    const word_id = wordMetadataEntry.word_id;
                    console.log(`[handleWordClick] Found word_id: ${word_id}`);
                    const translationEntry = await getData(STORE_WORD_TRANSLATIONS, word_id);
                    if (translationEntry) {
                        wordUrduMeaning = translationEntry.ur_meaning || "N/A";
                        wordEnglishMeaning = translationEntry.en_meaning || "N/A";
                        if (translationEntry.ur_meaning === "") wordUrduMeaning = "N/A (empty)";
                        if (translationEntry.en_meaning === "") wordEnglishMeaning = "N/A (empty)";
                    } else {
                        console.warn(`[handleWordClick] No translation entry in '${STORE_WORD_TRANSLATIONS}' for word_id: ${word_id}.`);
                    }
                } else {
                    console.warn(`[handleWordClick] No metadata entry in '${STORE_WORD_METADATA}' for S${surahNum}:A${ayahNum}, Pos:${wordPosition}. Word: "${clickedWordActualText}"`);
                }
            } catch (error) {
                console.error("[handleWordClick] Error during word data lookup:", error);
                wordUrduMeaning = "Lookup Error";
                wordEnglishMeaning = "Lookup Error";
            }

            const translationArea = document.getElementById('word-translation-area');
            translationArea.innerHTML = `
                <p><strong>Selected Word:</strong> <span lang="ar" dir="rtl" style="font-family: var(--font-arabic); font-size: 1.2rem;">${clickedWordActualText}</span></p>
                <p><strong>Urdu Meaning:</strong> <span lang="ur" dir="rtl" style="font-family: var(--font-urdu);">${wordUrduMeaning}</span></p>
                <p><strong>English Meaning:</strong> <span lang="en" dir="ltr" style="font-family: var(--font-english);">${wordEnglishMeaning}</span></p>
                <p><strong>Full Ayah Translation (${surahNum}:${ayahNum}) - ${fullTranslationLabel}:</strong> <span lang="${fullTranslationLang}" dir="${fullTranslationDir}" style="font-family: ${fullTranslationFont}; text-align: ${fullTranslationTextAlign};">${fullAyahTranslationText}</span></p>
            `;
            document.querySelectorAll('.ayah-arabic span').forEach(span => {
                span.style.backgroundColor = 'transparent';
            });
            wordSpan.style.backgroundColor = 'var(--color-highlight)';
        }

        function handleWordFocus(event) {
             handleWordClick(event);
        }
        function handleWordBlur(event) {
             event.target.style.backgroundColor = 'transparent';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                section.setAttribute('aria-hidden', 'true');
            });
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.add('active');
                activeSection.setAttribute('aria-hidden', 'false');
                activeSection.focus(); // For accessibility, focus the new section
            }

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                link.setAttribute('aria-current', 'false');
            });
            const activeLink = document.querySelector(`.nav-link[data-section="${sectionId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                activeLink.setAttribute('aria-current', 'page');
            }

            // Load data pertinent to the section
             if (sectionId === 'dashboard') {
                 updateDashboard();
             } else if (sectionId === 'themes') {
                 populateThemeSelects();
                 displayThemesList();
                 displayLinkedAyahsForCurrentTheme();
             } else if (sectionId === 'recitation') {
                 loadRecitationLogs();
             } else if (sectionId === 'hifz') {
                 const hifzSurahSelect = document.getElementById('hifz-surah-select');
                 selectedHifzSurah = parseInt(hifzSurahSelect.value, 10);
                 if (!isNaN(selectedHifzSurah)) {
                    loadHifzForSurah(selectedHifzSurah);
                 }
             } else if (sectionId === 'vocabulary') {
                 loadVocabularyWords();
             } else if (sectionId === 'cross-refs') {
                 loadCrossReferences();
             } else if (sectionId === 'dhikr-dua') {
                 loadDhikrDuas();
             } else if (sectionId === 'hadith-linker') {
                 loadHadithLinks();
             } else if (sectionId === 'bookmarks') {
                 loadBookmarks();
             } else if (sectionId === 'settings') {
                 loadThemePreference(); // Ensure theme is consistent with settings dropdown
                 loadFontSizes();
                 document.getElementById('theme-switcher-settings').value = document.getElementById('theme-switcher').value;
             }
        }

        function showLoading(message = 'Loading...') {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.textContent = message;
            loadingOverlay.style.display = 'flex';
            document.body.setAttribute('aria-busy', 'true');
        }
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.body.setAttribute('aria-busy', 'false');
        }

        function setStatusMessage(elementId, message, isError = false) {
            const statusElement = document.getElementById(elementId);
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.color = isError ? 'var(--color-error)' : 'var(--color-success)';
                statusElement.style.fontWeight = 'bold';
                setTimeout(() => {
                    statusElement.textContent = '';
                    statusElement.style.color = '';
                    statusElement.style.fontWeight = '';
                }, 7000);
            }
        }

        // --- Dashboard Functions ---
        async function updateDashboard() {
            if (!db) return;
            try {
                const tafsirCount = (await getAllData(STORE_TAFSIR)).length;
                const hifzEntries = await getAllData(STORE_HIFZ);
                const memorizedCount = hifzEntries.filter(e => e.status === 'memorized').length;
                const themesCount = (await getAllData(STORE_THEMES)).length;
                const vocabCount = (await getAllData(STORE_VOCABULARY)).length;

                document.getElementById('dashboard-tafsir-count').textContent = tafsirCount;
                document.getElementById('dashboard-hifz-count').textContent = memorizedCount;
                document.getElementById('dashboard-themes-count').textContent = themesCount;
                document.getElementById('dashboard-vocabulary-count').textContent = vocabCount;

                const upcomingReviews = hifzEntries
                    .filter(e => e.status === 'memorized' && e.nextReviewDate && new Date(e.nextReviewDate) <= new Date(Date.now() + (30 * 24 * 60 * 60 * 1000))) // next 30 days
                    .sort((a, b) => new Date(a.nextReviewDate) - new Date(b.nextReviewDate));

                const nextHifzEl = document.getElementById('dashboard-next-hifz');
                if (upcomingReviews.length > 0) {
                    let summaryHtml = '';
                    upcomingReviews.slice(0, 5).forEach(entry => { // Show top 5
                        summaryHtml += `<p>S ${entry.surah}:A ${entry.ayah} (${surahNames[entry.surah-1]}) - ${entry.nextReviewDate}</p>`;
                    });
                    if (upcomingReviews.length > 5) summaryHtml += `<p>...and ${upcomingReviews.length - 5} more.</p>`;
                    nextHifzEl.innerHTML = summaryHtml;
                } else {
                    nextHifzEl.textContent = 'No upcoming reviews in the next month.';
                }
            } catch (error) {
                console.error("Error updating dashboard:", error);
            }
        }

        // --- Tafsir Functions ---
        async function saveTafsir() {
            if (!db) return;
            const notes = document.getElementById('tafsir-notes').value.trim();
            if (!notes) {
                setStatusMessage('tafsir-status', 'Tafsir notes cannot be empty.', true);
                return;
            }
            if (currentSurah === 0 || currentAyah === 0) {
                 setStatusMessage('tafsir-status', 'Navigate to an Ayah first.', true);
                 return;
            }
            showLoading(`Saving Tafsir for ${currentSurah}:${currentAyah}...`);
            try {
                await putData(STORE_TAFSIR, { surah: currentSurah, ayah: currentAyah, notes: notes, dateModified: new Date().toISOString() });
                setStatusMessage('tafsir-status', `Tafsir saved for ${currentSurah}:${currentAyah}.`, false);
                updateDashboard();
            } catch (error) {
                setStatusMessage('tafsir-status', 'Failed to save Tafsir.', true);
            } finally {
                hideLoading();
            }
        }

        // --- Thematic Linker Functions ---
        async function populateThemeSelects() {
            if (!db) return;
            const themeSelectElements = [
                document.getElementById('parent-theme-select'),
                document.getElementById('link-theme-select')
            ];
            try {
                const themes = await getAllData(STORE_THEMES);
                themeSelectElements.forEach(select => {
                    const preservedValue = select.value;
                    select.innerHTML = '';
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = select.id === 'parent-theme-select' ? "-- No Parent --" : "-- Select Theme --";
                    select.appendChild(defaultOption);
                    themes.forEach(theme => {
                        const option = document.createElement('option');
                        option.value = theme.id;
                        option.textContent = theme.name;
                        select.appendChild(option);
                    });
                    if (select.querySelector(`option[value="${preservedValue}"]`)) {
                        select.value = preservedValue;
                    } else {
                        select.value = "";
                    }
                });
            } catch (error) {
                setStatusMessage('theme-manager-status', 'Failed to load themes.', true);
            }
        }

        async function displayThemesList() {
             if (!db) return;
             const themesListElement = document.getElementById('themes-list');
             themesListElement.innerHTML = '';
             try {
                 const themes = await getAllData(STORE_THEMES);
                 if (themes.length === 0) {
                     themesListElement.innerHTML = '<li>No themes added yet.</li>';
                     return;
                 }
                 themes.forEach(theme => {
                     const li = document.createElement('li');
                     li.innerHTML = `
                         <span data-theme-id="${theme.id}" class="view-theme-ayahs" tabindex="0" role="button">${theme.name}</span>
                         <div class="theme-actions" style="display: inline-block;">
                             <button data-theme-id="${theme.id}" class="delete-theme-btn">Delete</button>
                         </div>
                     `;
                      themesListElement.appendChild(li);
                 });
                 themesListElement.querySelectorAll('.view-theme-ayahs').forEach(span => {
                     span.addEventListener('click', handleViewThemeAyahs);
                     span.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') handleViewThemeAyahs(e); });
                 });
                 themesListElement.querySelectorAll('.delete-theme-btn').forEach(button => {
                     button.addEventListener('click', handleDeleteTheme);
                 });
             } catch (error) {
                 themesListElement.innerHTML = `<li>Error loading themes: ${error.message}</li>`;
             }
        }

        async function addTheme() {
            if (!db) return;
            const nameInput = document.getElementById('new-theme-name');
            const parentSelect = document.getElementById('parent-theme-select');
            const name = nameInput.value.trim();
            const parentId = parentSelect.value ? parseInt(parentSelect.value, 10) : null;

            if (!name) {
                setStatusMessage('theme-manager-status', 'Theme name cannot be empty.', true);
                return;
            }
            showLoading("Adding theme...");
            try {
                await addData(STORE_THEMES, { name: name, parentId: parentId, description: '', dateCreated: new Date().toISOString() });
                setStatusMessage('theme-manager-status', `Theme "${name}" added.`, false);
                nameInput.value = '';
                parentSelect.value = '';
                await populateThemeSelects();
                await displayThemesList();
                updateDashboard();
            } catch (error) {
                 setStatusMessage('theme-manager-status', 'Failed to add theme.', true);
            } finally {
                hideLoading();
            }
        }

         async function handleDeleteTheme(event) {
             if (!db) return;
             const themeId = parseInt(event.target.getAttribute('data-theme-id'), 10);
             if (isNaN(themeId) || !confirm("Delete this theme and all its linked ayahs?")) return;

             showLoading("Deleting theme...");
             try {
                 await deleteData(STORE_THEMES, themeId);
                 const store = getObjectStore(STORE_THEME_AYAHS, 'readwrite');
                 const index = store.index('themeId');
                 const request = index.openCursor(IDBKeyRange.only(themeId));
                 request.onsuccess = (e) => {
                     const cursor = e.target.result;
                     if (cursor) {
                         cursor.delete();
                         cursor.continue();
                     } else {
                         setStatusMessage('theme-manager-status', 'Theme and linked ayahs deleted.', false);
                         populateThemeSelects();
                         displayThemesList();
                         updateDashboard();
                         hideLoading();
                     }
                 };
                 request.onerror = () => {
                     setStatusMessage('theme-manager-status', 'Theme deleted, but failed to delete all linked ayahs.', true);
                     hideLoading();
                 };
             } catch (error) {
                 setStatusMessage('theme-manager-status', 'Failed to delete theme.', true);
                 hideLoading();
             }
         }

        async function linkAyahToTheme() {
            if (!db) return;
            const themeSelect = document.getElementById('link-theme-select');
            const notesInput = document.getElementById('theme-link-notes');
            const themeId = themeSelect.value ? parseInt(themeSelect.value, 10) : null;
            const notes = notesInput.value.trim();

            if (!themeId) {
                setStatusMessage('theme-linker-status', 'Please select a theme.', true);
                return;
            }
            if (currentSurah === 0 || currentAyah === 0) {
                 setStatusMessage('theme-linker-status', 'Navigate to an Ayah first.', true);
                 return;
            }
            showLoading(`Linking Ayah ${currentSurah}:${currentAyah}...`);
            try {
                 const store = getObjectStore(STORE_THEME_AYAHS, 'readonly');
                 const index = store.index('surahAyah');
                 const request = index.getAll(IDBKeyRange.only([currentSurah, currentAyah]));
                 const existingLinks = await new Promise(r => { request.onsuccess = () => r(request.result); });
                 if (existingLinks.some(link => link.themeId === themeId)) {
                     setStatusMessage('theme-linker-status', 'Ayah already linked to this theme.', true);
                 } else {
                    await addData(STORE_THEME_AYAHS, { themeId: themeId, surah: currentSurah, ayah: currentAyah, notes: notes, dateLinked: new Date().toISOString() });
                    setStatusMessage('theme-linker-status', `Ayah ${currentSurah}:${currentAyah} linked.`, false);
                    notesInput.value = '';
                    await displayLinkedAyahsForCurrentTheme();
                 }
            } catch (error) {
                 setStatusMessage('theme-linker-status', 'Failed to link Ayah.', true);
            } finally {
                hideLoading();
            }
        }

        async function handleViewThemeAyahs(event) {
             if (!db) return;
             const themeId = parseInt(event.target.getAttribute('data-theme-id'), 10);
             if (isNaN(themeId)) return;
             showLoading("Loading linked ayahs...");
             try {
                 const theme = await getData(STORE_THEMES, themeId);
                 if (!theme) {
                     setStatusMessage('theme-manager-status', 'Theme not found.', true); hideLoading(); return;
                 }
                 document.getElementById('modal-theme-name').textContent = theme.name;
                 const listEl = document.getElementById('modal-linked-ayahs-list');
                 listEl.innerHTML = '';
                 const store = getObjectStore(STORE_THEME_AYAHS, 'readonly');
                 const index = store.index('themeId');
                 const request = index.openCursor(IDBKeyRange.only(themeId));
                 const linkedAyahs = [];
                 request.onsuccess = (e) => {
                     const cursor = e.target.result;
                     if (cursor) {
                         linkedAyahs.push(cursor.value);
                         cursor.continue();
                     } else {
                         if (linkedAyahs.length === 0) {
                             listEl.innerHTML = '<li>No ayahs linked yet.</li>';
                         } else {
                             linkedAyahs.sort((a, b) => (a.surah !== b.surah) ? a.surah - b.surah : a.ayah - b.ayah);
                             linkedAyahs.forEach(link => {
                                 const li = document.createElement('li');
                                 li.innerHTML = `
                                     <strong>Surah ${link.surah}:${link.ayah} (${surahNames[link.surah-1]})</strong>
                                     ${link.notes ? ` - <em>${link.notes}</em>` : ''}
                                     <button data-link-id="${link.id}" class="delete-theme-link-btn" style="margin-left: 10px;">Unlink</button>
                                     <button data-surah="${link.surah}" data-ayah="${link.ayah}" class="go-to-ayah-btn" style="margin-left: 5px;">Go</button>
                                 `;
                                 listEl.appendChild(li);
                             });
                             listEl.querySelectorAll('.delete-theme-link-btn').forEach(button => {
                                 button.addEventListener('click', handleDeleteThemeLink);
                             });
                             listEl.querySelectorAll('.go-to-ayah-btn').forEach(button => {
                                 button.addEventListener('click', (e) => {
                                     document.getElementById('themeAyahsModal').style.display = 'none'; // Close modal
                                     goToAyah(parseInt(e.target.dataset.surah), parseInt(e.target.dataset.ayah));
                                 });
                             });
                         }
                         hideLoading();
                         document.getElementById('themeAyahsModal').style.display = 'flex';
                         document.getElementById('themeAyahsModal').querySelector('.modal-content').setAttribute('data-current-theme-id', themeId);
                         document.getElementById('themeAyahsModalTitle').focus();
                     }
                 };
                 request.onerror = () => { listEl.innerHTML = `<li>Error loading.</li>`; hideLoading(); };
             } catch (error) {
                 setStatusMessage('theme-manager-status', 'Failed to load theme details.', true); hideLoading();
             }
        }

         async function handleDeleteThemeLink(event) {
             if (!db) return;
             const linkId = parseInt(event.target.getAttribute('data-link-id'), 10);
             if (isNaN(linkId) || !confirm("Unlink this Ayah?")) return;
             showLoading("Unlinking Ayah...");
             try {
                 await deleteData(STORE_THEME_AYAHS, linkId);
                 setStatusMessage('theme-linker-status', 'Ayah unlinked.', false);
                 const modalContent = event.target.closest('.modal-content');
                 const currentModalThemeId = parseInt(modalContent.getAttribute('data-current-theme-id'), 10);
                 if (!isNaN(currentModalThemeId)) {
                     await displayLinkedAyahsForThemeInModal(currentModalThemeId);
                 } else {
                      document.getElementById('themeAyahsModal').style.display = 'none';
                      displayThemesList();
                 }
             } catch (error) {
                 setStatusMessage('theme-linker-status', 'Failed to unlink Ayah.', true);
             } finally {
                 hideLoading();
             }
         }

         async function displayLinkedAyahsForThemeInModal(themeId) {
             if (!db) return;
             const listEl = document.getElementById('modal-linked-ayahs-list');
             listEl.innerHTML = '';
             try {
                 const store = getObjectStore(STORE_THEME_AYAHS, 'readonly');
                 const index = store.index('themeId');
                 const request = index.openCursor(IDBKeyRange.only(themeId));
                 const linkedAyahs = [];
                 request.onsuccess = (e) => {
                     const cursor = e.target.result;
                     if (cursor) {
                         linkedAyahs.push(cursor.value);
                         cursor.continue();
                     } else {
                         if (linkedAyahs.length === 0) { listEl.innerHTML = '<li>No ayahs linked.</li>'; }
                         else {
                             linkedAyahs.sort((a, b) => (a.surah !== b.surah) ? a.surah - b.surah : a.ayah - b.ayah);
                             linkedAyahs.forEach(link => {
                                 const li = document.createElement('li');
                                 li.innerHTML = `
                                     <strong>Surah ${link.surah}:${link.ayah} (${surahNames[link.surah-1]})</strong>
                                     ${link.notes ? ` - <em>${link.notes}</em>` : ''}
                                     <button data-link-id="${link.id}" class="delete-theme-link-btn">Unlink</button>
                                     <button data-surah="${link.surah}" data-ayah="${link.ayah}" class="go-to-ayah-btn">Go</button>
                                 `;
                                 listEl.appendChild(li);
                             });
                             listEl.querySelectorAll('.delete-theme-link-btn').forEach(b => b.addEventListener('click', handleDeleteThemeLink));
                             listEl.querySelectorAll('.go-to-ayah-btn').forEach(button => {
                                 button.addEventListener('click', (e) => {
                                     document.getElementById('themeAyahsModal').style.display = 'none';
                                     goToAyah(parseInt(e.target.dataset.surah), parseInt(e.target.dataset.ayah));
                                 });
                             });
                         }
                     }
                 };
                 request.onerror = () => { listEl.innerHTML = `<li>Error refreshing list.</li>`; };
             } catch (error) { listEl.innerHTML = `<li>Error: ${error.message}</li>`; }
         }

         async function displayLinkedAyahsForCurrentTheme() {
             if (!db) return;
             const themeSelect = document.getElementById('link-theme-select');
             const themeId = themeSelect.value ? parseInt(themeSelect.value, 10) : null;
             const listEl = document.getElementById('linked-ayahs-list');
             const nameEl = document.getElementById('linked-theme-name');
             listEl.innerHTML = '';

             if (!themeId) {
                 nameEl.textContent = 'N/A';
                 listEl.innerHTML = '<li>Select a theme to see linked ayahs.</li>';
                 return;
             }
             showLoading("Loading linked ayahs...");
             try {
                 const theme = await getData(STORE_THEMES, themeId);
                 nameEl.textContent = theme ? theme.name : 'Unknown';
                 const store = getObjectStore(STORE_THEME_AYAHS, 'readonly');
                 const index = store.index('themeId');
                 const request = index.openCursor(IDBKeyRange.only(themeId));
                 const linkedAyahs = [];
                 request.onsuccess = (e) => {
                     const cursor = e.target.result;
                     if (cursor) {
                         linkedAyahs.push(cursor.value);
                         cursor.continue();
                     } else {
                         if (linkedAyahs.length === 0) { listEl.innerHTML = '<li>No ayahs linked.</li>'; }
                         else {
                             linkedAyahs.sort((a, b) => (a.surah !== b.surah) ? a.surah - b.surah : a.ayah - b.ayah);
                             linkedAyahs.forEach(link => {
                                 const li = document.createElement('li');
                                 li.innerHTML = `<strong>S ${link.surah}:${link.ayah} (${surahNames[link.surah-1]})</strong> ${link.notes ? `- <em>${link.notes}</em>` : ''}`;
                                 listEl.appendChild(li);
                             });
                         }
                         hideLoading();
                     }
                 };
                 request.onerror = () => { listEl.innerHTML = `<li>Error loading.</li>`; hideLoading(); };
             } catch (error) {
                 nameEl.textContent = 'Error'; listEl.innerHTML = `<li>Error: ${error.message}</li>`; hideLoading();
             }
         }


        // --- Root Word Analyzer Functions --- (Simplified: String Search)
         async function analyzeRoot() {
             if (!db) return;
             const rootInput = document.getElementById('root-input');
             const rootTerm = rootInput.value.trim();
             const analyzedRootTermElement = document.getElementById('analyzed-root-term');
             const occurrencesListElement = document.getElementById('root-occurrences-list');
             const rootDescriptionTextarea = document.getElementById('root-description');

             analyzedRootTermElement.textContent = rootTerm || 'N/A';
             occurrencesListElement.innerHTML = ''; // Clear previous results

             if (!rootTerm) {
                 setStatusMessage('root-status', 'Please enter an Arabic root word.', true);
                 return;
             }
             if (rootTerm.length < 2) {
                 setStatusMessage('root-status', 'Root term should be at least 2 characters.', true);
                 return;
             }

             showLoading(`Analyzing root "${rootTerm}"...`);
             try {
                 // Load existing notes for the root if available
                 const existingRootEntry = (await getAllData(STORE_ROOTS)).find(r => r.root === rootTerm);
                 rootDescriptionTextarea.value = existingRootEntry ? existingRootEntry.description : '';

                 const allAyahs = await getAllData(STORE_QURAN);
                 const foundOccurrences = [];

                 // Simplified normalization for comparison
                 const normalizeArabic = (text) => text.replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"")
                                                    .replace(/ؤ|و/g, "(و|ؤ)")
                                                    .replace(/ك|ک/g, "(ك|ک)")
                                                    .replace(/آ|ا|أ|إ/g, "(آ|ا|أ|إ)")
                                                    .replace(/ى|ی|ي/g, "(ى|ی|ي)")
                                                    .replace(/ہ|ھ|ة|ۃ|ه/g, "(ہ|ھ|ة|ۃ|ه)")
                                                    .replace(/ے/g, "(ے|ی)")
                                                    .replace(/م/g, "(مٰ|م)");

                 const normalizedRootTerm = normalizeArabic(rootTerm).replace(/ /g, '.{0,1}').replace(/-/g, '.{0,1}');
                 const searchRegex = new RegExp(normalizedRootTerm, 'i'); // 'i' for case-insensitive, though Arabic isn't truly case-sensitive this helps.

                 allAyahs.forEach(ayahData => {
                     const words = ayahData.arabic.split(/\s+/).filter(w => w.trim() !== '');
                     words.forEach(word => {
                         const normalizedWord = normalizeArabic(word);
                         if (searchRegex.test(normalizedWord)) {
                             foundOccurrences.push({
                                 surah: ayahData.surah,
                                 ayah: ayahData.ayah,
                                 word: word,
                                 context: ayahData.arabic
                             });
                         }
                     });
                 });

                 if (foundOccurrences.length === 0) {
                     occurrencesListElement.innerHTML = '<li>No occurrences found.</li>';
                     setStatusMessage('root-status', `No occurrences found for "${rootTerm}".`, false);
                 } else {
                     setStatusMessage('root-status', `Found ${foundOccurrences.length} occurrences for "${rootTerm}".`, false);
                     foundOccurrences.forEach(occ => {
                         const li = document.createElement('li');
                         li.innerHTML = `
                             <strong>Surah ${occ.surah}:${occ.ayah} (${surahNames[occ.surah-1]})</strong> - Word: <span lang="ar" dir="rtl" style="font-family: var(--font-arabic);">${occ.word}</span>
                             <div class="result-context" lang="ar" dir="rtl" style="font-family: var(--font-arabic);">${highlightMatch(occ.context, rootTerm)}</div>
                              <button data-surah="${occ.surah}" data-ayah="${occ.ayah}" class="go-to-ayah-btn" style="margin-top: 5px; padding: 3px 8px; font-size: 0.8rem;">Go to Ayah</button>
                         `;
                         occurrencesListElement.appendChild(li);
                     });
                     occurrencesListElement.querySelectorAll('.go-to-ayah-btn').forEach(button => {
                         button.addEventListener('click', handleGoToAyahFromSearch);
                     });
                 }

             } catch (error) {
                 console.error("Error analyzing root:", error);
                 setStatusMessage('root-status', 'Failed to analyze root.', true);
                 occurrencesListElement.innerHTML = `<li>Error analyzing root: ${error.message}</li>`;
             } finally {
                 hideLoading();
             }
        }

        async function saveRootNotes() {
             if (!db) return;
             const rootInput = document.getElementById('root-input');
             const descriptionInput = document.getElementById('root-description');
             const rootTerm = rootInput.value.trim();
             const description = descriptionInput.value.trim();

             if (!rootTerm) {
                 setStatusMessage('root-status', 'Enter root word to save notes.', true);
                 return;
             }
             showLoading("Saving root notes...");
             try {
                 const allRoots = await getAllData(STORE_ROOTS);
                 let existingRoot = allRoots.find(r => r.root === rootTerm);
                 if (existingRoot) {
                     existingRoot.description = description;
                     existingRoot.dateModified = new Date().toISOString();
                     await putData(STORE_ROOTS, existingRoot);
                     setStatusMessage('root-status', `Notes updated for "${rootTerm}".`, false);
                 } else {
                     await addData(STORE_ROOTS, { root: rootTerm, description: description, dateCreated: new Date().toISOString() });
                     setStatusMessage('root-status', `Root "${rootTerm}" and notes saved.`, false);
                 }
             } catch (error) {
                 setStatusMessage('root-status', 'Failed to save root notes.', true);
             } finally {
                 hideLoading();
             }
        }

        // --- Vocabulary Builder Functions ---
        async function loadVocabularyWords(filter = '') {
            if (!db) return;
            const listEl = document.getElementById('vocabulary-list');
            listEl.innerHTML = '';
            showLoading("Loading vocabulary...");
            try {
                const words = await getAllData(STORE_VOCABULARY);
                const filteredWords = filter ? words.filter(w => w.arabicWord.includes(filter) || w.customMeaning.toLowerCase().includes(filter.toLowerCase()) || w.notes.toLowerCase().includes(filter.toLowerCase())) : words;

                if (filteredWords.length === 0) {
                    listEl.innerHTML = '<li>No words added yet or matching filter.</li>'; hideLoading(); return;
                }
                filteredWords.sort((a, b) => a.arabicWord.localeCompare(b.arabicWord, 'ar'));
                for (const word of filteredWords) {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="vocab-details">
                            <strong class="arabic-word" lang="ar" dir="rtl">${word.arabicWord}</strong>
                            <p>Meaning: ${word.customMeaning}</p>
                            ${word.notes ? `<p>Notes: <em>${word.notes}</em></p>` : ''}
                            ${word.linkedAyah ? `<p>Linked Ayah: <a href="#" data-surah="${word.linkedAyah.surah}" data-ayah="${word.linkedAyah.ayah}" class="go-to-ayah-link">${word.linkedAyah.surah}:${word.linkedAyah.ayah} (${surahNames[word.linkedAyah.surah-1]})</a></p>` : ''}
                        </div>
                        <div class="vocab-actions">
                            <button data-id="${word.id}" class="edit-vocabulary-btn">Edit</button>
                            <button data-id="${word.id}" class="delete-vocabulary-btn">Delete</button>
                        </div>
                    `;
                    listEl.appendChild(li);
                }
                listEl.querySelectorAll('.edit-vocabulary-btn').forEach(b => b.addEventListener('click', handleEditVocabulary));
                listEl.querySelectorAll('.delete-vocabulary-btn').forEach(b => b.addEventListener('click', handleDeleteVocabulary));
                listEl.querySelectorAll('.go-to-ayah-link').forEach(link => {
                     link.addEventListener('click', (e) => {
                        e.preventDefault();
                        goToAyah(parseInt(e.target.dataset.surah), parseInt(e.target.dataset.ayah));
                    });
                });
            } catch (error) {
                listEl.innerHTML = `<li>Error: ${error.message}</li>`;
            } finally {
                hideLoading();
            }
            updateDashboard();
        }

        async function addVocabulary() {
            if (!db) return;
            const arabicWord = document.getElementById('vocab-arabic-word').value.trim();
            const meaning = document.getElementById('vocab-meaning').value.trim();
            const notes = document.getElementById('vocab-notes').value.trim();
            const linkedAyahRaw = document.getElementById('vocab-linked-ayah').value.trim();
            let linkedAyah = null;

            if (!arabicWord || !meaning) {
                setStatusMessage('vocabulary-status', 'Arabic word and meaning are required.', true);
                return;
            }

            if (linkedAyahRaw) {
                const parts = linkedAyahRaw.split(':');
                if (parts.length === 2) {
                    const s = parseInt(parts[0], 10);
                    const a = parseInt(parts[1], 10);
                    if (!isNaN(s) && !isNaN(a) && s > 0 && s <= 114 && a > 0 && a <= surahAyahCounts[s]) {
                        linkedAyah = { surah: s, ayah: a };
                    } else {
                        setStatusMessage('vocabulary-status', 'Invalid linked Ayah format (Surah:Ayah, e.g., 2:255).', true);
                        return;
                    }
                } else {
                    setStatusMessage('vocabulary-status', 'Invalid linked Ayah format (Surah:Ayah, e.g., 2:255).', true);
                    return;
                }
            }

            showLoading("Adding vocabulary word...");
            try {
                await addData(STORE_VOCABULARY, { arabicWord, customMeaning: meaning, notes, linkedAyah, dateAdded: new Date().toISOString() });
                setStatusMessage('vocabulary-status', 'Word added.', false);
                document.getElementById('vocab-arabic-word').value = '';
                document.getElementById('vocab-meaning').value = '';
                document.getElementById('vocab-notes').value = '';
                document.getElementById('vocab-linked-ayah').value = '';
                loadVocabularyWords();
            } catch (error) {
                setStatusMessage('vocabulary-status', 'Failed to add word.', true);
            } finally {
                hideLoading();
            }
        }

        async function handleEditVocabulary(event) {
            if (!db) return;
            const id = parseInt(event.target.dataset.id, 10);
            const word = await getData(STORE_VOCABULARY, id);
            if (!word) { setStatusMessage('vocabulary-status', 'Word not found.', true); return; }

            const newArabicWord = prompt("Edit Arabic Word:", word.arabicWord);
            if (newArabicWord === null || newArabicWord.trim() === '') return;

            const newMeaning = prompt("Edit Meaning:", word.customMeaning);
            if (newMeaning === null || newMeaning.trim() === '') return;

            const newNotes = prompt("Edit Notes:", word.notes || '');

            const newLinkedAyahRaw = prompt("Edit Linked Ayah (S:A or leave empty):", word.linkedAyah ? `${word.linkedAyah.surah}:${word.linkedAyah.ayah}` : '');
            let newLinkedAyah = null;
            if (newLinkedAyahRaw) {
                const parts = newLinkedAyahRaw.split(':');
                if (parts.length === 2) {
                    const s = parseInt(parts[0], 10);
                    const a = parseInt(parts[1], 10);
                    if (!isNaN(s) && !isNaN(a) && s > 0 && s <= 114 && a > 0 && a <= surahAyahCounts[s]) {
                        newLinkedAyah = { surah: s, ayah: a };
                    } else {
                        alert("Invalid linked Ayah format. Change not saved.");
                        return;
                    }
                } else {
                    alert("Invalid linked Ayah format. Change not saved.");
                    return;
                }
            }

            showLoading("Updating vocabulary word...");
            try {
                word.arabicWord = newArabicWord.trim();
                word.customMeaning = newMeaning.trim();
                word.notes = newNotes.trim();
                word.linkedAyah = newLinkedAyah;
                await putData(STORE_VOCABULARY, word);
                setStatusMessage('vocabulary-status', 'Word updated.', false);
                loadVocabularyWords();
            } catch (error) {
                setStatusMessage('vocabulary-status', 'Failed to update word.', true);
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteVocabulary(event) {
            if (!db) return;
            const id = parseInt(event.target.dataset.id, 10);
            if (isNaN(id) || !confirm("Delete this word?")) return;
            showLoading("Deleting vocabulary word...");
            try {
                await deleteData(STORE_VOCABULARY, id);
                setStatusMessage('vocabulary-status', 'Word deleted.', false);
                loadVocabularyWords();
            } catch (error) {
                setStatusMessage('vocabulary-status', 'Failed to delete word.', true);
            } finally {
                hideLoading();
            }
        }

        // --- Cross-Referencing Functions ---
        async function loadCrossReferences(filter = '') {
            if (!db) return;
            const listEl = document.getElementById('cross-ref-list');
            listEl.innerHTML = '';
            showLoading("Loading cross-references...");
            try {
                const refs = await getAllData(STORE_CROSS_REFERENCES);
                const filteredRefs = filter ? refs.filter(r => r.notes.toLowerCase().includes(filter.toLowerCase())) : refs;

                if (filteredRefs.length === 0) {
                    listEl.innerHTML = '<li>No cross-references added yet or matching filter.</li>'; hideLoading(); return;
                }
                filteredRefs.sort((a, b) => (a.fromSurah !== b.fromSurah) ? a.fromSurah - b.fromSurah : a.fromAyah - b.fromAyah);

                for (const ref of filteredRefs) {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="cross-ref-details">
                            <strong><a href="#" data-surah="${ref.fromSurah}" data-ayah="${ref.fromAyah}" class="go-to-ayah-link">${ref.fromSurah}:${ref.fromAyah} (${surahNames[ref.fromSurah-1]})</a></strong>
                            linked to
                            <strong><a href="#" data-surah="${ref.toSurah}" data-ayah="${ref.toAyah}" class="go-to-ayah-link">${ref.toSurah}:${ref.toAyah} (${surahNames[ref.toSurah-1]})</a></strong>
                            ${ref.notes ? `<p>Notes: <em>${ref.notes}</em></p>` : ''}
                        </div>
                        <div class="cross-ref-actions">
                            <button data-id="${ref.id}" class="delete-cross-ref-btn">Delete</button>
                        </div>
                    `;
                    listEl.appendChild(li);
                }
                listEl.querySelectorAll('.delete-cross-ref-btn').forEach(b => b.addEventListener('click', handleDeleteCrossReference));
                listEl.querySelectorAll('.go-to-ayah-link').forEach(link => {
                     link.addEventListener('click', (e) => {
                        e.preventDefault();
                        goToAyah(parseInt(e.target.dataset.surah), parseInt(e.target.dataset.ayah));
                    });
                });
            } catch (error) {
                listEl.innerHTML = `<li>Error: ${error.message}</li>`;
            } finally {
                hideLoading();
            }
        }

        async function addCrossReference() {
            if (!db) return;
            const fromAyahRef = document.getElementById('from-ayah-ref').value.trim();
            const toAyahRef = document.getElementById('to-ayah-ref').value.trim();
            const notes = document.getElementById('cross-ref-notes').value.trim();

            const parseAyahRef = (refString) => {
                const parts = refString.split(':');
                if (parts.length === 2) {
                    const s = parseInt(parts[0], 10);
                    const a = parseInt(parts[1], 10);
                    if (!isNaN(s) && !isNaN(a) && s > 0 && s <= 114 && a > 0 && a <= surahAyahCounts[s]) {
                        return { surah: s, ayah: a };
                    }
                }
                return null;
            };

            const fromAyah = parseAyahRef(fromAyahRef);
            const toAyah = parseAyahRef(toAyahRef);

            if (!fromAyah || !toAyah) {
                setStatusMessage('cross-ref-status', 'Invalid Ayah references. Use Surah:Ayah format (e.g., 2:255).', true);
                return;
            }
            if (fromAyah.surah === toAyah.surah && fromAyah.ayah === toAyah.ayah) {
                setStatusMessage('cross-ref-status', 'Cannot link an Ayah to itself.', true);
                return;
            }

            showLoading("Adding cross-reference...");
            try {
                await addData(STORE_CROSS_REFERENCES, {
                    fromSurah: fromAyah.surah,
                    fromAyah: fromAyah.ayah,
                    toSurah: toAyah.surah,
                    toAyah: toAyah.ayah,
                    notes,
                    dateLinked: new Date().toISOString()
                });
                setStatusMessage('cross-ref-status', 'Cross-reference added.', false);
                document.getElementById('from-ayah-ref').value = `${currentSurah}:${currentAyah}`; // Reset to current ayah for convenience
                document.getElementById('to-ayah-ref').value = '';
                document.getElementById('cross-ref-notes').value = '';
                loadCrossReferences();
                displayAyahCrossReferences(currentSurah, currentAyah);
            } catch (error) {
                setStatusMessage('cross-ref-status', 'Failed to add cross-reference.', true);
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteCrossReference(event) {
            if (!db) return;
            const id = parseInt(event.target.dataset.id, 10);
            if (isNaN(id) || !confirm("Delete this cross-reference?")) return;
            showLoading("Deleting cross-reference...");
            try {
                await deleteData(STORE_CROSS_REFERENCES, id);
                setStatusMessage('cross-ref-status', 'Cross-reference deleted.', false);
                loadCrossReferences();
                displayAyahCrossReferences(currentSurah, currentAyah);
            } catch (error) {
                setStatusMessage('cross-ref-status', 'Failed to delete cross-reference.', true);
            } finally {
                hideLoading();
            }
        }

        async function displayAyahCrossReferences(surah, ayah) {
            if (!db) return;
            const listEl = document.getElementById('ayah-cross-refs-list');
            listEl.innerHTML = '';
            try {
                const allRefs = await getAllData(STORE_CROSS_REFERENCES);
                const relatedRefs = allRefs.filter(ref =>
                    (ref.fromSurah === surah && ref.fromAyah === ayah) ||
                    (ref.toSurah === surah && ref.toAyah === ayah)
                );

                if (relatedRefs.length === 0) {
                    listEl.innerHTML = '<li>No cross-references for this Ayah.</li>';
                    return;
                }

                relatedRefs.sort((a, b) => { // Sort by source/destination Ayah
                    const aSource = a.fromSurah === surah && a.fromAyah === ayah ? `${a.toSurah}:${a.toAyah}` : `${a.fromSurah}:${a.fromAyah}`;
                    const bSource = b.fromSurah === surah && b.fromAyah === ayah ? `${b.toSurah}:${b.toAyah}` : `${b.fromSurah}:${b.fromAyah}`;
                    return aSource.localeCompare(bSource);
                });

                for (const ref of relatedRefs) {
                    const isFromCurrent = ref.fromSurah === surah && ref.fromAyah === ayah;
                    const linkedAyah = isFromCurrent ? { surah: ref.toSurah, ayah: ref.toAyah } : { surah: ref.fromSurah, ayah: ref.fromAyah };
                    const direction = isFromCurrent ? 'to' : 'from';

                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>Linked ${direction}:</strong>
                        <a href="#" data-surah="${linkedAyah.surah}" data-ayah="${linkedAyah.ayah}" class="go-to-ayah-link">${linkedAyah.surah}:${linkedAyah.ayah} (${surahNames[linkedAyah.surah-1]})</a>
                        ${ref.notes ? ` - <em>${ref.notes}</em>` : ''}
                        <button data-id="${ref.id}" class="delete-cross-ref-btn" style="margin-left: 10px;">Delete</button>
                    `;
                    listEl.appendChild(li);
                }
                listEl.querySelectorAll('.delete-cross-ref-btn').forEach(b => b.addEventListener('click', handleDeleteCrossReference));
                listEl.querySelectorAll('.go-to-ayah-link').forEach(link => {
                     link.addEventListener('click', (e) => {
                        e.preventDefault();
                        goToAyah(parseInt(e.target.dataset.surah), parseInt(e.target.dataset.ayah));
                    });
                });
            } catch (error) {
                listEl.innerHTML = `<li>Error loading cross-references: ${error.message}</li>`;
            }
        }


        // --- Recitation Log Functions ---
        async function loadRecitationLogs() {
             if (!db) return;
             const listEl = document.getElementById('recitations-list');
             listEl.innerHTML = '';
             showLoading("Loading recitation logs...");
             try {
                 const logs = await getAllData(STORE_RECITATIONS);
                 if (logs.length === 0) {
                     listEl.innerHTML = '<li>No entries logged yet.</li>'; hideLoading(); return;
                 }
                 logs.sort((a, b) => new Date(b.date) - new Date(a.date));
                 logs.forEach(log => {
                     const li = document.createElement('li');
                     const range = log.ayahStart && log.ayahEnd ? `Ayahs ${log.ayahStart}-${log.ayahEnd}` :
                                   log.ayahStart ? `Ayah ${log.ayahStart}` : 'Full Surah';
                     li.innerHTML = `
                         <strong>S ${log.surah} (${surahNames[log.surah-1]})</strong> - ${range} <br>
                         Qari: ${log.qari || 'N/A'} | Date: ${log.date || 'N/A'}
                         ${log.notes ? `<br>Notes: <em>${log.notes}</em>` : ''}
                         <div style="margin-top: 5px;">
                             <button data-id="${log.id}" class="delete-recitation-btn">Delete</button>
                             <button data-surah="${log.surah}" data-ayah="${log.ayahStart || 1}" class="go-to-ayah-btn">Go to Ayah</button>
                         </div>
                     `;
                     listEl.appendChild(li);
                 });
                 listEl.querySelectorAll('.delete-recitation-btn').forEach(b => b.addEventListener('click', handleDeleteRecitationLog));
                 listEl.querySelectorAll('.go-to-ayah-btn').forEach(button => {
                     button.addEventListener('click', (e) => goToAyah(parseInt(e.target.dataset.surah), parseInt(e.target.dataset.ayah)));
                 });
             } catch (error) {
                 listEl.innerHTML = `<li>Error: ${error.message}</li>`;
             } finally {
                 hideLoading();
             }
        }

        async function saveRecitationLog() {
            if (!db) return;
            const surah = parseInt(document.getElementById('rec-surah-select').value, 10);
            const ayahStart = document.getElementById('rec-ayah-start').value ? parseInt(document.getElementById('rec-ayah-start').value, 10) : null;
            const ayahEnd = document.getElementById('rec-ayah-end').value ? parseInt(document.getElementById('rec-ayah-end').value, 10) : null;
            const qari = document.getElementById('rec-qari').value.trim();
            const date = document.getElementById('rec-date').value;
            const notes = document.getElementById('rec-notes').value.trim();

            if (isNaN(surah)) { setStatusMessage('recitation-status', 'Select Surah.', true); return; }
            if (!date) { setStatusMessage('recitation-status', 'Select date.', true); return; }
            if (ayahStart && (isNaN(ayahStart) || ayahStart < 1 || ayahStart > surahAyahCounts[surah])) {
                setStatusMessage('recitation-status', `Invalid Ayah Start.`, true); return;
            }
            if (ayahEnd && (isNaN(ayahEnd) || ayahEnd < 1 || ayahEnd > surahAyahCounts[surah])) {
                setStatusMessage('recitation-status', `Invalid Ayah End.`, true); return;
            }
            if (ayahStart && ayahEnd && ayahStart > ayahEnd) {
                setStatusMessage('recitation-status', 'Start Ayah > End Ayah.', true); return;
            }

            showLoading("Saving recitation log...");
            try {
                await addData(STORE_RECITATIONS, { surah, ayahStart, ayahEnd, qari, date, notes, dateAdded: new Date().toISOString() });
                setStatusMessage('recitation-status', 'Log entry saved.', false);
                ['rec-ayah-start', 'rec-ayah-end', 'rec-qari', 'rec-date', 'rec-notes'].forEach(id => document.getElementById(id).value = '');
                loadRecitationLogs();
            } catch (error) {
                setStatusMessage('recitation-status', 'Failed to save log.', true);
            } finally {
                hideLoading();
            }
        }

         async function handleDeleteRecitationLog(event) {
             if (!db) return;
             const logId = parseInt(event.target.getAttribute('data-id'), 10);
             if (isNaN(logId) || !confirm("Delete this log entry?")) return;
             showLoading("Deleting log entry...");
             try {
                 await deleteData(STORE_RECITATIONS, logId);
                 setStatusMessage('recitation-status', 'Log entry deleted.', false);
                 loadRecitationLogs();
             } catch (error) {
                 setStatusMessage('recitation-status', 'Failed to delete log.', true);
             } finally {
                 hideLoading();
             }
         }

        // --- Memorization Hub Functions ---
        async function loadHifzForSurah(surah) {
             if (!db) return;
             const listEl = document.getElementById('hifz-ayahs-list');
             listEl.innerHTML = '';
             if (isNaN(surah) || surah < 1 || surah > 114) {
                 listEl.innerHTML = '<p class="text-center">Select a valid Surah.</p>'; return;
             }
             selectedHifzSurah = surah; // Update global state
             showLoading(`Loading Hifz for Surah ${surah}...`);
             try {
                 const totalAyahs = surahAyahCounts[surah];
                 const store = getObjectStore(STORE_HIFZ, 'readonly');
                 const request = store.getAll(IDBKeyRange.bound([surah, 1], [surah, totalAyahs]));
                 const hifzEntries = await new Promise(r => { request.onsuccess = () => r(request.result); });
                 const hifzMap = new Map(hifzEntries.map(e => [e.ayah, e]));

                 for (let i = 1; i <= totalAyahs; i++) {
                     const ayahData = hifzMap.get(i) || { surah, ayah: i, status: 'not-started', lastReviewDate: null, nextReviewDate: null, reviewCount: 0, notes: '' };
                     const li = document.createElement('div');
                     li.classList.add('ayah');
                     li.innerHTML = `
                         <div class="ayah-number">S ${surah}:${i}</div>
                         <div class="hifz-ayah-controls">
                             Status: <span class="hifz-ayah-status status-${ayahData.status}">${ayahData.status.replace('-', ' ')}</span>
                             ${ayahData.nextReviewDate ? ` | Next Review: ${ayahData.nextReviewDate}` : ''} <br>
                             <button data-surah="${surah}" data-ayah="${i}" data-status="in-progress" class="set-hifz-status-btn">In Progress</button>
                             <button data-surah="${surah}" data-ayah="${i}" data-status="memorized" class="set-hifz-status-btn">Memorized</button>
                             ${ayahData.status === 'memorized' ? `<button data-surah="${surah}" data-ayah="${i}" class="record-review-btn">Record Review</button>` : ''}
                             <button data-surah="${surah}" data-ayah="${i}" class="view-hifz-notes-btn">Notes</button>
                             <button data-surah="${surah}" data-ayah="${i}" class="go-to-ayah-btn">Go to Ayah</button>
                         </div>
                     `;
                     listEl.appendChild(li);
                 }
                 listEl.querySelectorAll('.set-hifz-status-btn').forEach(b => b.addEventListener('click', handleSetHifzStatus));
                 listEl.querySelectorAll('.record-review-btn').forEach(b => b.addEventListener('click', handleRecordReview));
                 listEl.querySelectorAll('.view-hifz-notes-btn').forEach(b => b.addEventListener('click', handleViewHifzNotes));
                 listEl.querySelectorAll('.go-to-ayah-btn').forEach(button => {
                     button.addEventListener('click', (e) => goToAyah(parseInt(e.target.dataset.surah), parseInt(e.target.dataset.ayah)));
                 });
             } catch (error) {
                 listEl.innerHTML = `<li>Error: ${error.message}</li>`;
             } finally {
                 hideLoading();
             }
             updateDashboard();
        }

        async function handleSetHifzStatus(event) {
             if (!db) return;
             const surah = parseInt(event.target.getAttribute('data-surah'), 10);
             const ayah = parseInt(event.target.getAttribute('data-ayah'), 10);
             const status = event.target.getAttribute('data-status');
             showLoading(`Setting status for ${surah}:${ayah}...`);
             try {
                 const existing = await getData(STORE_HIFZ, [surah, ayah]) || { surah, ayah, status: 'not-started', lastReviewDate: null, nextReviewDate: null, reviewCount: 0, notes: '', dateModified: new Date().toISOString() };
                 existing.status = status;
                 if (status !== 'memorized') {
                     existing.lastReviewDate = null; existing.nextReviewDate = null; existing.reviewCount = 0;
                 } else if (!existing.lastReviewDate) { // Only set initial review date if not already set (e.g. first time memorized)
                     existing.lastReviewDate = new Date().toISOString().split('T')[0];
                     existing.reviewCount = 0;
                     existing.nextReviewDate = calculateNextReview(existing.lastReviewDate, existing.reviewCount);
                 }
                 existing.dateModified = new Date().toISOString();
                 await putData(STORE_HIFZ, existing);
                 setStatusMessage('hifz-status', `Status updated for ${surah}:${ayah}.`, false);
                 loadHifzForSurah(surah);
             } catch (error) {
                 setStatusMessage('hifz-status', 'Failed to update status.', true);
             } finally {
                 hideLoading();
             }
        }

        async function handleRecordReview(event) {
             if (!db) return;
             const surah = parseInt(event.target.getAttribute('data-surah'), 10);
             const ayah = parseInt(event.target.getAttribute('data-ayah'), 10);
             showLoading(`Recording review for ${surah}:${ayah}...`);
             try {
                 const existing = await getData(STORE_HIFZ, [surah, ayah]);
                 if (!existing || existing.status !== 'memorized') {
                     setStatusMessage('hifz-status', 'Ayah not memorized or status not set.', true); hideLoading(); return;
                 }
                 existing.lastReviewDate = new Date().toISOString().split('T')[0];
                 existing.reviewCount = (existing.reviewCount || 0) + 1;
                 existing.nextReviewDate = calculateNextReview(existing.lastReviewDate, existing.reviewCount);
                 existing.dateModified = new Date().toISOString();
                 await putData(STORE_HIFZ, existing);
                 setStatusMessage('hifz-status', `Review recorded. Next: ${existing.nextReviewDate}`, false);
                 loadHifzForSurah(surah);
             } catch (error) {
                 setStatusMessage('hifz-status', 'Failed to record review.', true);
             } finally {
                 hideLoading();
             }
        }

        function calculateNextReview(lastReviewDate, reviewCount) {
            const date = new Date(lastReviewDate);
            let daysToAdd = [1, 3, 7, 15, 30, 60, 90, 180, 365, 730][Math.min(reviewCount, 9)] || 1095; // Extend spaced repetition intervals
            date.setDate(date.getDate() + daysToAdd);
            return date.toISOString().split('T')[0];
        }

         async function handleViewHifzNotes(event) {
             if (!db) return;
             const surah = parseInt(event.target.getAttribute('data-surah'), 10);
             const ayah = parseInt(event.target.getAttribute('data-ayah'), 10);

             const hifzNotesModal = document.getElementById('hifzNotesModal');
             const modalAyahRef = document.getElementById('modal-hifz-ayah-ref');
             const modalNotesTextarea = document.getElementById('modal-hifz-notes-textarea');
             const saveModalHifzNotesBtn = document.getElementById('save-modal-hifz-notes-btn');

             modalAyahRef.textContent = `Surah ${surah}:${ayah}`;
             modalNotesTextarea.value = ''; // Clear previous content

             showLoading(`Loading notes for ${surah}:${ayah}...`);
             try {
                 const existing = await getData(STORE_HIFZ, [surah, ayah]) || { surah, ayah, status: 'not-started', notes: '' };
                 modalNotesTextarea.value = existing.notes || '';
                 hifzNotesModal.setAttribute('data-surah', surah);
                 hifzNotesModal.setAttribute('data-ayah', ayah);

                 saveModalHifzNotesBtn.onclick = async () => {
                     const newNotes = modalNotesTextarea.value.trim();
                     if (newNotes !== (existing.notes || '')) {
                         existing.notes = newNotes;
                         existing.dateModified = new Date().toISOString();
                         await putData(STORE_HIFZ, existing);
                         setStatusMessage('hifz-modal-status', 'Notes updated.', false);
                         // Don't close immediately, let user see status
                         // Optionally close after a delay: setTimeout(() => hifzNotesModal.style.display = 'none', 1000);
                     } else {
                         setStatusMessage('hifz-modal-status', 'Notes unchanged.', false);
                     }
                 };

                 hifzNotesModal.style.display = 'flex';
                 modalNotesTextarea.focus();
             } catch (error) {
                 setStatusMessage('hifz-status', 'Failed to load/save notes.', true);
             } finally {
                 hideLoading();
             }
         }


        // --- Dhikr & Dua Builder Functions ---
        async function loadDhikrDuas(filter = '') {
            if (!db) return;
            const listEl = document.getElementById('dhikr-dua-list');
            listEl.innerHTML = '';
            showLoading("Loading Dhikr & Duas...");
            try {
                const entries = await getAllData(STORE_DHIKR_DUA);
                const filteredEntries = filter ? entries.filter(e =>
                    e.arabicText.toLowerCase().includes(filter.toLowerCase()) ||
                    e.translation.toLowerCase().includes(filter.toLowerCase()) ||
                    e.notes.toLowerCase().includes(filter.toLowerCase()) ||
                    e.category.toLowerCase().includes(filter.toLowerCase())
                ) : entries;

                if (filteredEntries.length === 0) {
                    listEl.innerHTML = '<li>No Dhikr or Duas added yet or matching filter.</li>'; hideLoading(); return;
                }
                filteredEntries.sort((a, b) => a.category.localeCompare(b.category) || a.arabicText.localeCompare(b.arabicText, 'ar'));

                for (const entry of filteredEntries) {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="dhikr-dua-details">
                            <strong>${entry.category || 'Uncategorized'}</strong>
                            <p class="arabic-text" lang="ar" dir="rtl">${entry.arabicText}</p>
                            <p>Translation: ${entry.translation}</p>
                            ${entry.notes ? `<p>Notes: <em>${entry.notes}</em></p>` : ''}
                            <div class="dhikr-dua-counter">
                                Count: <span id="dhikr-count-${entry.id}">${entry.count || 0}</span>
                                <button data-id="${entry.id}" class="increment-dhikr-btn">+</button>
                                <button data-id="${entry.id}" class="reset-dhikr-btn">Reset</button>
                            </div>
                        </div>
                        <div class="dhikr-dua-actions">
                            <button data-id="${entry.id}" class="edit-dhikr-dua-btn">Edit</button>
                            <button data-id="${entry.id}" class="delete-dhikr-dua-btn">Delete</button>
                        </div>
                    `;
                    listEl.appendChild(li);
                }
                listEl.querySelectorAll('.increment-dhikr-btn').forEach(b => b.addEventListener('click', handleIncrementDhikrCount));
                listEl.querySelectorAll('.reset-dhikr-btn').forEach(b => b.addEventListener('click', handleResetDhikrCount));
                listEl.querySelectorAll('.edit-dhikr-dua-btn').forEach(b => b.addEventListener('click', handleEditDhikrDua));
                listEl.querySelectorAll('.delete-dhikr-dua-btn').forEach(b => b.addEventListener('click', handleDeleteDhikrDua));
            } catch (error) {
                listEl.innerHTML = `<li>Error: ${error.message}</li>`;
            } finally {
                hideLoading();
            }
        }

        async function addDhikrDua() {
            if (!db) return;
            const arabicText = document.getElementById('dhikr-dua-arabic').value.trim();
            const translation = document.getElementById('dhikr-dua-translation').value.trim();
            const notes = document.getElementById('dhikr-dua-notes').value.trim();
            const category = document.getElementById('dhikr-dua-category').value.trim();

            if (!arabicText || !translation) {
                setStatusMessage('dhikr-dua-status', 'Arabic text and translation are required.', true);
                return;
            }

            showLoading("Adding Dhikr/Dua...");
            try {
                await addData(STORE_DHIKR_DUA, { arabicText, translation, notes, category, count: 0, dateAdded: new Date().toISOString() });
                setStatusMessage('dhikr-dua-status', 'Dhikr/Dua added.', false);
                document.getElementById('dhikr-dua-arabic').value = '';
                document.getElementById('dhikr-dua-translation').value = '';
                document.getElementById('dhikr-dua-notes').value = '';
                document.getElementById('dhikr-dua-category').value = '';
                loadDhikrDuas();
            } catch (error) {
                setStatusMessage('dhikr-dua-status', 'Failed to add Dhikr/Dua.', true);
            } finally {
                hideLoading();
            }
        }

        async function handleIncrementDhikrCount(event) {
            if (!db) return;
            const id = parseInt(event.target.dataset.id, 10);
            showLoading("Updating count...");
            try {
                const entry = await getData(STORE_DHIKR_DUA, id);
                if (entry) {
                    entry.count = (entry.count || 0) + 1;
                    await putData(STORE_DHIKR_DUA, entry);
                    document.getElementById(`dhikr-count-${id}`).textContent = entry.count;
                    setStatusMessage('dhikr-dua-status', 'Count updated.', false);
                }
            } catch (error) {
                setStatusMessage('dhikr-dua-status', 'Failed to update count.', true);
            } finally {
                hideLoading();
            }
        }

        async function handleResetDhikrCount(event) {
            if (!db) return;
            const id = parseInt(event.target.dataset.id, 10);
            if (!confirm("Reset count to 0?")) return;
            showLoading("Resetting count...");
            try {
                const entry = await getData(STORE_DHIKR_DUA, id);
                if (entry) {
                    entry.count = 0;
                    await putData(STORE_DHIKR_DUA, entry);
                    document.getElementById(`dhikr-count-${id}`).textContent = 0;
                    setStatusMessage('dhikr-dua-status', 'Count reset.', false);
                }
            } catch (error) {
                setStatusMessage('dhikr-dua-status', 'Failed to reset count.', true);
            } finally {
                hideLoading();
            }
        }

        async function handleEditDhikrDua(event) {
            if (!db) return;
            const id = parseInt(event.target.dataset.id, 10);
            const entry = await getData(STORE_DHIKR_DUA, id);
            if (!entry) { setStatusMessage('dhikr-dua-status', 'Entry not found.', true); return; }

            const newArabicText = prompt("Edit Arabic Text:", entry.arabicText);
            if (newArabicText === null || newArabicText.trim() === '') return;

            const newTranslation = prompt("Edit Translation:", entry.translation);
            if (newTranslation === null || newTranslation.trim() === '') return;

            const newNotes = prompt("Edit Notes:", entry.notes || '');
            const newCategory = prompt("Edit Category:", entry.category || '');

            showLoading("Updating Dhikr/Dua...");
            try {
                entry.arabicText = newArabicText.trim();
                entry.translation = newTranslation.trim();
                entry.notes = newNotes.trim();
                entry.category = newCategory.trim();
                await putData(STORE_DHIKR_DUA, entry);
                setStatusMessage('dhikr-dua-status', 'Dhikr/Dua updated.', false);
                loadDhikrDuas();
            } catch (error) {
                setStatusMessage('dhikr-dua-status', 'Failed to update Dhikr/Dua.', true);
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteDhikrDua(event) {
            if (!db) return;
            const id = parseInt(event.target.dataset.id, 10);
            if (isNaN(id) || !confirm("Delete this Dhikr/Dua entry?")) return;
            showLoading("Deleting Dhikr/Dua...");
            try {
                await deleteData(STORE_DHIKR_DUA, id);
                setStatusMessage('dhikr-dua-status', 'Dhikr/Dua deleted.', false);
                loadDhikrDuas();
            } catch (error) {
                setStatusMessage('dhikr-dua-status', 'Failed to delete Dhikr/Dua.', true);
            } finally {
                hideLoading();
            }
        }

        // --- Hadith Linker Functions ---
        async function loadHadithLinks(filter = '') {
            if (!db) return;
            const listEl = document.getElementById('hadith-list');
            listEl.innerHTML = '';
            showLoading("Loading Hadith links...");
            try {
                const hadiths = await getAllData(STORE_HADITH_LINKS);
                const filteredHadiths = filter ? hadiths.filter(h =>
                    h.hadithText.toLowerCase().includes(filter.toLowerCase()) ||
                    h.source.toLowerCase().includes(filter.toLowerCase()) ||
                    h.notes.toLowerCase().includes(filter.toLowerCase())
                ) : hadiths;

                if (filteredHadiths.length === 0) {
                    listEl.innerHTML = '<li>No Hadith entries added yet or matching filter.</li>'; hideLoading(); return;
                }
                filteredHadiths.sort((a, b) => a.source.localeCompare(b.source));

                for (const hadith of filteredHadiths) {
                    const li = document.createElement('li');
                    let linkedAyahHtml = '';
                    if (hadith.linkedSurah && hadith.linkedAyah) {
                        linkedAyahHtml = `<p>Linked Ayah: <a href="#" data-surah="${hadith.linkedSurah}" data-ayah="${hadith.linkedAyah}" class="go-to-ayah-link">${hadith.linkedSurah}:${hadith.linkedAyah} (${surahNames[hadith.linkedSurah-1]})</a></p>`;
                    }
                    li.innerHTML = `
                        <div class="hadith-details">
                            <strong lang="ar" dir="rtl">${hadith.hadithText}</strong>
                            <p>Source: ${hadith.source}</p>
                            ${hadith.notes ? `<p>Notes: <em>${hadith.notes}</em></p>` : ''}
                            ${linkedAyahHtml}
                        </div>
                        <div class="hadith-actions">
                            <button data-id="${hadith.id}" class="edit-hadith-btn">Edit</button>
                            <button data-id="${hadith.id}" class="delete-hadith-btn">Delete</button>
                        </div>
                    `;
                    listEl.appendChild(li);
                }
                listEl.querySelectorAll('.edit-hadith-btn').forEach(b => b.addEventListener('click', handleEditHadithLink));
                listEl.querySelectorAll('.delete-hadith-btn').forEach(b => b.addEventListener('click', handleDeleteHadithLink));
                listEl.querySelectorAll('.go-to-ayah-link').forEach(link => {
                     link.addEventListener('click', (e) => {
                        e.preventDefault();
                        goToAyah(parseInt(e.target.dataset.surah), parseInt(e.target.dataset.ayah));
                    });
                });
            } catch (error) {
                listEl.innerHTML = `<li>Error: ${error.message}</li>`;
            } finally {
                hideLoading();
            }
        }

        async function addHadithLink() {
            if (!db) return;
            const hadithText = document.getElementById('hadith-text').value.trim();
            const source = document.getElementById('hadith-source').value.trim();
            const notes = document.getElementById('hadith-notes').value.trim();
            const linkedAyahRaw = document.getElementById('hadith-linked-ayah').value.trim();
            let linkedSurah = null;
            let linkedAyah = null;

            if (!hadithText || !source) {
                setStatusMessage('hadith-linker-status', 'Hadith text and source are required.', true);
                return;
            }

            if (linkedAyahRaw) {
                const parts = linkedAyahRaw.split(':');
                if (parts.length === 2) {
                    const s = parseInt(parts[0], 10);
                    const a = parseInt(parts[1], 10);
                    if (!isNaN(s) && !isNaN(a) && s > 0 && s <= 114 && a > 0 && a <= surahAyahCounts[s]) {
                        linkedSurah = s;
                        linkedAyah = a;
                    } else {
                        setStatusMessage('hadith-linker-status', 'Invalid linked Ayah format (Surah:Ayah, e.g., 2:255).', true);
                        return;
                    }
                } else {
                    setStatusMessage('hadith-linker-status', 'Invalid linked Ayah format (Surah:Ayah, e.g., 2:255).', true);
                    return;
                }
            }

            showLoading("Adding Hadith...");
            try {
                await addData(STORE_HADITH_LINKS, { hadithText, source, notes, linkedSurah, linkedAyah, dateAdded: new Date().toISOString() });
                setStatusMessage('hadith-linker-status', 'Hadith added.', false);
                document.getElementById('hadith-text').value = '';
                document.getElementById('hadith-source').value = '';
                document.getElementById('hadith-notes').value = '';
                document.getElementById('hadith-linked-ayah').value = '';
                loadHadithLinks();
            } catch (error) {
                setStatusMessage('hadith-linker-status', 'Failed to add Hadith.', true);
            } finally {
                hideLoading();
            }
        }

        async function handleEditHadithLink(event) {
            if (!db) return;
            const id = parseInt(event.target.dataset.id, 10);
            const hadith = await getData(STORE_HADITH_LINKS, id);
            if (!hadith) { setStatusMessage('hadith-linker-status', 'Hadith not found.', true); return; }

            const newHadithText = prompt("Edit Hadith Text:", hadith.hadithText);
            if (newHadithText === null || newHadithText.trim() === '') return;

            const newSource = prompt("Edit Source:", hadith.source);
            if (newSource === null || newSource.trim() === '') return;

            const newNotes = prompt("Edit Notes:", hadith.notes || '');

            const newLinkedAyahRaw = prompt("Edit Linked Ayah (S:A or leave empty):", hadith.linkedSurah && hadith.linkedAyah ? `${hadith.linkedSurah}:${hadith.linkedAyah}` : '');
            let newLinkedSurah = null;
            let newLinkedAyah = null;
            if (newLinkedAyahRaw) {
                const parts = newLinkedAyahRaw.split(':');
                if (parts.length === 2) {
                    const s = parseInt(parts[0], 10);
                    const a = parseInt(parts[1], 10);
                    if (!isNaN(s) && !isNaN(a) && s > 0 && s <= 114 && a > 0 && a <= surahAyahCounts[s]) {
                        newLinkedSurah = s;
                        newLinkedAyah = a;
                    } else {
                        alert("Invalid linked Ayah format. Change not saved.");
                        return;
                    }
                } else {
                    alert("Invalid linked Ayah format. Change not saved.");
                    return;
                }
            }

            showLoading("Updating Hadith...");
            try {
                hadith.hadithText = newHadithText.trim();
                hadith.source = newSource.trim();
                hadith.notes = newNotes.trim();
                hadith.linkedSurah = newLinkedSurah;
                hadith.linkedAyah = newLinkedAyah;
                await putData(STORE_HADITH_LINKS, hadith);
                setStatusMessage('hadith-linker-status', 'Hadith updated.', false);
                loadHadithLinks();
            } catch (error) {
                setStatusMessage('hadith-linker-status', 'Failed to update Hadith.', true);
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteHadithLink(event) {
            if (!db) return;
            const id = parseInt(event.target.dataset.id, 10);
            if (isNaN(id) || !confirm("Delete this Hadith entry?")) return;
            showLoading("Deleting Hadith...");
            try {
                await deleteData(STORE_HADITH_LINKS, id);
                setStatusMessage('hadith-linker-status', 'Hadith deleted.', false);
                loadHadithLinks();
            } catch (error) {
                setStatusMessage('hadith-linker-status', 'Failed to delete Hadith.', true);
            } finally {
                hideLoading();
            }
        }

        async function displayLinkedHadithForAyah(surah, ayah) {
             if (!db) return;
             // Add a new display area for linked Hadith below Ayah translation in Quran Viewer
             let hadithDisplayArea = document.getElementById('linked-hadith-display');
             if (!hadithDisplayArea) {
                 hadithDisplayArea = document.createElement('div');
                 hadithDisplayArea.id = 'linked-hadith-display';
                 hadithDisplayArea.classList.add('mt-20');
                 document.getElementById('quran-display').after(hadithDisplayArea); // Append after quran display
             }
             hadithDisplayArea.innerHTML = `<h3>Linked Hadith:</h3><ul id="ayah-linked-hadith-list"></ul>`;
             const listEl = document.getElementById('ayah-linked-hadith-list');
             listEl.innerHTML = '<li>No Hadith linked to this Ayah.</li>'; // Default message

             try {
                 const allHadith = await getAllData(STORE_HADITH_LINKS);
                 const linkedHadith = allHadith.filter(h => h.linkedSurah === surah && h.linkedAyah === ayah);

                 if (linkedHadith.length > 0) {
                     listEl.innerHTML = '';
                     linkedHadith.forEach(hadith => {
                         const li = document.createElement('li');
                         li.innerHTML = `
                            <strong lang="ar" dir="rtl">${hadith.hadithText}</strong>
                            <p>Source: ${hadith.source}</p>
                            ${hadith.notes ? `<p>Notes: <em>${hadith.notes}</em></p>` : ''}
                            <button data-id="${hadith.id}" class="delete-hadith-btn" style="margin-left: 10px; padding: 3px 8px; font-size: 0.8rem;">Unlink</button>
                         `;
                         listEl.appendChild(li);
                     });
                     listEl.querySelectorAll('.delete-hadith-btn').forEach(b => b.addEventListener('click', handleDeleteHadithLink));
                 }
             } catch (error) {
                 console.error("Error loading linked Hadith:", error);
                 listEl.innerHTML = `<li>Error loading linked Hadith.</li>`;
             }
        }


        // --- Bookmarks Functions ---
        async function toggleBookmark(surah, ayah) {
            if (!db) return;
            showLoading("Updating bookmark...");
            try {
                const existing = await getData(STORE_BOOKMARKS, [surah, ayah]);
                const bookmarkIcon = document.querySelector(`.ayah[data-surah="${surah}"][data-ayah="${ayah}"] .bookmark-icon`);
                if (existing) {
                    await deleteData(STORE_BOOKMARKS, [surah, ayah]);
                    if (bookmarkIcon) {
                        bookmarkIcon.textContent = 'bookmark_border';
                        bookmarkIcon.classList.remove('bookmarked');
                        bookmarkIcon.setAttribute('aria-label', 'Add Bookmark');
                    }
                    setStatusMessage('quran-status', `Bookmark removed for ${surah}:${ayah}.`, false);
                } else {
                    await putData(STORE_BOOKMARKS, { surah, ayah, dateAdded: new Date().toISOString() });
                    if (bookmarkIcon) {
                        bookmarkIcon.textContent = 'bookmark';
                        bookmarkIcon.classList.add('bookmarked');
                        bookmarkIcon.setAttribute('aria-label', 'Remove Bookmark');
                    }
                    setStatusMessage('quran-status', `Bookmark added for ${surah}:${ayah}.`, false);
                }
            } catch (error) {
                setStatusMessage('quran-status', 'Failed to update bookmark.', true);
            } finally {
                hideLoading();
                loadBookmarks(); // Refresh bookmarks list if on that section
            }
        }

        async function loadBookmarks(filter = '') {
            if (!db) return;
            const listEl = document.getElementById('bookmarks-list');
            listEl.innerHTML = '';
            showLoading("Loading bookmarks...");
            try {
                const bookmarks = await getAllData(STORE_BOOKMARKS);
                const filteredBookmarks = filter ? bookmarks.filter(b => `${b.surah}:${b.ayah}`.includes(filter) || surahNames[b.surah-1].toLowerCase().includes(filter.toLowerCase())) : bookmarks;

                if (filteredBookmarks.length === 0) {
                    listEl.innerHTML = '<li>No bookmarks added yet or matching filter.</li>'; hideLoading(); return;
                }
                filteredBookmarks.sort((a, b) => (a.surah !== b.surah) ? a.surah - b.surah : a.ayah - b.ayah);

                for (const bookmark of filteredBookmarks) {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="bookmark-details">
                            <strong>Surah ${bookmark.surah}:${bookmark.ayah} (${surahNames[bookmark.surah-1]})</strong>
                            <p>Added on: ${new Date(bookmark.dateAdded).toLocaleDateString()}</p>
                        </div>
                        <div class="bookmark-actions">
                            <button data-surah="${bookmark.surah}" data-ayah="${bookmark.ayah}" class="go-to-ayah-btn">Go to Ayah</button>
                            <button data-surah="${bookmark.surah}" data-ayah="${bookmark.ayah}" class="remove-bookmark-btn">Remove</button>
                        </div>
                    `;
                    listEl.appendChild(li);
                }
                listEl.querySelectorAll('.go-to-ayah-btn').forEach(b => b.addEventListener('click', (e) => goToAyah(parseInt(e.target.dataset.surah), parseInt(e.target.dataset.ayah))));
                listEl.querySelectorAll('.remove-bookmark-btn').forEach(b => b.addEventListener('click', (e) => toggleBookmark(parseInt(e.target.dataset.surah), parseInt(e.target.dataset.ayah))));
            } catch (error) {
                listEl.innerHTML = `<li>Error: ${error.message}</li>`;
            } finally {
                hideLoading();
            }
        }


        // --- Advanced Search Functions ---
         async function performSearch() {
             if (!db) return;
             const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();
             const searchScopes = Array.from(document.querySelectorAll('.search-scope:checked')).map(cb => cb.value);
             const searchResultsList = document.getElementById('search-results-list');
             searchResultsList.innerHTML = '';

             if (!searchTerm) {
                 setStatusMessage('search-status', 'Please enter a search term.', true);
                 return;
             }
             if (searchScopes.length === 0) {
                 setStatusMessage('search-status', 'Please select at least one search scope.', true);
                 return;
             }

             showLoading(`Searching for "${searchTerm}"...`);
             try {
                 const results = [];
                 const normalizeArabicSearch = (text) => text.replace(/[ًٌٍََُِِّْٰٓۡٔؒ]/g,"")
                                                           .replace(/ؤ|و/g, "(و|ؤ)")
                                                           .replace(/ك|ک/g, "(ك|ک)")
                                                           .replace(/آ|ا|أ|إ/g, "(آ|ا|أ|إ)")
                                                           .replace(/ى|ی|ي/g, "(ى|ی|ي)")
                                                           .replace(/ہ|ھ|ة|ۃ|ه/g, "(ہ|ھ|ة|ۃ|ه)")
                                                           .replace(/ے/g, "(ے|ی)")
                                                           .replace(/م/g, "(مٰ|م)");
                 const normalizedSearchTerm = normalizeArabicSearch(searchTerm);

                 // Search Quran text and translation
                 if (searchScopes.includes('quran-arabic') || searchScopes.includes('quran-translation')) {
                     const allAyahs = await getAllData(STORE_QURAN);
                     allAyahs.forEach(ayah => {
                         const matchArabic = searchScopes.includes('quran-arabic') && normalizeArabicSearch(ayah.arabic).includes(normalizedSearchTerm);

                         let matchTranslation = false;
                         let translationSource = '';
                         let allTranslationsContext = [];

                         if (searchScopes.includes('quran-translation')) {
                             for (const langKey in TRANSLATION_CONFIG) {
                                 if (ayah[langKey] && ayah[langKey].toLowerCase().includes(searchTerm)) {
                                     matchTranslation = true;
                                     translationSource = TRANSLATION_CONFIG[langKey].label;
                                 }
                                 if (ayah[langKey]) {
                                     allTranslationsContext.push(`${TRANSLATION_CONFIG[langKey].label}: ${ayah[langKey]}`);
                                 }
                             }
                         }

                         if (matchArabic || matchTranslation) {
                             results.push({
                                 type: 'Quran',
                                 ref: `Surah ${ayah.surah}:${ayah.ayah} (${surahNames[ayah.surah-1]})`,
                                 surah: ayah.surah,
                                 ayah: ayah.ayah,
                                 context: `${ayah.arabic} - ${allTranslationsContext.join(' - ')}`,
                                 source: matchArabic && matchTranslation ? `Arabic & Translation (${translationSource})` : matchArabic ? 'Arabic' : `Translation (${translationSource})`
                             });
                         }
                     });
                 }

                 // Search Personal Tafsir
                 if (searchScopes.includes('tafsir')) {
                     const allTafsir = await getAllData(STORE_TAFSIR);
                     allTafsir.forEach(tafsir => {
                         if (tafsir.notes && tafsir.notes.toLowerCase().includes(searchTerm)) {
                             results.push({
                                 type: 'Tafsir',
                                 ref: `Surah ${tafsir.surah}:${tafsir.ayah} (${surahNames[tafsir.surah-1]})`,
                                 surah: tafsir.surah,
                                 ayah: tafsir.ayah,
                                 context: tafsir.notes,
                                 source: 'Personal Tafsir'
                             });
                         }
                     });
                 }

                 // Search Theme Notes
                 if (searchScopes.includes('themes')) {
                     const allThemes = await getAllData(STORE_THEMES);
                     allThemes.forEach(theme => {
                         if (theme.description && theme.description.toLowerCase().includes(searchTerm)) {
                              results.push({
                                 type: 'Theme',
                                 ref: `Theme: ${theme.name}`,
                                 context: theme.description,
                                 source: 'Theme Description'
                             });
                         }
                     });
                     const allThemeAyahLinks = await getAllData(STORE_THEME_AYAHS);
                     const themesMap = new Map((await getAllData(STORE_THEMES)).map(t => [t.id, t.name]));
                     allThemeAyahLinks.forEach(link => {
                         if (link.notes && link.notes.toLowerCase().includes(searchTerm)) {
                              results.push({
                                 type: 'Theme Link',
                                 ref: `Surah ${link.surah}:${link.ayah} (Theme: ${themesMap.get(link.themeId) || 'Unknown'})`,
                                 surah: link.surah,
                                 ayah: link.ayah,
                                 context: link.notes,
                                 source: 'Theme Link Notes'
                             });
                         }
                     });
                 }

                 // Search Root Notes
                 if (searchScopes.includes('roots')) {
                     const allRoots = await getAllData(STORE_ROOTS);
                     allRoots.forEach(root => {
                         if (root.root.toLowerCase().includes(searchTerm) || (root.description && root.description.toLowerCase().includes(searchTerm))) {
                             results.push({
                                 type: 'Root',
                                 ref: `Root: ${root.root}`,
                                 context: root.description,
                                 source: 'Root Notes'
                             });
                         }
                     });
                 }

                 // Search Recitation Notes
                 if (searchScopes.includes('recitation')) {
                     const allRecitations = await getAllData(STORE_RECITATIONS);
                     allRecitations.forEach(log => {
                         if (log.notes && log.notes.toLowerCase().includes(searchTerm)) {
                              const range = log.ayahStart && log.ayahEnd ? `${log.ayahStart}-${log.ayahEnd}` :
                                   log.ayahStart ? `${log.ayahStart}` :
                                   log.ayahEnd ? `Up to ${log.ayahEnd}` : 'Full Surah';
                             results.push({
                                 type: 'Recitation Log',
                                 ref: `Surah ${log.surah} (${surahNames[log.surah-1]}) ${range ? ` (${range})` : ''}`,
                                 context: log.notes,
                                 source: 'Recitation Notes'
                             });
                         }
                     });
                 }

                 // Search Hifz Notes
                 if (searchScopes.includes('hifz')) {
                     const allHifz = await getAllData(STORE_HIFZ);
                     allHifz.forEach(hifz => {
                         if (hifz.notes && hifz.notes.toLowerCase().includes(searchTerm)) {
                             results.push({
                                 type: 'Hifz',
                                 ref: `Surah ${hifz.surah}:${hifz.ayah} (${surahNames[hifz.surah-1]})`,
                                  surah: hifz.surah,
                                  ayah: hifz.ayah,
                                 context: hifz.notes,
                                 source: 'Hifz Notes'
                             });
                         }
                     });
                 }

                 // Search Vocabulary Notes
                 if (searchScopes.includes('vocabulary')) {
                     const allVocab = await getAllData(STORE_VOCABULARY);
                     allVocab.forEach(vocab => {
                         if (vocab.arabicWord.toLowerCase().includes(searchTerm) || vocab.customMeaning.toLowerCase().includes(searchTerm) || (vocab.notes && vocab.notes.toLowerCase().includes(searchTerm))) {
                             results.push({
                                 type: 'Vocabulary',
                                 ref: `Word: ${vocab.arabicWord}`,
                                 context: `${vocab.customMeaning} ${vocab.notes ? `- ${vocab.notes}` : ''}`,
                                 source: 'Vocabulary Builder'
                             });
                         }
                     });
                 }

                 // Search Cross-Reference Notes
                 if (searchScopes.includes('cross-refs')) {
                     const allCrossRefs = await getAllData(STORE_CROSS_REFERENCES);
                     allCrossRefs.forEach(ref => {
                         if (ref.notes && ref.notes.toLowerCase().includes(searchTerm)) {
                             results.push({
                                 type: 'Cross-Reference',
                                 ref: `From ${ref.fromSurah}:${ref.fromAyah} to ${ref.toSurah}:${ref.toAyah}`,
                                 context: ref.notes,
                                 source: 'Cross-Referencing'
                             });
                         }
                     });
                 }

                 // Search Dhikr/Dua Notes
                 if (searchScopes.includes('dhikr-dua')) {
                     const allDhikrDua = await getAllData(STORE_DHIKR_DUA);
                     allDhikrDua.forEach(entry => {
                         if (entry.arabicText.toLowerCase().includes(searchTerm) || entry.translation.toLowerCase().includes(searchTerm) || (entry.notes && entry.notes.toLowerCase().includes(searchTerm))) {
                             results.push({
                                 type: 'Dhikr & Dua',
                                 ref: `Category: ${entry.category || 'N/A'}`,
                                 context: `${entry.arabicText} - ${entry.translation} ${entry.notes ? `- ${entry.notes}` : ''}`,
                                 source: 'Dhikr & Dua Builder'
                             });
                         }
                     });
                 }

                 // Search Hadith Notes
                 if (searchScopes.includes('hadith')) {
                     const allHadith = await getAllData(STORE_HADITH_LINKS);
                     allHadith.forEach(hadith => {
                         if (hadith.hadithText.toLowerCase().includes(searchTerm) || hadith.source.toLowerCase().includes(searchTerm) || (hadith.notes && hadith.notes.toLowerCase().includes(searchTerm))) {
                             results.push({
                                 type: 'Hadith',
                                 ref: `Source: ${hadith.source}`,
                                 context: `${hadith.hadithText} ${hadith.notes ? `- ${hadith.notes}` : ''}`,
                                 source: 'Hadith Linker'
                             });
                         }
                     });
                 }


                 if (results.length === 0) {
                     searchResultsList.innerHTML = '<li>No results found.</li>';
                     setStatusMessage('search-status', `No results found for "${searchTerm}".`, false);
                 } else {
                     setStatusMessage('search-status', `Found ${results.length} results for "${searchTerm}".`, false);
                      // Sort Quran/Hifz results by Surah/Ayah, others by type/ref
                     results.sort((a, b) => {
                         if (a.type === 'Quran' || a.type === 'Tafsir' || a.type === 'Hifz' || a.type === 'Theme Link') {
                             if (b.type === 'Quran' || b.type === 'Tafsir' || b.type === 'Hifz' || b.type === 'Theme Link') {
                                 if (a.surah !== b.surah) return a.surah - b.surah;
                                 if (a.ayah !== b.ayah) return a.ayah - b.ayah;
                             }
                         }
                         return a.type.localeCompare(b.type) || a.ref.localeCompare(b.ref);
                     });

                     results.forEach(result => {
                         const li = document.createElement('li');
                         li.innerHTML = `
                             <strong>${result.type}: ${result.ref}</strong> (${result.source})
                             <div class="result-context">${highlightMatch(result.context, searchTerm)}</div>
                             ${(result.type === 'Quran' || result.type === 'Tafsir' || result.type === 'Hifz' || result.type === 'Theme Link') ?
                                `<button data-surah="${result.surah}" data-ayah="${result.ayah}" class="go-to-ayah-btn" style="margin-top: 5px; padding: 3px 8px; font-size: 0.8rem;">Go to Ayah</button>` : ''}
                         `;
                         searchResultsList.appendChild(li);
                     });

                     // Add listeners for "Go to Ayah" buttons
                     searchResultsList.querySelectorAll('.go-to-ayah-btn').forEach(button => {
                         button.addEventListener('click', handleGoToAyahFromSearch);
                     });
                 }

             } catch (error) {
                 console.error("Error during search:", error);
                 setStatusMessage('search-status', 'Failed to perform search.', true);
                 searchResultsList.innerHTML = `<li>Error during search: ${error.message}</li>`;
             } finally {
                 hideLoading();
             }
        }


        function highlightMatch(text, searchTerm) {
            if (!text || !searchTerm) return text;
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        async function handleGoToAyahFromSearch(event) {
             const surah = parseInt(event.target.getAttribute('data-surah'), 10);
             const ayah = parseInt(event.target.getAttribute('data-ayah'), 10);
             if (!isNaN(surah) && !isNaN(ayah)) {
                 await goToAyah(surah, ayah);
             }
        }


        // --- Data Export/Import ---
        async function exportData() {
             if (!db) return;
             showLoading("Exporting data...");
             try {
                 const data = {};
                 const userStores = [
                     STORE_TAFSIR, STORE_THEMES, STORE_THEME_AYAHS,
                     STORE_ROOTS, STORE_ROOT_AYAHS, STORE_RECITATIONS,
                     STORE_HIFZ, STORE_BOOKMARKS, STORE_VOCABULARY,
                     STORE_CROSS_REFERENCES, STORE_DHIKR_DUA, STORE_HADITH_LINKS
                 ];
                 for (const storeName of userStores) {
                     data[storeName] = await getAllData(storeName);
                 }
                 const jsonString = JSON.stringify(data, null, 2);
                 const blob = new Blob([jsonString], { type: 'application/json' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = `nur-al-quran-studio-backup-${new Date().toISOString().split('T')[0]}.json`;
                 document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                 setStatusMessage('export-status', 'Data exported.', false);
             } catch (error) {
                 setStatusMessage('export-status', 'Export failed.', true);
             } finally {
                 hideLoading();
             }
        }

        async function importData(file) {
             if (!db || !file || !confirm("Importing will overwrite ALL existing personal data. Continue?")) return;
             showLoading("Importing data...");
             try {
                 const reader = new FileReader();
                 reader.onload = async (event) => {
                     try {
                         const data = JSON.parse(event.target.result);
                         const userStores = [
                            STORE_TAFSIR, STORE_THEMES, STORE_THEME_AYAHS,
                            STORE_ROOTS, STORE_ROOT_AYAHS, STORE_RECITATIONS,
                            STORE_HIFZ, STORE_BOOKMARKS, STORE_VOCABULARY,
                            STORE_CROSS_REFERENCES, STORE_DHIKR_DUA, STORE_HADITH_LINKS
                         ];

                         for (const storeName of userStores) {
                             if (data[storeName] && !Array.isArray(data[storeName])) throw new Error(`Invalid data for ${storeName}`);
                         }

                         const transaction = db.transaction(userStores, 'readwrite');
                         transaction.oncomplete = async () => {
                             setStatusMessage('import-status', 'Data imported.', false);
                             await loadAyah(currentSurah, currentAyah); // Refresh UI
                             showSection(document.querySelector('.nav-link.active').dataset.section || 'quran'); // Reload current active section
                             hideLoading();
                         };
                         transaction.onerror = (e) => {
                             console.error("Import transaction failed:", e.target.error);
                             setStatusMessage('import-status', `Import transaction failed: ${e.target.error.message}`, true);
                             hideLoading();
                         };

                         for (const storeName of userStores) {
                             const store = transaction.objectStore(storeName);
                             store.clear(); // Clear existing data

                             if (data[storeName]) {
                                data[storeName].forEach(item => {
                                    // For auto-increment stores, remove old ID if present to let DB assign new ID.
                                    // This assumes IDs are not critical for cross-referencing *between* stores.
                                    // If IDs are critical for internal links (e.g., themeId in theme_ayahs),
                                    // this simple import might break them. A more robust import would remap IDs.
                                    // For now, assuming IDs are fine if imported from same app.
                                    if ([STORE_THEMES, STORE_THEME_AYAHS, STORE_ROOTS, STORE_ROOT_AYAHS, STORE_RECITATIONS,
                                         STORE_VOCABULARY, STORE_CROSS_REFERENCES, STORE_DHIKR_DUA, STORE_HADITH_LINKS].includes(storeName)) {
                                        // If the store uses autoIncrement, we should add, not put, if we want new IDs.
                                        // However, if the goal is to preserve IDs for linked data, 'put' is necessary.
                                        // Given the requirement for "backup and restore is must", 'put' is generally safer
                                        // to preserve existing IDs, assuming no ID conflicts occur.
                                        // For simplicity and to preserve existing links by ID, we use put.
                                        store.put(item).catch(e => console.warn(`Could not put item to ${storeName} during import: `, item, e));
                                    } else {
                                        store.put(item).catch(e => console.warn(`Could not put item to ${storeName} during import: `, item, e));
                                    }
                                });
                             }
                         }
                     } catch (parseError) {
                         console.error("Import file parsing error:", parseError);
                         setStatusMessage('import-status', `Invalid import file format: ${parseError.message}`, true);
                         hideLoading();
                     }
                 };
                 reader.onerror = (e) => {
                     console.error("File reader error:", e);
                     setStatusMessage('import-status', 'Failed to read file.', true);
                     hideLoading();
                 };
                 reader.readAsText(file);
             } catch (error) {
                 console.error("Import initiation failed:", error);
                 setStatusMessage('import-status', 'Import initiation failed.', true);
                 hideLoading();
             }
        }

         async function clearAllPersonalData() {
             if (!db || !confirm("DELETE ALL personal data? This cannot be undone.")) return;
             showLoading("Clearing all personal data...");
             try {
                 const userStores = [
                    STORE_TAFSIR, STORE_THEMES, STORE_THEME_AYAHS,
                    STORE_ROOTS, STORE_ROOT_AYAHS, STORE_RECITATIONS,
                    STORE_HIFZ, STORE_BOOKMARKS, STORE_VOCABULARY,
                    STORE_CROSS_REFERENCES, STORE_DHIKR_DUA, STORE_HADITH_LINKS
                 ];
                 const transaction = db.transaction(userStores, 'readwrite');
                 transaction.oncomplete = () => {
                     setStatusMessage('clear-status', 'All personal data cleared.', false);
                     // Reset UI elements
                     document.getElementById('tafsir-notes').value = '';
                     document.getElementById('themes-list').innerHTML = '<li>No themes added yet.</li>';
                     document.getElementById('root-occurrences-list').innerHTML = '<li>Enter a root word and click "Analyze Root".</li>';
                     document.getElementById('recitations-list').innerHTML = '<li>No entries logged yet.</li>';
                     document.getElementById('hifz-ayahs-list').innerHTML = '<p class="text-center">Select a Surah to track Hifz progress.</p>';
                     document.getElementById('vocabulary-list').innerHTML = '<li>No words added yet.</li>';
                     document.getElementById('cross-ref-list').innerHTML = '<li>No cross-references added yet.</li>';
                     document.getElementById('dhikr-dua-list').innerHTML = '<li>No Dhikr/Duas added yet.</li>';
                     document.getElementById('hadith-list').innerHTML = '<li>No Hadith entries added yet.</li>';
                     document.getElementById('bookmarks-list').innerHTML = '<li>No bookmarks added yet.</li>';

                     populateThemeSelects();
                     loadAyah(currentSurah, currentAyah); // Refresh current Ayah status
                     updateDashboard();
                     hideLoading();
                 };
                 transaction.onerror = (e) => {
                     console.error("Clear data transaction failed:", e.target.error);
                     setStatusMessage('clear-status', `Failed to clear data: ${e.target.error.message}`, true);
                     hideLoading();
                 };
                 userStores.forEach(storeName => transaction.objectStore(storeName).clear());
             } catch (error) {
                 console.error("Clear all data failed:", error);
                 setStatusMessage('clear-status', 'Data clear initiation failed.', true);
                 hideLoading();
             }
         }

        // --- Tafsir Export to DOCX Functions (provided in original, kept as is) ---
        async function loadDocxJs() {
            return new Promise((resolve, reject) => {
                if (window.docx) {
                    console.log("docx.js already loaded.");
                    resolve(window.docx);
                    return;
                }
                console.log("Loading docx.js library...");
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/docx@9.5.0/build/index.iife.min.js'; // Using build version as it's typically smaller/more stable
                script.onload = () => {
                    console.log("docx.js loaded successfully.");
                    resolve(window.docx);
                };
                script.onerror = (err) => {
                    console.error("Failed to load docx.js library:", err);
                    reject("Failed to load DOCX library. Please check your internet connection.");
                };
                document.head.appendChild(script);
            });
        }


        async function exportTafsirToDocx() {
            setStatusMessage('export-tafsir-docx-status', 'Initializing DOCX export...', false);
            showLoading("Preparing Tafsir for DOCX export...");

            let docx;
            try {
                docx = await loadDocxJs();
                if (!docx || !docx.Document || !docx.Packer || !docx.Paragraph || !docx.TextRun || !docx.HeadingLevel) {
                    throw new Error("DOCX library not loaded correctly or is an incompatible version.");
                }
            } catch (error) {
                console.error("Error loading DOCX library:", error);
                setStatusMessage('export-tafsir-docx-status', typeof error === 'string' ? error : 'Failed to load DOCX library.', true);
                hideLoading();
                return;
            }

            if (!db) {
                setStatusMessage('export-tafsir-docx-status', 'Database not ready.', true);
                hideLoading();
                return;
            }

            try {
                const allTafsirEntries = await getAllData(STORE_TAFSIR);
                if (!allTafsirEntries || allTafsirEntries.length === 0) {
                    setStatusMessage('export-tafsir-docx-status', 'No Tafsir notes found to export.', false);
                    hideLoading();
                    return;
                }

                allTafsirEntries.sort((a, b) => {
                    if (a.surah !== b.surah) return a.surah - b.surah;
                    return a.ayah - b.ayah;
                });

                const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, ShadingType, convertInchesToTwip } = docx;

                const children = [];

                // Document Title
                children.push(
                    new Paragraph({
                        text: "My Personal Quran Tafsir",
                        heading: HeadingLevel.TITLE,
                        alignment: AlignmentType.CENTER,
                    })
                );
                children.push(new Paragraph(" ")); // Spacer

                let currentProcessingSurah = -1;

                for (const tafsirEntry of allTafsirEntries) {
                    if (tafsirEntry.surah !== currentProcessingSurah) {
                        currentProcessingSurah = tafsirEntry.surah;
                        const surahNameStr = surahNames[currentProcessingSurah - 1] || `Surah ${currentProcessingSurah}`;

                        // Surah Title
                        children.push(
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: `Surah ${currentProcessingSurah}: ${surahNameStr}`,
                                        bold: true,
                                        size: 32, // 16pt font size (2 * 16)
                                        color: "2E74B5", // A blue color
                                    }),
                                ],
                                heading: HeadingLevel.HEADING_1,
                                spacing: { before: convertInchesToTwip(0.2), after: convertInchesToTwip(0.1) },
                            })
                        );
                    }

                    // Fetch Arabic text for the Ayah
                    const quranAyahData = await getData(STORE_QURAN, [tafsirEntry.surah, tafsirEntry.ayah]);
                    const arabicText = quranAyahData ? quranAyahData.arabic : "Arabic text not found.";

                    // Ayah Reference
                    children.push(
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: `Ayah ${tafsirEntry.ayah}`,
                                    bold: true,
                                    size: 28, // 14pt
                                    color: "1F4E79", // Darker blue
                                }),
                            ],
                            spacing: { before: convertInchesToTwip(0.15), after: convertInchesToTwip(0.05) },
                        })
                    );

                    // Arabic Text Paragraph
                    children.push(
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: arabicText,
                                    font: "Scheherazade New", // Specify an Arabic font
                                    size: 36, // 18pt
                                    rightToLeft: true, // Crucial for Arabic
                                }),
                            ],
                            alignment: AlignmentType.RIGHT,
                            bidirectional: true, // Important for mixed LTR/RTL content handling in Word
                            shading: { // Basic background color
                                type: ShadingType.SOLID,
                                color: "E8F5E9", // Light green (hex without #)
                                fill: "E8F5E9",
                            },
                            spacing: { after: convertInchesToTwip(0.1) },
                        })
                    );

                    // Tafsir Notes Paragraph
                    const notesLines = tafsirEntry.notes.split('\n');
                    notesLines.forEach((line, index) => {
                        children.push(
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: line,
                                        size: 24, // 12pt
                                    }),
                                ],
                                indentation: { left: convertInchesToTwip(0.25) }, // Indent Tafsir notes
                                spacing: { after: (index === notesLines.length - 1) ? convertInchesToTwip(0.15) : convertInchesToTwip(0.02) },
                            })
                        );
                    });
                     children.push(new Paragraph(" ")); // Spacer after each tafsir entry
                }

                const doc = new Document({
                    sections: [{
                        properties: {
                            page: {
                                margin: {
                                    top: convertInchesToTwip(0.75),
                                    right: convertInchesToTwip(0.75),
                                    bottom: convertInchesToTwip(0.75),
                                    left: convertInchesToTwip(0.75),
                                },
                            },
                        },
                        children: children,
                    }],
                    styles: {
                        default: {
                            document: {
                                run: {
                                    font: "Calibri",
                                    size: 22,
                                },
                                paragraph: {
                                    spacing: { line: 276 }
                                }
                            },
                        },
                        paragraphStyles: [
                            {
                                id: "arabicStyle",
                                name: "Arabic Text",
                                basedOn: "Normal",
                                next: "Normal",
                                run: {
                                    font: "Scheherazade New",
                                    size: 36,
                                    rightToLeft: true,
                                },
                                paragraph: {
                                    alignment: AlignmentType.RIGHT,
                                    bidirectional: true,
                                }
                            }
                        ]
                    }
                });

                Packer.toBlob(doc).then(blob => {
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `Personal-Tafsir-${new Date().toISOString().split('T')[0]}.docx`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    setStatusMessage('export-tafsir-docx-status', 'Tafsir DOCX file generated.', false);
                }).catch(packError => {
                    console.error("Error packing DOCX:", packError);
                    setStatusMessage('export-tafsir-docx-status', 'Failed to generate DOCX file.', true);
                });

            } catch (error) {
                console.error("Error exporting Tafsir to DOCX:", error);
                setStatusMessage('export-tafsir-docx-status', 'Failed to export Tafsir to DOCX.', true);
            } finally {
                hideLoading();
            }
        }


        // --- Settings Functions ---
        function applyTheme(themeName) {
            document.body.className = '';
            if (themeName !== 'serene') document.body.classList.add(`theme-${themeName}`);
            if (db) putData(STORE_SETTINGS, { name: 'theme', value: themeName }).catch(console.error);
        }
        async function loadThemePreference() {
             if (!db) return;
             try {
                 const settings = await getData(STORE_SETTINGS, 'theme');
                 const theme = settings ? settings.value : 'serene';
                 document.getElementById('theme-switcher').value = theme;
                 document.getElementById('theme-switcher-settings').value = theme;
                 applyTheme(theme);
             } catch (error) { // Fallback to default
                 document.getElementById('theme-switcher').value = 'serene';
                 document.getElementById('theme-switcher-settings').value = 'serene';
                 applyTheme('serene');
             }
        }

        function applyFontSizes() {
            const arabicSize = document.getElementById('arabic-font-size').value;
            const translationSize = document.getElementById('translation-font-size').value;
            const generalSize = document.getElementById('general-font-size').value;

            document.documentElement.style.setProperty('--font-size-arabic', `${arabicSize}rem`);
            document.documentElement.style.setProperty('--font-size-translation', `${translationSize}rem`);
            document.documentElement.style.setProperty('--font-size-general', `${generalSize}rem`);

            document.getElementById('arabic-font-size-value').textContent = `${arabicSize}rem`;
            document.getElementById('translation-font-size-value').textContent = `${translationSize}rem`;
            document.getElementById('general-font-size-value').textContent = `${generalSize}rem`;

            if (db) {
                putData(STORE_SETTINGS, { name: 'fontSizeArabic', value: arabicSize }).catch(console.error);
                putData(STORE_SETTINGS, { name: 'fontSizeTranslation', value: translationSize }).catch(console.error);
                putData(STORE_SETTINGS, { name: 'fontSizeGeneral', value: generalSize }).catch(console.error);
            }
        }

        async function loadFontSizes() {
            if (!db) return;
            try {
                const arabic = await getData(STORE_SETTINGS, 'fontSizeArabic');
                const translation = await getData(STORE_SETTINGS, 'fontSizeTranslation');
                const general = await getData(STORE_SETTINGS, 'fontSizeGeneral');

                document.getElementById('arabic-font-size').value = arabic ? arabic.value : '1.8';
                document.getElementById('translation-font-size').value = translation ? translation.value : '1.1';
                document.getElementById('general-font-size').value = general ? general.value : '1.0';

                applyFontSizes(); // Apply loaded values
            } catch (error) {
                console.error("Error loading font sizes:", error);
                // Fallback to default values in HTML
                applyFontSizes();
            }
        }

        // --- Sample Data Injection (for new features) ---
        async function addSampleDataIfNeeded() {
    console.log("Checking for sample data...");
    try {
        const settingsLoadedSample = await getData(STORE_SETTINGS, 'sampleDataLoaded').catch(() => null);
        if (settingsLoadedSample && settingsLoadedSample.value === true && settingsLoadedSample.version === DB_VERSION) {
            console.log("Sample data already loaded for current DB version.");
            return;
        }

        console.log("Adding sample data...");

        // Define all stores involved in the sample data transaction
        const sampleDataStores = [
            STORE_TAFSIR, STORE_THEMES, STORE_THEME_AYAHS, STORE_ROOTS,
            STORE_RECITATIONS, STORE_HIFZ, STORE_BOOKMARKS, STORE_VOCABULARY,
            STORE_CROSS_REFERENCES, STORE_DHIKR_DUA, STORE_HADITH_LINKS, STORE_SETTINGS
        ];

        // Create a single transaction for all sample data operations
        const transaction = db.transaction(sampleDataStores, 'readwrite');

        // Get object store references from this *single* transaction
        const tafsirStore = transaction.objectStore(STORE_TAFSIR);
        const themesStore = transaction.objectStore(STORE_THEMES);
        const themeAyahsStore = transaction.objectStore(STORE_THEME_AYAHS);
        const rootsStore = transaction.objectStore(STORE_ROOTS);
        const recitationStore = transaction.objectStore(STORE_RECITATIONS);
        const hifzStore = transaction.objectStore(STORE_HIFZ);
        const bookmarksStore = transaction.objectStore(STORE_BOOKMARKS);
        const vocabularyStore = transaction.objectStore(STORE_VOCABULARY);
        const crossRefStore = transaction.objectStore(STORE_CROSS_REFERENCES);
        const dhikrDuaStore = transaction.objectStore(STORE_DHIKR_DUA);
        const hadithLinkStore = transaction.objectStore(STORE_HADITH_LINKS);
        const settingsStore = transaction.objectStore(STORE_SETTINGS); // Get settings store from this transaction

        // Store generated IDs to link related data correctly
        let theme1Id, theme2Id, theme3Id, theme4Id;

        // Perform all add/put operations within this transaction
        // Using Promise.all to wait for batches of operations to complete within the transaction.
        // This is important because IndexedDB operations return requests immediately,
        // but the transaction might close if the event loop gets a chance before all operations are initiated.

        // Tafsir
        await Promise.all([
            tafsirStore.put({ surah: 2, ayah: 255, notes: "This is the Ayah of Kursi. A powerful Ayah describing Allah's immense power and knowledge. It's often recited for protection. My personal reflection: Focus on 'ولا يؤده حفظهما', meaning 'nor does He tire of guarding them', emphasizing ease for Him.", dateModified: new Date().toISOString() }),
            tafsirStore.put({ surah: 1, ayah: 1, notes: "Alhamdulillah. Beginning with the Name of Allah, the Most Gracious, the Most Merciful. This verse teaches us to start all our affairs with Allah's name.", dateModified: new Date().toISOString() })
        ]);

        // Themes - need to capture the auto-generated IDs, so process individually
        theme1Id = await new Promise((resolve, reject) => {
            const req = themesStore.add({ name: "Allah's Attributes", parentId: null, description: "Verses related to Allah's Names and Attributes.", dateCreated: new Date().toISOString() });
            req.onsuccess = () => resolve(req.result);
            req.onerror = reject;
        });
        theme2Id = await new Promise((resolve, reject) => {
            const req = themesStore.add({ name: "Guidance and Piety", parentId: null, description: "Ayahs discussing guidance, righteousness, and fear of Allah.", dateCreated: new Date().toISOString() });
            req.onsuccess = () => resolve(req.result);
            req.onerror = reject;
        });
        theme3Id = await new Promise((resolve, reject) => {
            const req = themesStore.add({ name: "Prophethood", parentId: null, description: "Ayahs about Prophets and Messengers.", dateCreated: new Date().toISOString() });
            req.onsuccess = () => resolve(req.result);
            req.onerror = reject;
        });
        theme4Id = await new Promise((resolve, reject) => {
            const req = themesStore.add({ name: "Day of Judgment", parentId: null, description: "Verses describing Qiyamah, reckoning, Jannah and Jahannam.", dateCreated: new Date().toISOString() });
            req.onsuccess = () => resolve(req.result);
            req.onerror = reject;
        });

        // Theme Ayahs
        await Promise.all([
            themeAyahsStore.add({ themeId: theme1Id, surah: 2, ayah: 255, notes: "Discusses Allah's greatness and eternal life.", dateLinked: new Date().toISOString() }),
            themeAyahsStore.add({ themeId: theme1Id, surah: 59, ayah: 23, notes: "Mentions several Divine Names.", dateLinked: new Date().toISOString() }),
            themeAyahsStore.add({ themeId: theme2Id, surah: 2, ayah: 2, notes: "Quran as guidance for the righteous.", dateLinked: new Date().toISOString() }),
            themeAyahsStore.add({ themeId: theme2Id, surah: 3, ayah: 102, notes: "Advice on maintaining piety.", dateLinked: new Date().toISOString() })
        ]);

        // Roots
        await Promise.all([
            rootsStore.add({ root: "ع ل م", description: "Root for knowledge, knowing, learning. Often used for Allah's infinite knowledge.", dateCreated: new Date().toISOString() }),
            rootsStore.add({ root: "ك ف ر", description: "Root for disbelief, covering truth, ingratitude.", dateCreated: new Date().toISOString() })
        ]);

        // Recitations
        await Promise.all([
            recitationStore.add({ surah: 1, ayahStart: 1, ayahEnd: 7, qari: "Mishary Alafasy", date: "2023-10-26", notes: "Beautiful recitation, very moving.", dateAdded: new Date().toISOString() }),
            recitationStore.add({ surah: 18, ayahStart: 1, ayahEnd: 10, qari: "Abdul Basit Abdus Samad", date: "2023-10-20", notes: "Classic, powerful voice. Focused on makharij.", dateAdded: new Date().toISOString() })
        ]);

        // Hifz
        await Promise.all([
            hifzStore.put({ surah: 1, ayah: 1, status: 'memorized', lastReviewDate: "2023-10-25", nextReviewDate: calculateNextReview("2023-10-25", 1), reviewCount: 1, notes: "Needs constant review.", dateModified: new Date().toISOString() }),
            hifzStore.put({ surah: 1, ayah: 2, status: 'in-progress', lastReviewDate: null, nextReviewDate: null, reviewCount: 0, notes: "", dateModified: new Date().toISOString() }),
            hifzStore.put({ surah: 112, ayah: 1, status: 'memorized', lastReviewDate: "2023-10-20", nextReviewDate: calculateNextReview("2023-10-20", 5), reviewCount: 5, notes: "Solid, but quick revision helps.", dateModified: new Date().toISOString() })
        ]);

        // Bookmarks
        await Promise.all([
            bookmarksStore.put({ surah: 1, ayah: 1, dateAdded: new Date().toISOString() }),
            bookmarksStore.put({ surah: 114, ayah: 6, dateAdded: new Date().toISOString() })
        ]);

        // Vocabulary
        await Promise.all([
            vocabularyStore.add({ arabicWord: "صراط", customMeaning: "The Path / The Way", notes: "Often refers to the Straight Path of Islam.", dateAdded: new Date().toISOString(), linkedAyah: { surah: 1, ayah: 6 } }),
            vocabularyStore.add({ arabicWord: "هدى", customMeaning: "Guidance", notes: "From the root ه-د-ى.", dateAdded: new Date().toISOString(), linkedAyah: { surah: 2, ayah: 2 } })
        ]);

        // Cross References
        await Promise.all([
            crossRefStore.add({ fromSurah: 2, fromAyah: 255, toSurah: 2, toAyah: 286, notes: "Both highlight Allah's power and mercy.", dateLinked: new Date().toISOString() }),
            crossRefStore.add({ fromSurah: 112, fromAyah: 1, toSurah: 6, toAyah: 102, notes: "Tawhid - Oneness of Allah.", dateLinked: new Date().toISOString() })
        ]);

        // Dhikr & Dua
        await Promise.all([
            dhikrDuaStore.add({ arabicText: "سبحان الله وبحمده", translation: "Glorified is Allah and praised is He.", notes: "Daily Dhikr.", category: "Morning/Evening", count: 10, dateAdded: new Date().toISOString() }),
            dhikrDuaStore.add({ arabicText: "اللهم إني أسألك الهدى والتقى والعفاف والغنى", translation: "O Allah, I ask You for guidance, piety, abstinence, and contentment.", notes: "Comprehensive Dua.", category: "General", count: 0, dateAdded: new Date().toISOString() })
        ]);

        // Hadith Links
        await Promise.all([
            hadithLinkStore.add({ hadithText: "إنما الأعمال بالنيات", source: "Sahih Bukhari 1", notes: "Actions are by intentions. Very fundamental principle.", linkedSurah: 1, linkedAyah: 1, dateAdded: new Date().toISOString() }),
            hadithLinkStore.add({ hadithText: "من يرد الله به خيرا يفقهه في الدين", source: "Sahih Bukhari 71", notes: "Whoever Allah wants good for, He gives him understanding in religion.", linkedSurah: 2, linkedAyah: 269, dateAdded: new Date().toISOString() })
        ]);

        // Mark sample data as loaded *within this transaction*
        await settingsStore.put({ name: 'sampleDataLoaded', value: true, version: DB_VERSION });

        // Wait for the entire transaction to complete before returning
        await new Promise((resolve, reject) => {
            transaction.oncomplete = () => {
                console.log("Sample data addition transaction completed successfully.");
                resolve();
            };
            transaction.onerror = (e) => {
                console.error("Transaction failed during sample data addition:", e.target.error);
                reject(e.target.error);
            };
        });

    } catch (error) {
        console.error("Failed to add sample data:", error);
        throw error; // Re-throw to propagate to the main initialization catch block
    }
}

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            document.getElementById('surah-select').addEventListener('change', (event) => {
                currentSurah = parseInt(event.target.value, 10);
                updateAyahSelect(currentSurah);
                loadAyah(currentSurah, currentAyah);
            });
            document.getElementById('ayah-select').addEventListener('change', (event) => {
                currentAyah = parseInt(event.target.value, 10);
                loadAyah(currentSurah, currentAyah);
            });
            document.getElementById('translation-select').addEventListener('change', () => loadAyah(currentSurah, currentAyah));
            document.getElementById('quick-navigate-btn').addEventListener('click', handleQuickNavigate);
            document.getElementById('random-ayah-btn').addEventListener('click', handleRandomAyah);
            document.getElementById('quick-navigate-input').addEventListener('keypress', (event) => {
                if (event.key === 'Enter') handleQuickNavigate();
            });


            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    showSection(event.target.getAttribute('data-section'));
                });
            });

            document.getElementById('save-tafsir-btn').addEventListener('click', saveTafsir);
            document.getElementById('add-theme-btn').addEventListener('click', addTheme);
            document.getElementById('link-ayah-to-theme-btn').addEventListener('click', linkAyahToTheme);
            document.getElementById('link-theme-select').addEventListener('change', displayLinkedAyahsForCurrentTheme);
            document.getElementById('analyze-root-btn').addEventListener('click', analyzeRoot);
            document.getElementById('save-root-notes-btn').addEventListener('click', saveRootNotes);

            document.getElementById('add-vocabulary-btn').addEventListener('click', addVocabulary);
            document.getElementById('filter-vocabulary-input').addEventListener('input', (e) => loadVocabularyWords(e.target.value));

            document.getElementById('add-cross-ref-btn').addEventListener('click', addCrossReference);
            // No filter for cross-refs yet, can add if needed later
            // document.getElementById('filter-cross-ref-input').addEventListener('input', (e) => loadCrossReferences(e.target.value));


            document.getElementById('save-recitation-btn').addEventListener('click', saveRecitationLog);
            document.getElementById('rec-surah-select').addEventListener('change', (event) => {
                 const surah = parseInt(event.target.value, 10);
                 const totalAyahs = surahAyahCounts[surah];
                 document.getElementById('rec-ayah-start').max = totalAyahs;
                 document.getElementById('rec-ayah-end').max = totalAyahs;
            });
            document.getElementById('hifz-surah-select').addEventListener('change', (event) => {
                 selectedHifzSurah = parseInt(event.target.value, 10);
                 loadHifzForSurah(selectedHifzSurah);
            });

            document.getElementById('add-dhikr-dua-btn').addEventListener('click', addDhikrDua);
            document.getElementById('filter-dhikr-dua-input').addEventListener('input', (e) => loadDhikrDuas(e.target.value));

            document.getElementById('add-hadith-btn').addEventListener('click', addHadithLink);
            document.getElementById('filter-hadith-input').addEventListener('input', (e) => loadHadithLinks(e.target.value));

            document.getElementById('filter-bookmarks-input').addEventListener('input', (e) => loadBookmarks(e.target.value));


            document.getElementById('perform-search-btn').addEventListener('click', performSearch);
            document.getElementById('search-input').addEventListener('keypress', (event) => {
                if (event.key === 'Enter') performSearch();
            });


            document.getElementById('export-data-btn').addEventListener('click', exportData);
            document.getElementById('import-file').addEventListener('change', (event) => {
                 document.getElementById('import-data-btn').disabled = !event.target.files[0];
            });
            document.getElementById('import-data-btn').addEventListener('click', () => {
                 const fileInput = document.getElementById('import-file');
                 if (fileInput.files.length > 0) importData(fileInput.files[0]);
                 else setStatusMessage('import-status', 'Select file to import.', true);
            });
            document.getElementById('clear-data-btn').addEventListener('click', clearAllPersonalData);

            document.getElementById('export-tafsir-to-docx-btn').addEventListener('click', exportTafsirToDocx);

            document.getElementById('theme-switcher').addEventListener('change', (event) => applyTheme(event.target.value));
            document.getElementById('theme-switcher-settings').addEventListener('change', (event) => applyTheme(event.target.value));

            document.getElementById('arabic-font-size').addEventListener('input', applyFontSizes);
            document.getElementById('translation-font-size').addEventListener('input', applyFontSizes);
            document.getElementById('general-font-size').addEventListener('input', applyFontSizes);


            document.querySelectorAll('.modal .close-button').forEach(button => {
                button.addEventListener('click', (event) => event.target.closest('.modal').style.display = 'none');
            });
            window.addEventListener('click', (event) => {
                 document.querySelectorAll('.modal').forEach(modal => { if (event.target === modal) modal.style.display = 'none'; });
            });
            window.addEventListener('keydown', (event) => { // Close modals with Escape key
                if (event.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
                }
            });
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDB();
                await loadThemePreference();
                await loadFontSizes();
                setupEventListeners(); // Setup listeners after DB is open
                await loadInitialQuranData(); // This populates selects and loads initial ayah
                await addSampleDataIfNeeded(); // Add sample data for new features only if not already there
                showSection('dashboard'); // Start on dashboard
            } catch (error) {
                console.error("App initialization failed:", error);
                hideLoading();
                alert("Failed to initialize: " + error.message + "\nPlease clear website data and refresh. Check console for details.");
            }
        });
    </script>
</body>
</html>